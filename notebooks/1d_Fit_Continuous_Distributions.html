
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Fit Continuous Distributions &#8212; On the predictability of f-divergence measures from catchment attributes</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/1d_Fit_Continuous_Distributions';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Methods" href="2_Methods.html" />
    <link rel="prev" title="Process Target Variables" href="1c_Process_Target_Variables.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="On the predictability of f-divergence measures from catchment attributes - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="On the predictability of f-divergence measures from catchment attributes - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="1_data.html">Data</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="1a_Update_Catchment_Bounds.html">Update HYSETS Catchment Polygons</a></li>
<li class="toctree-l2"><a class="reference internal" href="1b_Update_Catchment_Attributes.html">Update HYSETS Catchment Attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="1c_Process_Target_Variables.html">Process Target Variables</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Fit Continuous Distributions</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="2_Methods.html">Methods</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="2a_Predictability_of_Mean_Runoff.html">Predict Mean Runoff</a></li>
<li class="toctree-l2"><a class="reference internal" href="2b_Predictability_of_entropy.html">Predict (Shannon) Entropy</a></li>
<li class="toctree-l2"><a class="reference internal" href="2c_Predictability_of_KL_divergence.html">Predict Kullback-Leibler (KL) Divergence</a></li>
<li class="toctree-l2"><a class="reference internal" href="2d_Predictability_of_TVD.html">Predict Total Variation Distance (TVD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="2e_Predictability_of_EMD.html">Predict Earth Mover’s Distance (EMD)</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="Discussion.html">Discussion</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/dankovacek/divergence_measures" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/dankovacek/divergence_measures/issues/new?title=Issue%20on%20page%20%2Fnotebooks/1d_Fit_Continuous_Distributions.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/1d_Fit_Continuous_Distributions.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Fit Continuous Distributions</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-underspecification-assuming-a-prior-on-q">Dealing with Underspecification: Assuming a Prior on Q</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-the-noise-added-to-a-discriminant-value-due-to-assuming-an-error-distribution-as-a-prior">Compute the “noise” added to a discriminant value due to assuming an error distribution as a prior</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pairwise-processing">Pairwise Processing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="fit-continuous-distributions">
<h1>Fit Continuous Distributions<a class="headerlink" href="#fit-continuous-distributions" title="Link to this heading">#</a></h1>
<p>For each streamflow timeseries:</p>
<ol class="arabic simple">
<li><p>Compute “sufficient statistics” of a chosen distribution, i.e. location and scale of log-normal distribution.</p></li>
<li><p>Use the parameters as a model Q in pairwise comparisons, these eliminate</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">entropy</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">data_processing_functions</span> <span class="k">as</span> <span class="nn">dpf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="c1"># visualize the catchment centroid locations</span>
<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span><span class="p">,</span> <span class="n">show</span>
<span class="kn">from</span> <span class="nn">bokeh.layouts</span> <span class="kn">import</span> <span class="n">gridplot</span>
<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">output_notebook</span>
<span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">ColumnDataSource</span><span class="p">,</span> <span class="n">LinearAxis</span><span class="p">,</span> <span class="n">Range1d</span>
<span class="kn">from</span> <span class="nn">bokeh.palettes</span> <span class="kn">import</span> <span class="n">Colorblind</span><span class="p">,</span> <span class="n">Sunset10</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">lognorm</span><span class="p">,</span> <span class="n">expon</span><span class="p">,</span> <span class="n">kappa4</span><span class="p">,</span> <span class="n">gaussian_kde</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">kl_div</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>

<span class="n">output_notebook</span><span class="p">()</span>

<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">    <style>
        .bk-notebook-logo {
            display: block;
            width: 20px;
            height: 20px;
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAOkSURBVDiNjZRtaJVlGMd/1/08zzln5zjP1LWcU9N0NkN8m2CYjpgQYQXqSs0I84OLIC0hkEKoPtiH3gmKoiJDU7QpLgoLjLIQCpEsNJ1vqUOdO7ppbuec5+V+rj4ctwzd8IIbbi6u+8f1539dt3A78eXC7QizUF7gyV1fD1Yqg4JWz84yffhm0qkFqBogB9rM8tZdtwVsPUhWhGcFJngGeWrPzHm5oaMmkfEg1usvLFyc8jLRqDOMru7AyC8saQr7GG7f5fvDeH7Ej8CM66nIF+8yngt6HWaKh7k49Soy9nXurCi1o3qUbS3zWfrYeQDTB/Qj6kX6Ybhw4B+bOYoLKCC9H3Nu/leUTZ1JdRWkkn2ldcCamzrcf47KKXdAJllSlxAOkRgyHsGC/zRday5Qld9DyoM4/q/rUoy/CXh3jzOu3bHUVZeU+DEn8FInkPBFlu3+nW3Nw0mk6vCDiWg8CeJaxEwuHS3+z5RgY+YBR6V1Z1nxSOfoaPa4LASWxxdNp+VWTk7+4vzaou8v8PN+xo+KY2xsw6une2frhw05CTYOmQvsEhjhWjn0bmXPjpE1+kplmmkP3suftwTubK9Vq22qKmrBhpY4jvd5afdRA3wGjFAgcnTK2s4hY0/GPNIb0nErGMCRxWOOX64Z8RAC4oCXdklmEvcL8o0BfkNK4lUg9HTl+oPlQxdNo3Mg4Nv175e/1LDGzZen30MEjRUtmXSfiTVu1kK8W4txyV6BMKlbgk3lMwYCiusNy9fVfvvwMxv8Ynl6vxoByANLTWplvuj/nF9m2+PDtt1eiHPBr1oIfhCChQMBw6Aw0UulqTKZdfVvfG7VcfIqLG9bcldL/+pdWTLxLUy8Qq38heUIjh4XlzZxzQm19lLFlr8vdQ97rjZVOLf8nclzckbcD4wxXMidpX30sFd37Fv/GtwwhzhxGVAprjbg0gCAEeIgwCZyTV2Z1REEW8O4py0wsjeloKoMr6iCY6dP92H6Vw/oTyICIthibxjm/DfN9lVz8IqtqKYLUXfoKVMVQVVJOElGjrnnUt9T9wbgp8AyYKaGlqingHZU/uG2NTZSVqwHQTWkx9hxjkpWDaCg6Ckj5qebgBVbT3V3NNXMSiWSDdGV3hrtzla7J+duwPOToIg42ChPQOQjspnSlp1V+Gjdged7+8UN5CRAV7a5EdFNwCjEaBR27b3W890TE7g24NAP/mMDXRWrGoFPQI9ls/MWO2dWFAar/xcOIImbbpA3zgAAAABJRU5ErkJggg==);
        }
    </style>
    <div>
        <a href="https://bokeh.org" target="_blank" class="bk-notebook-logo"></a>
        <span id="fb71ac2b-c07d-4ce8-b6ff-30319b664a53">Loading BokehJS ...</span>
    </div>
</div><script type="application/javascript">'use strict';
(function(root) {
  function now() {
    return new Date();
  }

  const force = true;

  if (typeof root._bokeh_onload_callbacks === "undefined" || force === true) {
    root._bokeh_onload_callbacks = [];
    root._bokeh_is_loading = undefined;
  }

const JS_MIME_TYPE = 'application/javascript';
  const HTML_MIME_TYPE = 'text/html';
  const EXEC_MIME_TYPE = 'application/vnd.bokehjs_exec.v0+json';
  const CLASS_NAME = 'output_bokeh rendered_html';

  /**
   * Render data to the DOM node
   */
  function render(props, node) {
    const script = document.createElement("script");
    node.appendChild(script);
  }

  /**
   * Handle when an output is cleared or removed
   */
  function handleClearOutput(event, handle) {
    function drop(id) {
      const view = Bokeh.index.get_by_id(id)
      if (view != null) {
        view.model.document.clear()
        Bokeh.index.delete(view)
      }
    }

    const cell = handle.cell;

    const id = cell.output_area._bokeh_element_id;
    const server_id = cell.output_area._bokeh_server_id;

    // Clean up Bokeh references
    if (id != null) {
      drop(id)
    }

    if (server_id !== undefined) {
      // Clean up Bokeh references
      const cmd_clean = "from bokeh.io.state import curstate; print(curstate().uuid_to_server['" + server_id + "'].get_sessions()[0].document.roots[0]._id)";
      cell.notebook.kernel.execute(cmd_clean, {
        iopub: {
          output: function(msg) {
            const id = msg.content.text.trim()
            drop(id)
          }
        }
      });
      // Destroy server and session
      const cmd_destroy = "import bokeh.io.notebook as ion; ion.destroy_server('" + server_id + "')";
      cell.notebook.kernel.execute(cmd_destroy);
    }
  }

  /**
   * Handle when a new output is added
   */
  function handleAddOutput(event, handle) {
    const output_area = handle.output_area;
    const output = handle.output;

    // limit handleAddOutput to display_data with EXEC_MIME_TYPE content only
    if ((output.output_type != "display_data") || (!Object.prototype.hasOwnProperty.call(output.data, EXEC_MIME_TYPE))) {
      return
    }

    const toinsert = output_area.element.find("." + CLASS_NAME.split(' ')[0]);

    if (output.metadata[EXEC_MIME_TYPE]["id"] !== undefined) {
      toinsert[toinsert.length - 1].firstChild.textContent = output.data[JS_MIME_TYPE];
      // store reference to embed id on output_area
      output_area._bokeh_element_id = output.metadata[EXEC_MIME_TYPE]["id"];
    }
    if (output.metadata[EXEC_MIME_TYPE]["server_id"] !== undefined) {
      const bk_div = document.createElement("div");
      bk_div.innerHTML = output.data[HTML_MIME_TYPE];
      const script_attrs = bk_div.children[0].attributes;
      for (let i = 0; i < script_attrs.length; i++) {
        toinsert[toinsert.length - 1].firstChild.setAttribute(script_attrs[i].name, script_attrs[i].value);
        toinsert[toinsert.length - 1].firstChild.textContent = bk_div.children[0].textContent
      }
      // store reference to server id on output_area
      output_area._bokeh_server_id = output.metadata[EXEC_MIME_TYPE]["server_id"];
    }
  }

  function register_renderer(events, OutputArea) {

    function append_mime(data, metadata, element) {
      // create a DOM node to render to
      const toinsert = this.create_output_subarea(
        metadata,
        CLASS_NAME,
        EXEC_MIME_TYPE
      );
      this.keyboard_manager.register_events(toinsert);
      // Render to node
      const props = {data: data, metadata: metadata[EXEC_MIME_TYPE]};
      render(props, toinsert[toinsert.length - 1]);
      element.append(toinsert);
      return toinsert
    }

    /* Handle when an output is cleared or removed */
    events.on('clear_output.CodeCell', handleClearOutput);
    events.on('delete.Cell', handleClearOutput);

    /* Handle when a new output is added */
    events.on('output_added.OutputArea', handleAddOutput);

    /**
     * Register the mime type and append_mime function with output_area
     */
    OutputArea.prototype.register_mime_type(EXEC_MIME_TYPE, append_mime, {
      /* Is output safe? */
      safe: true,
      /* Index of renderer in `output_area.display_order` */
      index: 0
    });
  }

  // register the mime type if in Jupyter Notebook environment and previously unregistered
  if (root.Jupyter !== undefined) {
    const events = require('base/js/events');
    const OutputArea = require('notebook/js/outputarea').OutputArea;

    if (OutputArea.prototype.mime_types().indexOf(EXEC_MIME_TYPE) == -1) {
      register_renderer(events, OutputArea);
    }
  }
  if (typeof (root._bokeh_timeout) === "undefined" || force === true) {
    root._bokeh_timeout = Date.now() + 5000;
    root._bokeh_failed_load = false;
  }

  const NB_LOAD_WARNING = {'data': {'text/html':
     "<div style='background-color: #fdd'>\n"+
     "<p>\n"+
     "BokehJS does not appear to have successfully loaded. If loading BokehJS from CDN, this \n"+
     "may be due to a slow or bad network connection. Possible fixes:\n"+
     "</p>\n"+
     "<ul>\n"+
     "<li>re-rerun `output_notebook()` to attempt to load from CDN again, or</li>\n"+
     "<li>use INLINE resources instead, as so:</li>\n"+
     "</ul>\n"+
     "<code>\n"+
     "from bokeh.resources import INLINE\n"+
     "output_notebook(resources=INLINE)\n"+
     "</code>\n"+
     "</div>"}};

  function display_loaded(error = null) {
    const el = document.getElementById("fb71ac2b-c07d-4ce8-b6ff-30319b664a53");
    if (el != null) {
      const html = (() => {
        if (typeof root.Bokeh === "undefined") {
          if (error == null) {
            return "BokehJS is loading ...";
          } else {
            return "BokehJS failed to load.";
          }
        } else {
          const prefix = `BokehJS ${root.Bokeh.version}`;
          if (error == null) {
            return `${prefix} successfully loaded.`;
          } else {
            return `${prefix} <b>encountered errors</b> while loading and may not function as expected.`;
          }
        }
      })();
      el.innerHTML = html;

      if (error != null) {
        const wrapper = document.createElement("div");
        wrapper.style.overflow = "auto";
        wrapper.style.height = "5em";
        wrapper.style.resize = "vertical";
        const content = document.createElement("div");
        content.style.fontFamily = "monospace";
        content.style.whiteSpace = "pre-wrap";
        content.style.backgroundColor = "rgb(255, 221, 221)";
        content.textContent = error.stack ?? error.toString();
        wrapper.append(content);
        el.append(wrapper);
      }
    } else if (Date.now() < root._bokeh_timeout) {
      setTimeout(() => display_loaded(error), 100);
    }
  }

  function run_callbacks() {
    try {
      root._bokeh_onload_callbacks.forEach(function(callback) {
        if (callback != null)
          callback();
      });
    } finally {
      delete root._bokeh_onload_callbacks
    }
    console.debug("Bokeh: all callbacks have finished");
  }

  function load_libs(css_urls, js_urls, callback) {
    if (css_urls == null) css_urls = [];
    if (js_urls == null) js_urls = [];

    root._bokeh_onload_callbacks.push(callback);
    if (root._bokeh_is_loading > 0) {
      console.debug("Bokeh: BokehJS is being loaded, scheduling callback at", now());
      return null;
    }
    if (js_urls == null || js_urls.length === 0) {
      run_callbacks();
      return null;
    }
    console.debug("Bokeh: BokehJS not loaded, scheduling load and callback at", now());
    root._bokeh_is_loading = css_urls.length + js_urls.length;

    function on_load() {
      root._bokeh_is_loading--;
      if (root._bokeh_is_loading === 0) {
        console.debug("Bokeh: all BokehJS libraries/stylesheets loaded");
        run_callbacks()
      }
    }

    function on_error(url) {
      console.error("failed to load " + url);
    }

    for (let i = 0; i < css_urls.length; i++) {
      const url = css_urls[i];
      const element = document.createElement("link");
      element.onload = on_load;
      element.onerror = on_error.bind(null, url);
      element.rel = "stylesheet";
      element.type = "text/css";
      element.href = url;
      console.debug("Bokeh: injecting link tag for BokehJS stylesheet: ", url);
      document.body.appendChild(element);
    }

    for (let i = 0; i < js_urls.length; i++) {
      const url = js_urls[i];
      const element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error.bind(null, url);
      element.async = false;
      element.src = url;
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
  };

  function inject_raw_css(css) {
    const element = document.createElement("style");
    element.appendChild(document.createTextNode(css));
    document.body.appendChild(element);
  }

  const js_urls = ["https://cdn.bokeh.org/bokeh/release/bokeh-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-gl-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-3.6.0.min.js"];
  const css_urls = [];

  const inline_js = [    function(Bokeh) {
      Bokeh.set_log_level("info");
    },
function(Bokeh) {
    }
  ];

  function run_inline_js() {
    if (root.Bokeh !== undefined || force === true) {
      try {
            for (let i = 0; i < inline_js.length; i++) {
      inline_js[i].call(root, root.Bokeh);
    }

      } catch (error) {display_loaded(error);throw error;
      }if (force === true) {
        display_loaded();
      }} else if (Date.now() < root._bokeh_timeout) {
      setTimeout(run_inline_js, 100);
    } else if (!root._bokeh_failed_load) {
      console.log("Bokeh: BokehJS failed to load within specified timeout.");
      root._bokeh_failed_load = true;
    } else if (force !== true) {
      const cell = $(document.getElementById("fb71ac2b-c07d-4ce8-b6ff-30319b664a53")).parents('.cell').data().cell;
      cell.output_area.append_execute_result(NB_LOAD_WARNING)
    }
  }

  if (root._bokeh_is_loading === 0) {
    console.debug("Bokeh: BokehJS loaded, going straight to plotting");
    run_inline_js();
  } else {
    load_libs(css_urls, js_urls, function() {
      console.debug("Bokeh: BokehJS plotting callback run at", now());
      run_inline_js();
    });
  }
}(window));</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import attributes </span>
<span class="n">attributes_filename</span> <span class="o">=</span> <span class="s1">&#39;BCUB_watershed_attributes_updated.csv&#39;</span>
<span class="n">attributes_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">attributes_filename</span><span class="p">)</span>
<span class="n">attr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">attributes_fpath</span><span class="p">)</span>
<span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="c1"># df.columns</span>
<span class="n">filtered_stns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_and_plot_lognormal</span><span class="p">(</span><span class="n">mu1</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">mu2</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">prior_pseudo_count</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.035</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates two log-normal distributions, quantizes them with 2^b symbols,</span>
<span class="sd">    applies a uniform pseudo-count prior to one, and plots the distributions</span>
<span class="sd">    with Bokeh (including the posterior as a dashed line).</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - mu1, sigma1: Parameters for the first log-normal distribution.</span>
<span class="sd">    - mu2, sigma2: Parameters for the second log-normal distribution.</span>
<span class="sd">    - b: Number of symbols = 2^b for quantization.</span>
<span class="sd">    - prior_pseudo_count: Uniform pseudo-count to apply to one distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the two log-normal distributions</span>
    <span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">5</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>  <span class="c1"># Values over which distributions are evaluated</span>
    <span class="n">dist1</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma1</span><span class="p">)</span>
    <span class="n">dist2</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu2</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma2</span><span class="p">)</span>

    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bins_midpoints</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Create the continuous log-normal distributions evaluated at the midpoints</span>
    <span class="n">dist1</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">bins_midpoints</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu1</span><span class="p">))</span>
    <span class="n">dist2</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">bins_midpoints</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu2</span><span class="p">))</span>

    <span class="n">dist3</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">bins_midpoints</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu1</span><span class="p">))</span>
    <span class="n">dist4</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">bins_midpoints</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu2</span><span class="p">))</span>

    <span class="c1"># Quantize the distributions</span>
    <span class="c1"># Normalize the distributions to form proper PDFs over the quantized bins</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">dist1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist1</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">dist2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist2</span><span class="p">)</span>

    <span class="c1"># Apply the uniform prior as pseudo-counts to the second distribution</span>
    <span class="n">prior_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">prior_pseudo_count</span><span class="p">)</span>
    <span class="n">posterior_counts</span> <span class="o">=</span> <span class="n">prior_counts</span> <span class="o">+</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist2</span><span class="p">)</span>  <span class="c1"># Bayesian update</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">posterior_counts</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">posterior_counts</span><span class="p">)</span>  <span class="c1"># Renormalize</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s1">&#39;P does not sum to 1&#39;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s1">&#39;Q does not sum to 1&#39;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s1">&#39;R does not sum to 1&#39;</span>

    <span class="n">kl_pq</span> <span class="o">=</span> <span class="n">kl_div</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
    <span class="n">kl_pr</span> <span class="o">=</span> <span class="n">kl_div</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>

    <span class="c1"># Prepare data for Bokeh plotting</span>
    <span class="n">source1</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">bins_midpoints</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">P</span><span class="p">))</span>
    <span class="n">source2</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">bins_midpoints</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">Q</span><span class="p">))</span>
    <span class="n">source2_posterior</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">bins_midpoints</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">R</span><span class="p">))</span>

    <span class="c1"># Create the Bokeh plot</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span>
               <span class="n">x_axis_label</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y_axis_label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$$\text</span><span class="si">{Pr}</span><span class="s1">(X)$$&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">350</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source1</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;P(x)=LN(x|</span><span class="si">{</span><span class="n">mu1</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">sigma1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source2</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Q(x)=LN(x|</span><span class="si">{</span><span class="n">mu2</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">sigma2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source2_posterior</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span>
           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;R(X) (Prior=</span><span class="si">{</span><span class="n">prior_pseudo_count</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Configure the legend and show the plot</span>
    <span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;top_right&quot;</span>
    <span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">click_policy</span> <span class="o">=</span> <span class="s2">&quot;hide&quot;</span>

    <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">kl_pq</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">kl_pr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="dealing-with-underspecification-assuming-a-prior-on-q">
<h2>Dealing with Underspecification: Assuming a Prior on Q<a class="headerlink" href="#dealing-with-underspecification-assuming-a-prior-on-q" title="Link to this heading">#</a></h2>
<p>The joint likelihod of observing the data given <span class="math notranslate nohighlight">\(Q\)</span> and the prior probability of <span class="math notranslate nohighlight">\(Q\)</span> is given by <span class="math notranslate nohighlight">\(\text{Pr}(\text{data}|Q)\cdot \text{Prior}(Q)\)</span>, and the normalized posterior is given by:</p>
<div class="math notranslate nohighlight">
\[\text{Pr}(Q|\text{data}) = \frac{\text{Pr}(\text{data}|Q) \cdot \text{Prior}(Q)}{\text{Pr}(\text{data})}\]</div>
<p>However this doesn’t address our (fairly common) problem where some <span class="math notranslate nohighlight">\(q_i = 0\)</span>.  Normal Bayesian updating still yields <span class="math notranslate nohighlight">\(q_i = 0\)</span> because the dot product will multiply by zero.</p>
<p>Let:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(Q = (q_1, q_2, \dots, q_k)\)</span> be a probability vector representing a discrete distribution over <span class="math notranslate nohighlight">\(k\)</span> categories (states).</p></li>
<li><p>The observed data consist of counts <span class="math notranslate nohighlight">\((n_1, n_2, \dots, n_k)\)</span> for each category</p></li>
<li><p>The prior distribution for <span class="math notranslate nohighlight">\(Q\)</span> is a Dirichlet distribution with parameters <span class="math notranslate nohighlight">\(\alpha = (\alpha_1, \alpha_2, \dots, \alpha_k)\)</span></p></li>
</ul>
<div class="math notranslate nohighlight">
\[Q|\text{data}\sim \text{Dirichlet}(\alpha_1 + n_1, \alpha_2 + n_2, \dots, \alpha_k + n_k)\]</div>
<p>Example:</p>
<p>The data: <span class="math notranslate nohighlight">\((n_1 = 10, n_2 = 3, n_3 = 0, n_4 = 2)\)</span></p>
<p>The prior: <span class="math notranslate nohighlight">\((\alpha_1 = 1, \alpha_2 = 1, \alpha_3 = 1, \alpha_4 = 1)\)</span></p>
<p>The posterior:</p>
<div class="math notranslate nohighlight">
\[\mathbb{E}[Q|data] = \left( \frac{\alpha_1 + n_1}{\sum_{j=1}^k(\alpha_j + n_j)}, \frac{\alpha_2 + n_2}{\sum_{j=1}^k(\alpha_j + n_j)}, \dots, \frac{\alpha_k + n_k}{\sum_{j=1}^k(\alpha_j + n_j)} \right)\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.35</span>
<span class="n">p1</span><span class="p">,</span> <span class="n">klpq1</span><span class="p">,</span> <span class="n">klpr1</span> <span class="o">=</span> <span class="n">generate_and_plot_lognormal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">sigma</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.035</span><span class="p">))</span>
<span class="n">p2</span><span class="p">,</span> <span class="n">klpq2</span><span class="p">,</span> <span class="n">klpr2</span> <span class="o">=</span> <span class="n">generate_and_plot_lognormal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">sigma</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">)</span>
<span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">p1</span><span class="p">),</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>

<span class="n">kl1_text</span> <span class="o">=</span> <span class="s2">&quot;    --&gt;Q is closer to P than R&quot;</span>
<span class="k">if</span> <span class="n">klpr1</span> <span class="o">&lt;</span> <span class="n">klpq1</span><span class="p">:</span>
    <span class="n">kl1_text</span> <span class="o">=</span> <span class="s2">&quot;    --&gt;R is closer to P than Q&quot;</span>
<span class="n">kl2_text</span> <span class="o">=</span> <span class="s2">&quot;    --&gt;Q is closer to P than R&quot;</span>
<span class="k">if</span> <span class="n">klpr2</span> <span class="o">&lt;</span> <span class="n">klpq2</span><span class="p">:</span>
    <span class="n">kl2_text</span> <span class="o">=</span> <span class="s2">&quot;    --&gt;R is closer to P than Q&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DKL_1(P||Q) = </span><span class="si">{</span><span class="n">klpq1</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, DKL(P||R) = </span><span class="si">{</span><span class="n">klpr1</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kl1_text</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DKL_2(P||Q) = </span><span class="si">{</span><span class="n">klpq2</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, DKL(P||R) = </span><span class="si">{</span><span class="n">klpr2</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kl2_text</span><span class="p">)</span>
<span class="n">layout</span> <span class="o">=</span> <span class="n">gridplot</span><span class="p">([</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">],</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">350</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DKL_1(P||Q) = 0.14, DKL(P||R) = 0.10
    --&gt;R is closer to P than Q
DKL_2(P||Q) = 0.05, DKL(P||R) = 0.12
    --&gt;Q is closer to P than R
</pre></div>
</div>
<div class="output text_html">
  <div id="ed5202c5-26d7-4272-a9d9-37b2b24180ac" data-root-id="p1160" style="display: contents;"></div>
</div><script type="application/javascript">(function(root) {
  function embed_document(root) {
  const docs_json = {"192243d2-9fbc-4239-ae03-ddd6f7ad1f31":{"version":"3.6.0","title":"Bokeh Application","roots":[{"type":"object","name":"GridPlot","id":"p1160","attributes":{"rows":null,"cols":null,"toolbar":{"type":"object","name":"Toolbar","id":"p1159","attributes":{"tools":[{"type":"object","name":"ToolProxy","id":"p1153","attributes":{"tools":[{"type":"object","name":"PanTool","id":"p1033"},{"type":"object","name":"PanTool","id":"p1109"}]}},{"type":"object","name":"ToolProxy","id":"p1154","attributes":{"tools":[{"type":"object","name":"WheelZoomTool","id":"p1034","attributes":{"renderers":"auto"}},{"type":"object","name":"WheelZoomTool","id":"p1110","attributes":{"renderers":"auto"}}]}},{"type":"object","name":"ToolProxy","id":"p1155","attributes":{"tools":[{"type":"object","name":"BoxZoomTool","id":"p1035","attributes":{"overlay":{"type":"object","name":"BoxAnnotation","id":"p1036","attributes":{"syncable":false,"line_color":"black","line_alpha":1.0,"line_width":2,"line_dash":[4,4],"fill_color":"lightgrey","fill_alpha":0.5,"level":"overlay","visible":false,"left":{"type":"number","value":"nan"},"right":{"type":"number","value":"nan"},"top":{"type":"number","value":"nan"},"bottom":{"type":"number","value":"nan"},"left_units":"canvas","right_units":"canvas","top_units":"canvas","bottom_units":"canvas","handles":{"type":"object","name":"BoxInteractionHandles","id":"p1042","attributes":{"all":{"type":"object","name":"AreaVisuals","id":"p1041","attributes":{"fill_color":"white","hover_fill_color":"lightgray"}}}}}}}},{"type":"object","name":"BoxZoomTool","id":"p1111","attributes":{"overlay":{"type":"object","name":"BoxAnnotation","id":"p1112","attributes":{"syncable":false,"line_color":"black","line_alpha":1.0,"line_width":2,"line_dash":[4,4],"fill_color":"lightgrey","fill_alpha":0.5,"level":"overlay","visible":false,"left":{"type":"number","value":"nan"},"right":{"type":"number","value":"nan"},"top":{"type":"number","value":"nan"},"bottom":{"type":"number","value":"nan"},"left_units":"canvas","right_units":"canvas","top_units":"canvas","bottom_units":"canvas","handles":{"type":"object","name":"BoxInteractionHandles","id":"p1118","attributes":{"all":{"type":"object","name":"AreaVisuals","id":"p1117","attributes":{"fill_color":"white","hover_fill_color":"lightgray"}}}}}}}}]}},{"type":"object","name":"SaveTool","id":"p1156"},{"type":"object","name":"ToolProxy","id":"p1157","attributes":{"tools":[{"type":"object","name":"ResetTool","id":"p1044"},{"type":"object","name":"ResetTool","id":"p1120"}]}},{"type":"object","name":"ToolProxy","id":"p1158","attributes":{"tools":[{"type":"object","name":"HelpTool","id":"p1045"},{"type":"object","name":"HelpTool","id":"p1121"}]}}]}},"children":[[{"type":"object","name":"Figure","id":"p1010","attributes":{"width":500,"height":350,"x_range":{"type":"object","name":"DataRange1d","id":"p1012"},"y_range":{"type":"object","name":"Range1d","id":"p1020","attributes":{"end":0.035}},"x_scale":{"type":"object","name":"LinearScale","id":"p1021"},"y_scale":{"type":"object","name":"LinearScale","id":"p1022"},"title":{"type":"object","name":"Title","id":"p1013"},"renderers":[{"type":"object","name":"GlyphRenderer","id":"p1052","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1001","attributes":{"selected":{"type":"object","name":"Selection","id":"p1002","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1003"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"AAAAAAAAhD8AAAAAAACePwAAAAAAAKk/AAAAAACAsT8AAAAAAIC2PwAAAAAAgLs/AAAAAABAwD8AAAAAAMDCPwAAAAAAQMU/AAAAAADAxz8AAAAAAEDKPwAAAAAAwMw/AAAAAABAzz8AAAAAAODQPwAAAAAAINI/AAAAAABg0z8AAAAAAKDUPwAAAAAA4NU/AAAAAAAg1z8AAAAAAGDYPwAAAAAAoNk/AAAAAADg2j8AAAAAACDcPwAAAAAAYN0/AAAAAACg3j8AAAAAAODfPwAAAAAAkOA/AAAAAAAw4T8AAAAAANDhPwAAAAAAcOI/AAAAAAAQ4z8AAAAAALDjPwAAAAAAUOQ/AAAAAADw5D8AAAAAAJDlPwAAAAAAMOY/AAAAAADQ5j8AAAAAAHDnPwAAAAAAEOg/AAAAAACw6D8AAAAAAFDpPwAAAAAA8Ok/AAAAAACQ6j8AAAAAADDrPwAAAAAA0Os/AAAAAABw7D8AAAAAABDtPwAAAAAAsO0/AAAAAABQ7j8AAAAAAPDuPwAAAAAAkO8/AAAAAAAY8D8AAAAAAGjwPwAAAAAAuPA/AAAAAAAI8T8AAAAAAFjxPwAAAAAAqPE/AAAAAAD48T8AAAAAAEjyPwAAAAAAmPI/AAAAAADo8j8AAAAAADjzPwAAAAAAiPM/AAAAAADY8z8AAAAAACj0PwAAAAAAePQ/AAAAAADI9D8AAAAAABj1PwAAAAAAaPU/AAAAAAC49T8AAAAAAAj2PwAAAAAAWPY/AAAAAACo9j8AAAAAAPj2PwAAAAAASPc/AAAAAACY9z8AAAAAAOj3PwAAAAAAOPg/AAAAAACI+D8AAAAAANj4PwAAAAAAKPk/AAAAAAB4+T8AAAAAAMj5PwAAAAAAGPo/AAAAAABo+j8AAAAAALj6PwAAAAAACPs/AAAAAABY+z8AAAAAAKj7PwAAAAAA+Ps/AAAAAABI/D8AAAAAAJj8PwAAAAAA6Pw/AAAAAAA4/T8AAAAAAIj9PwAAAAAA2P0/AAAAAAAo/j8AAAAAAHj+PwAAAAAAyP4/AAAAAAAY/z8AAAAAAGj/PwAAAAAAuP8/AAAAAAAEAEAAAAAAACwAQAAAAAAAVABAAAAAAAB8AEAAAAAAAKQAQAAAAAAAzABAAAAAAAD0AEAAAAAAABwBQAAAAAAARAFAAAAAAABsAUAAAAAAAJQBQAAAAAAAvAFAAAAAAADkAUAAAAAAAAwCQAAAAAAANAJAAAAAAABcAkAAAAAAAIQCQAAAAAAArAJAAAAAAADUAkAAAAAAAPwCQAAAAAAAJANAAAAAAABMA0AAAAAAAHQDQAAAAAAAnANAAAAAAADEA0AAAAAAAOwDQAAAAAAAFARAAAAAAAA8BEAAAAAAAGQEQAAAAAAAjARAAAAAAAC0BEAAAAAAANwEQAAAAAAABAVAAAAAAAAsBUAAAAAAAFQFQAAAAAAAfAVAAAAAAACkBUAAAAAAAMwFQAAAAAAA9AVAAAAAAAAcBkAAAAAAAEQGQAAAAAAAbAZAAAAAAACUBkAAAAAAALwGQAAAAAAA5AZAAAAAAAAMB0AAAAAAADQHQAAAAAAAXAdAAAAAAACEB0AAAAAAAKwHQAAAAAAA1AdAAAAAAAD8B0AAAAAAACQIQAAAAAAATAhAAAAAAAB0CEAAAAAAAJwIQAAAAAAAxAhAAAAAAADsCEAAAAAAABQJQAAAAAAAPAlAAAAAAABkCUAAAAAAAIwJQAAAAAAAtAlAAAAAAADcCUAAAAAAAAQKQAAAAAAALApAAAAAAABUCkAAAAAAAHwKQAAAAAAApApAAAAAAADMCkAAAAAAAPQKQAAAAAAAHAtAAAAAAABEC0AAAAAAAGwLQAAAAAAAlAtAAAAAAAC8C0AAAAAAAOQLQAAAAAAADAxAAAAAAAA0DEAAAAAAAFwMQAAAAAAAhAxAAAAAAACsDEAAAAAAANQMQAAAAAAA/AxAAAAAAAAkDUAAAAAAAEwNQAAAAAAAdA1AAAAAAACcDUAAAAAAAMQNQAAAAAAA7A1AAAAAAAAUDkAAAAAAADwOQAAAAAAAZA5AAAAAAACMDkAAAAAAALQOQAAAAAAA3A5AAAAAAAAED0AAAAAAACwPQAAAAAAAVA9AAAAAAAB8D0AAAAAAAKQPQAAAAAAAzA9AAAAAAAD0D0AAAAAAAA4QQAAAAAAAIhBAAAAAAAA2EEAAAAAAAEoQQAAAAAAAXhBAAAAAAAByEEAAAAAAAIYQQAAAAAAAmhBAAAAAAACuEEAAAAAAAMIQQAAAAAAA1hBAAAAAAADqEEAAAAAAAP4QQAAAAAAAEhFAAAAAAAAmEUAAAAAAADoRQAAAAAAAThFAAAAAAABiEUAAAAAAAHYRQAAAAAAAihFAAAAAAACeEUAAAAAAALIRQAAAAAAAxhFAAAAAAADaEUAAAAAAAO4RQAAAAAAAAhJAAAAAAAAWEkAAAAAAACoSQAAAAAAAPhJAAAAAAABSEkAAAAAAAGYSQAAAAAAAehJAAAAAAACOEkAAAAAAAKISQAAAAAAAthJAAAAAAADKEkAAAAAAAN4SQAAAAAAA8hJAAAAAAAAGE0AAAAAAABoTQAAAAAAALhNAAAAAAABCE0AAAAAAAFYTQAAAAAAAahNAAAAAAAB+E0AAAAAAAJITQAAAAAAAphNAAAAAAAC6E0AAAAAAAM4TQAAAAAAA4hNAAAAAAAD2E0A="},"shape":[256],"dtype":"float64","order":"little"}],["y",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1053","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1054"}}},"glyph":{"type":"object","name":"Line","id":"p1049","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_width":2}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1050","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_alpha":0.1,"line_width":2}},"muted_glyph":{"type":"object","name":"Line","id":"p1051","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_alpha":0.2,"line_width":2}}}},{"type":"object","name":"GlyphRenderer","id":"p1063","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1004","attributes":{"selected":{"type":"object","name":"Selection","id":"p1005","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1006"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}],["y",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1064","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1065"}}},"glyph":{"type":"object","name":"Line","id":"p1060","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_width":2}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1061","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.1,"line_width":2}},"muted_glyph":{"type":"object","name":"Line","id":"p1062","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.2,"line_width":2}}}},{"type":"object","name":"GlyphRenderer","id":"p1073","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1007","attributes":{"selected":{"type":"object","name":"Selection","id":"p1008","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1009"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}],["y",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1074","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1075"}}},"glyph":{"type":"object","name":"Line","id":"p1070","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_width":2,"line_dash":[6]}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1071","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.1,"line_width":2,"line_dash":[6]}},"muted_glyph":{"type":"object","name":"Line","id":"p1072","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.2,"line_width":2,"line_dash":[6]}}}}],"toolbar":{"type":"object","name":"Toolbar","id":"p1019","attributes":{"tools":[{"id":"p1033"},{"id":"p1034"},{"id":"p1035"},{"type":"object","name":"SaveTool","id":"p1043"},{"id":"p1044"},{"id":"p1045"}]}},"toolbar_location":null,"left":[{"type":"object","name":"LinearAxis","id":"p1028","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1029","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1030"},"axis_label":"$$\\text{Pr}(X)$$","axis_label_text_font":"Bitstream Charter","axis_label_text_font_size":"20pt","major_label_policy":{"type":"object","name":"AllLabels","id":"p1031"},"major_label_text_font":"Bitstream Charter","major_label_text_font_size":"18pt"}}],"below":[{"type":"object","name":"LinearAxis","id":"p1023","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1024","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1025"},"axis_label":"x","axis_label_text_font":"Bitstream Charter","axis_label_text_font_size":"20pt","major_label_policy":{"type":"object","name":"AllLabels","id":"p1026"},"major_label_text_font":"Bitstream Charter","major_label_text_font_size":"18pt"}}],"center":[{"type":"object","name":"Grid","id":"p1027","attributes":{"axis":{"id":"p1023"}}},{"type":"object","name":"Grid","id":"p1032","attributes":{"dimension":1,"axis":{"id":"p1028"}}},{"type":"object","name":"Legend","id":"p1055","attributes":{"click_policy":"hide","label_text_font":"Bitstream Charter","label_text_font_size":"18pt","items":[{"type":"object","name":"LegendItem","id":"p1056","attributes":{"label":{"type":"value","value":"P(x)=LN(x|0.2,0.35)"},"renderers":[{"id":"p1052"}]}},{"type":"object","name":"LegendItem","id":"p1066","attributes":{"label":{"type":"value","value":"Q(x)=LN(x|0.3,0.25)"},"renderers":[{"id":"p1063"}]}},{"type":"object","name":"LegendItem","id":"p1076","attributes":{"label":{"type":"value","value":"R(X) (Prior=0.03)"},"renderers":[{"id":"p1073"}]}}]}}]}},0,0],[{"type":"object","name":"Figure","id":"p1086","attributes":{"width":500,"height":350,"x_range":{"type":"object","name":"DataRange1d","id":"p1088"},"y_range":{"type":"object","name":"Range1d","id":"p1096","attributes":{"end":0.035}},"x_scale":{"type":"object","name":"LinearScale","id":"p1097"},"y_scale":{"type":"object","name":"LinearScale","id":"p1098"},"title":{"type":"object","name":"Title","id":"p1089"},"renderers":[{"type":"object","name":"GlyphRenderer","id":"p1128","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1077","attributes":{"selected":{"type":"object","name":"Selection","id":"p1078","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1079"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}],["y",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1129","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1130"}}},"glyph":{"type":"object","name":"Line","id":"p1125","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_width":2}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1126","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_alpha":0.1,"line_width":2}},"muted_glyph":{"type":"object","name":"Line","id":"p1127","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_alpha":0.2,"line_width":2}}}},{"type":"object","name":"GlyphRenderer","id":"p1139","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1080","attributes":{"selected":{"type":"object","name":"Selection","id":"p1081","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1082"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}],["y",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1140","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1141"}}},"glyph":{"type":"object","name":"Line","id":"p1136","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_width":2}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1137","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.1,"line_width":2}},"muted_glyph":{"type":"object","name":"Line","id":"p1138","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.2,"line_width":2}}}},{"type":"object","name":"GlyphRenderer","id":"p1149","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1083","attributes":{"selected":{"type":"object","name":"Selection","id":"p1084","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1085"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}],["y",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[256],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1150","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1151"}}},"glyph":{"type":"object","name":"Line","id":"p1146","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_width":2,"line_dash":[6]}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1147","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.1,"line_width":2,"line_dash":[6]}},"muted_glyph":{"type":"object","name":"Line","id":"p1148","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.2,"line_width":2,"line_dash":[6]}}}}],"toolbar":{"type":"object","name":"Toolbar","id":"p1095","attributes":{"tools":[{"id":"p1109"},{"id":"p1110"},{"id":"p1111"},{"type":"object","name":"SaveTool","id":"p1119"},{"id":"p1120"},{"id":"p1121"}]}},"toolbar_location":null,"left":[{"type":"object","name":"LinearAxis","id":"p1104","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1105","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1106"},"axis_label":"$$\\text{Pr}(X)$$","axis_label_text_font":"Bitstream Charter","axis_label_text_font_size":"20pt","major_label_policy":{"type":"object","name":"AllLabels","id":"p1107"},"major_label_text_font":"Bitstream Charter","major_label_text_font_size":"18pt"}}],"below":[{"type":"object","name":"LinearAxis","id":"p1099","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1100","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1101"},"axis_label":"x","axis_label_text_font":"Bitstream Charter","axis_label_text_font_size":"20pt","major_label_policy":{"type":"object","name":"AllLabels","id":"p1102"},"major_label_text_font":"Bitstream Charter","major_label_text_font_size":"18pt"}}],"center":[{"type":"object","name":"Grid","id":"p1103","attributes":{"axis":{"id":"p1099"}}},{"type":"object","name":"Grid","id":"p1108","attributes":{"dimension":1,"axis":{"id":"p1104"}}},{"type":"object","name":"Legend","id":"p1131","attributes":{"click_policy":"hide","label_text_font":"Bitstream Charter","label_text_font_size":"18pt","items":[{"type":"object","name":"LegendItem","id":"p1132","attributes":{"label":{"type":"value","value":"P(x)=LN(x|0.2,0.35)"},"renderers":[{"id":"p1128"}]}},{"type":"object","name":"LegendItem","id":"p1142","attributes":{"label":{"type":"value","value":"Q(x)=LN(x|0.3,0.45)"},"renderers":[{"id":"p1139"}]}},{"type":"object","name":"LegendItem","id":"p1152","attributes":{"label":{"type":"value","value":"R(X) (Prior=0.03)"},"renderers":[{"id":"p1149"}]}}]}}]}},0,1]]}}]}};
  const render_items = [{"docid":"192243d2-9fbc-4239-ae03-ddd6f7ad1f31","roots":{"p1160":"ed5202c5-26d7-4272-a9d9-37b2b24180ac"},"root_ids":["p1160"]}];
  void root.Bokeh.embed.embed_items_notebook(docs_json, render_items);
  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    let attempts = 0;
    const timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_kl_divergence</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the KL divergence DKL(P || Q).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">P</span> <span class="o">/</span> <span class="n">Q</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">P</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">generate_and_plot_kl_vs_prior</span><span class="p">(</span><span class="n">mu1</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">mu2</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">priors</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates two log-normal distributions, quantizes them with 2^b symbols,</span>
<span class="sd">    computes the posterior with varying priors, and plots KL divergences DKL(P||R) and DKL(Q||R).</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - mu1, sigma1: Parameters for the first log-normal distribution.</span>
<span class="sd">    - mu2, sigma2: Parameters for the second log-normal distribution.</span>
<span class="sd">    - b: Number of symbols = 2^b for quantization.</span>
<span class="sd">    - priors: Array of prior pseudo-counts to apply to Q.</span>
<span class="sd">    - y_range: Range for the y-axis in the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the two log-normal distributions</span>
    <span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bins_midpoints</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Evaluate the distributions at the bin midpoints</span>
    <span class="n">dist1</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">bins_midpoints</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu1</span><span class="p">))</span>
    <span class="n">dist2</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">bins_midpoints</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu2</span><span class="p">))</span>

    <span class="c1"># Normalize to create PDFs</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">dist1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist1</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">dist2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist2</span><span class="p">)</span>

    <span class="n">kl_p_r_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kl_q_r_list</span><span class="p">,</span> <span class="n">ratio_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="c1"># Compute KL divergences for each prior value</span>
    <span class="k">for</span> <span class="n">prior_pseudo_count</span> <span class="ow">in</span> <span class="n">priors</span><span class="p">:</span>
        <span class="n">prior_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">prior_pseudo_count</span><span class="p">)</span>
        <span class="n">posterior_counts</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist2</span><span class="p">)</span> <span class="o">+</span> <span class="n">prior_counts</span>  <span class="c1"># Adding pseudo-counts</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">posterior_counts</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">posterior_counts</span><span class="p">)</span>  <span class="c1"># Renormalize</span>

        <span class="c1"># Ensure valid PDFs</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s1">&#39;R does not sum to 1&#39;</span>

        <span class="c1"># Compute KL divergences</span>
        <span class="n">kl_p_r</span> <span class="o">=</span> <span class="n">compute_kl_divergence</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
        <span class="n">kl_q_r</span> <span class="o">=</span> <span class="n">compute_kl_divergence</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>

        <span class="n">kl_p_r_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kl_p_r</span><span class="p">)</span>
        <span class="n">kl_q_r_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kl_q_r</span><span class="p">)</span>
        
        <span class="c1"># Compute ratio as percentage</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">kl_q_r</span> <span class="o">/</span> <span class="n">kl_p_r</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">kl_p_r</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">ratio_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>

    <span class="c1"># Prepare data for plotting</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">prior</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span>
        <span class="n">kl_p_r</span><span class="o">=</span><span class="n">kl_p_r_list</span><span class="p">,</span>
        <span class="n">kl_q_r</span><span class="o">=</span><span class="n">kl_q_r_list</span><span class="p">,</span>
        <span class="n">ratio</span><span class="o">=</span><span class="n">ratio_list</span><span class="p">,</span>
    <span class="p">))</span>

    <span class="n">ratio_range</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ratio_list</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.98</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">ratio_list</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.02</span><span class="p">)</span>
    <span class="n">ratio_range</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ratio_list</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Create the Bokeh plot</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
               <span class="n">x_axis_label</span><span class="o">=</span><span class="s1">&#39;Prior Pseudo-count&#39;</span><span class="p">,</span>
               <span class="n">y_axis_label</span><span class="o">=</span><span class="s1">&#39;KL Divergence&#39;</span><span class="p">,</span>
               <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
               <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span>
               <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

    <span class="c1"># Add secondary y-axis for the ratio</span>
    <span class="n">p</span><span class="o">.</span><span class="n">extra_y_ranges</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ratio&quot;</span><span class="p">:</span> <span class="n">Range1d</span><span class="p">(</span><span class="o">*</span><span class="n">ratio_range</span><span class="p">)}</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">LinearAxis</span><span class="p">(</span><span class="n">y_range_name</span><span class="o">=</span><span class="s2">&quot;ratio&quot;</span><span class="p">,</span> <span class="n">axis_label</span><span class="o">=</span><span class="s1">&#39;Noise (%)&#39;</span><span class="p">),</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s1">&#39;prior&#39;</span><span class="p">,</span> <span class="s1">&#39;kl_p_r&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;DKL(P || R)&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s1">&#39;prior&#39;</span><span class="p">,</span> <span class="s1">&#39;kl_q_r&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;DKL(Q || R)&#39;</span><span class="p">)</span>

    <span class="c1"># Plot the ratio on the secondary y-axis</span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s1">&#39;prior&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
           <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">y_range_name</span><span class="o">=</span><span class="s2">&quot;ratio&quot;</span><span class="p">,</span>
           <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;Prior Influence (%)&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">priors</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">priors</span><span class="p">],</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
           <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">y_range_name</span><span class="o">=</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span>
           <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;5% noise limit&#39;</span><span class="p">)</span>

    <span class="c1"># Configure the legend and show the plot</span>
    <span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;top_left&quot;</span>
    <span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">click_policy</span> <span class="o">=</span> <span class="s2">&quot;hide&quot;</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.35</span>
<span class="n">priors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">prior_vs_kld</span> <span class="o">=</span> <span class="n">generate_and_plot_kl_vs_prior</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span><span class="o">+</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">-</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">priors</span><span class="p">)</span>
<span class="n">prior_vs_kld</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">prior_vs_kld</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">prior_vs_kld</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="ebb730ca-cfef-4f62-ad2e-a8cf1664f286" data-root-id="p1177" style="display: contents;"></div>
</div><script type="application/javascript">(function(root) {
  function embed_document(root) {
  const docs_json = {"d32062c2-3aef-4f26-a236-f762a6be5a59":{"version":"3.6.0","title":"Bokeh Application","roots":[{"type":"object","name":"Figure","id":"p1177","attributes":{"height":400,"x_range":{"type":"object","name":"DataRange1d","id":"p1179"},"y_range":{"type":"object","name":"Range1d","id":"p1187","attributes":{"end":0.02}},"x_scale":{"type":"object","name":"LogScale","id":"p1188"},"y_scale":{"type":"object","name":"LinearScale","id":"p1189"},"extra_y_ranges":{"type":"map","entries":[["ratio",{"type":"object","name":"Range1d","id":"p1213","attributes":{"start":0.0030549570142611895,"end":10}}]]},"title":{"type":"object","name":"Title","id":"p1180"},"renderers":[{"type":"object","name":"GlyphRenderer","id":"p1224","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1174","attributes":{"selected":{"type":"object","name":"Selection","id":"p1175","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1176"},"data":{"type":"map","entries":[["prior",{"type":"ndarray","array":{"type":"bytes","data":"je21oPfGsD6YBnWnuGmyPtg28aVNNbQ+hDL6qbEttj5BZ6McQ1e4PoQmLHLNtro+3ICxy5NRvT7cYh5RrhbAPuj/hko/qME+tsbDO/dgwz5iVvJep0TFPoxUdzWAV8c+AgEd0hqeyT6k5Q4Lgx3MPnrgTapC284+zwO22rbu0D7xk+XzV5XSPlEioL4tZdQ+WDL0tjxi1j4azpaf7ZDYPg3ZvkgX9to+aOYGSwmX3T5ILxDnyzzgPqFMujoU0uE+qieuR+CO4z4yiDBTCnflPii5hsvMjuc+1x8XqMva6T70PYyzHmDsPp/sytZcJO8++ArjPtQW8T5DmNWYXsHyPldYSEN/lfQ+fTfgPkSX9j4HHXnAIMv4PtHFKg/3Nfs+w0CWWCPd/T4mnL/JQ2MAP97EhUVM/AE/2bjKFza9Az+aP2em5KkFP0vkBGScxgc/kbN0RgwYCj+jyTIpWKMMPw2LHTMkbg8/9Q9TrFA/ET8rSRuLze0SP98an0BDxhQ//GGmaMnMFj+nO/PC3QUZP2JGpyhudhs/Kf84euMjHj9KoxrPFoogP8P/slXoJiI//0nHrfnrIz9G4mNzN90lP53jUTXw/ic/2afYAd5VKj/dodvhMOcsP7v1kVmauC8/PaMsBC1oMT+E59DBpRozP8JE1sV69zQ/PHzpXc0CNz8V2qztJUE5P8w/tft9tzs/7ihkOUtrPj++EArPRbFAP//QN1jpUUI/zCK0DSwbRD+70pHXAxFGP4EUrXjJN0g/QOkMMkKUSj/8jtVWqitNPzo4IHTgAVA/LL2rKWqRUT+iHVo26EdTPxUuouQmKVU/4nENS1E5Vz/IiVOK+nxZPyjsJvIn+Vs/fukwI1yzXj+rM3aj0dhgP2FuOzxQfWI/E6kJPs5KZD/JowDzSkVmPx/yO2opcWg/C90JMjrTaj8NO+0ExnBtP+Yji8DMJ3A/gq0mAgm7cT8hamnklXVzPxWeP7FIW3U/odY9X1Zwdz/j5qHlXLl5P7C2J3ltO3w/uzBlyBf8fj8EmksouwCBP/ehG/MdqYI/exSuR+F6hD8="},"shape":[100],"dtype":"float64","order":"little"}],["kl_p_r",[0.006460910939676022,0.006460768270300183,0.006460612800077066,0.006460443395947962,0.006460258827337774,0.006460057758296772,0.0064598387391071104,0.0064596001973528305,0.006459340428433209,0.006459057585520792,0.006458749668967996,0.006458414515175204,0.006458049784951165,0.006457652951407825,0.006457221287455269,0.006456751852984421,0.0064562414818516755,0.006455686768821207,0.006455084056649251,0.006454429423551299,0.006453718671344115,0.0064529473146125,0.006452110571339662,0.006451203355499669,0.0064502202722341775,0.006449155616319604,0.0064480033747695495,0.0064467572345428695,0.006445410596483748,0.006443956596780053,0.006442388137407802,0.006440697927222001,0.0064388785355594105,0.006436922460443786,0.006434822213715243,0.006432570425658325,0.006430159971962545,0.0064275841261364815,0.006424836740788068,0.006421912461504257,0.006418806977412993,0.006415517312880853,0.006412042165217706,0.006408382293725569,0.006404540965944487,0.006400524467548551,0.006396342683008824,0.006392009754920559,0.006387544830756365,0.00638297290682037,0.006378325780295504,0.006373643121565035,0.006368973680414299,0.006364376641323045,0.006359923144838165,0.006355697993978709,0.006351801566803098,0.006348351958637767,0.006345487380088329,0.006343368839793931,0.006342183144006854,0.006342146248458708,0.006343507001656987,0.006346551322765738,0.0063516068615468435,0.006359048192538482,0.006369302600710631,0.006382856521297675,0.006400262702371031,0.0064221481649886026,0.006449223042451045,0.00648229038729311,0.006522257042122987,0.006570145678269347,0.006627108114343309,0.006694440035210047,0.006773597240372574,0.006866213559289799,0.006974120579484534,0.007099369341227865,0.0072442541598370155,0.00741133874282511,0.0076034847738639475,0.007823883138232115,0.008076087964450482,0.008364053653391953,0.008692175058349306,0.009065330966236301,0.009488931010000225,0.009968966113915737,0.010512062534975372,0.011125539513103787,0.011817470478164708,0.012596747680234683,0.013473150008657613,0.014457413642082376,0.015561305023000797,0.016797695473174876,0.018180636557867114,0.019725435064330655]],["kl_q_r",[2.0140617544571546e-07,2.2258742011852267e-07,2.46027360410894e-07,2.719726334658222e-07,3.006978858232366e-07,3.3250915669688234e-07,3.677476970741844e-07,4.067943006318757e-07,4.5007420998099044e-07,4.98062686831101e-07,5.512913437308706e-07,6.103553475297785e-07,6.759216284229658e-07,7.487382430494947e-07,8.296450682752494e-07,9.195860276808594e-07,1.0196230819973183e-06,1.1309522590907922e-06,1.254922029923762e-06,1.3930543931336486e-06,1.547069083385304e-06,1.7189113739240954e-06,1.9107840311075103e-06,2.1251840332538943e-06,2.364944784420023e-06,2.633284630026847e-06,2.933862611215958e-06,3.2708425103575584e-06,3.6489663845128007e-06,4.073638933893206e-06,4.551024221872864e-06,5.088156447232335e-06,5.693066666619153e-06,6.374927586088028e-06,7.144218771893794e-06,8.012914886674818e-06,8.994699827668474e-06,1.0105209946598246e-05,1.1362309844698757e-05,1.2786404587921185e-05,1.4400792571197255e-05,1.6232063674580504e-05,1.8310547816689803e-05,2.0670819526507722e-05,2.3352264718069055e-05,2.6399716501332633e-05,2.9864167568583572e-05,3.380356751080604e-05,3.828371431136495e-05,4.337925029148038e-05,4.9174773903940905e-05,5.5766080050475154e-05,6.326154300198095e-05,7.178365757150356e-05,8.147075592393618e-05,9.247891931487884e-05,0.00010498410616562341,0.00011918452018090789,0.00013530324476235755,0.00015359117272928575,0.00017433026339476,0.00019783716233607966,0.0002244672227864771,0.0002546189714880625,0.0002887390660637702,0.00032732779555562017,0.000370945180720415,0.0004202177360042642,0.0004758459608393349,0.0005386126340249629,0.0006093919914783744,0.00068915987455106,0.0007790049433865228,0.0008801410574141039,0.0009939209329741143,0.0011218511961834103,0.00126560895736303,0.0014270600415437242,0.0016082790175490033,0.0018115711757057426,0.0020394966110737255,0.0022948965748472608,0.0025809222608354017,0.0029010661961371463,0.0032591964046282526,0.003659593507901738,0.004106990919913624,0.004606618277667281,0.005164248229537356,0.005786246673777995,0.00647962650064292,0.0072521048403904765,0.008112163754028345,0.009069114221510612,0.01013316318052236,0.011315483245101647,0.012628284584151647,0.014084888262339796,0.015699800137087,0.017488784162712545]],["ratio",[0.003117303075776724,0.0034452159682269597,0.003808111831248565,0.004209813735639344,0.004654579543326935,0.005147154547803148,0.005692830919259373,0.006297515143407508,0.0069678044526004556,0.00771107363940528,0.008535573787286263,0.009450544651410018,0.010466342795901456,0.011594587827552164,0.012848329511132564,0.014242238955734546,0.015792827527648275,0.01751869784873874,0.01944083173682444,0.02158292083961117,0.023971746556828082,0.026637616737264752,0.029614868033961347,0.03294244369838643,0.03666455848957964,0.04083146363166232,0.04550032685615357,0.05073624446150699,0.05661340468369029,0.06321642414427095,0.0706418819357885,0.07900007894683173,0.08841705329862289,0.09903688641991994,0.11102433811872123,0.12456785322882426,0.13988298684462136,0.15721630006377413,0.17684978316359617,0.19910586861107918,0.2243531020931445,0.25301254572238985,0.2855649938800443,0.32255908869148564,0.3646204285715777,0.41246176989374,0.46689442777846196,0.5288409875279697,0.5993494421679336,0.6796088738701763,0.7709667959553904,0.8749482672130207,0.9932768790758422,1.1278976970882253,1.2810022081801318,1.455055281142873,1.6528240855997423,1.8774088292118347,2.132275058759539,2.4212871205874142,2.7487421828790315,3.119403977544018,3.5385351151633317,4.011926454840407,4.545921565325785,5.147433792681378,5.823952855985021,6.583537239198842,7.434787960548148,8.386798625439667,9.449076074236274,10.631425520553407,11.943793971250138,13.396066092189654,14.99780772887849,16.75795421697598,18.68444361911038,20.783799239872913,23.06067122326516,25.517353565273503,28.15330006477314,30.96466987248345,33.943939359318605,37.07962075712536,40.35612810279756,43.75382630906042,47.24928907142334,50.81577600227247,54.42392008219726,58.04259546735684,61.639915849854674,65.18429809043296,68.64551740592282,71.99568056555412,75.21005239317431,78.26768691299489,81.1518350516623,83.85012268398778,86.35451287481676,88.66108202772863]]]}}},"view":{"type":"object","name":"CDSView","id":"p1225","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1226"}}},"glyph":{"type":"object","name":"Line","id":"p1221","attributes":{"x":{"type":"field","field":"prior"},"y":{"type":"field","field":"kl_p_r"},"line_width":2}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1222","attributes":{"x":{"type":"field","field":"prior"},"y":{"type":"field","field":"kl_p_r"},"line_alpha":0.1,"line_width":2}},"muted_glyph":{"type":"object","name":"Line","id":"p1223","attributes":{"x":{"type":"field","field":"prior"},"y":{"type":"field","field":"kl_p_r"},"line_alpha":0.2,"line_width":2}}}},{"type":"object","name":"GlyphRenderer","id":"p1235","attributes":{"data_source":{"id":"p1174"},"view":{"type":"object","name":"CDSView","id":"p1236","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1237"}}},"glyph":{"type":"object","name":"Line","id":"p1232","attributes":{"x":{"type":"field","field":"prior"},"y":{"type":"field","field":"kl_q_r"},"line_color":"red","line_width":2}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1233","attributes":{"x":{"type":"field","field":"prior"},"y":{"type":"field","field":"kl_q_r"},"line_color":"red","line_alpha":0.1,"line_width":2}},"muted_glyph":{"type":"object","name":"Line","id":"p1234","attributes":{"x":{"type":"field","field":"prior"},"y":{"type":"field","field":"kl_q_r"},"line_color":"red","line_alpha":0.2,"line_width":2}}}},{"type":"object","name":"GlyphRenderer","id":"p1245","attributes":{"y_range_name":"ratio","data_source":{"id":"p1174"},"view":{"type":"object","name":"CDSView","id":"p1246","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1247"}}},"glyph":{"type":"object","name":"Line","id":"p1242","attributes":{"x":{"type":"field","field":"prior"},"y":{"type":"field","field":"ratio"},"line_color":"red","line_width":2,"line_dash":[6]}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1243","attributes":{"x":{"type":"field","field":"prior"},"y":{"type":"field","field":"ratio"},"line_color":"red","line_alpha":0.1,"line_width":2,"line_dash":[6]}},"muted_glyph":{"type":"object","name":"Line","id":"p1244","attributes":{"x":{"type":"field","field":"prior"},"y":{"type":"field","field":"ratio"},"line_color":"red","line_alpha":0.2,"line_width":2,"line_dash":[6]}}}},{"type":"object","name":"GlyphRenderer","id":"p1255","attributes":{"y_range_name":"ratio","data_source":{"type":"object","name":"ColumnDataSource","id":"p1249","attributes":{"selected":{"type":"object","name":"Selection","id":"p1250","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1251"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"je21oPfGsD6YBnWnuGmyPtg28aVNNbQ+hDL6qbEttj5BZ6McQ1e4PoQmLHLNtro+3ICxy5NRvT7cYh5RrhbAPuj/hko/qME+tsbDO/dgwz5iVvJep0TFPoxUdzWAV8c+AgEd0hqeyT6k5Q4Lgx3MPnrgTapC284+zwO22rbu0D7xk+XzV5XSPlEioL4tZdQ+WDL0tjxi1j4azpaf7ZDYPg3ZvkgX9to+aOYGSwmX3T5ILxDnyzzgPqFMujoU0uE+qieuR+CO4z4yiDBTCnflPii5hsvMjuc+1x8XqMva6T70PYyzHmDsPp/sytZcJO8++ArjPtQW8T5DmNWYXsHyPldYSEN/lfQ+fTfgPkSX9j4HHXnAIMv4PtHFKg/3Nfs+w0CWWCPd/T4mnL/JQ2MAP97EhUVM/AE/2bjKFza9Az+aP2em5KkFP0vkBGScxgc/kbN0RgwYCj+jyTIpWKMMPw2LHTMkbg8/9Q9TrFA/ET8rSRuLze0SP98an0BDxhQ//GGmaMnMFj+nO/PC3QUZP2JGpyhudhs/Kf84euMjHj9KoxrPFoogP8P/slXoJiI//0nHrfnrIz9G4mNzN90lP53jUTXw/ic/2afYAd5VKj/dodvhMOcsP7v1kVmauC8/PaMsBC1oMT+E59DBpRozP8JE1sV69zQ/PHzpXc0CNz8V2qztJUE5P8w/tft9tzs/7ihkOUtrPj++EArPRbFAP//QN1jpUUI/zCK0DSwbRD+70pHXAxFGP4EUrXjJN0g/QOkMMkKUSj/8jtVWqitNPzo4IHTgAVA/LL2rKWqRUT+iHVo26EdTPxUuouQmKVU/4nENS1E5Vz/IiVOK+nxZPyjsJvIn+Vs/fukwI1yzXj+rM3aj0dhgP2FuOzxQfWI/E6kJPs5KZD/JowDzSkVmPx/yO2opcWg/C90JMjrTaj8NO+0ExnBtP+Yji8DMJ3A/gq0mAgm7cT8hamnklXVzPxWeP7FIW3U/odY9X1Zwdz/j5qHlXLl5P7C2J3ltO3w/uzBlyBf8fj8EmksouwCBP/ehG/MdqYI/exSuR+F6hD8="},"shape":[100],"dtype":"float64","order":"little"}],["y",[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5]]]}}},"view":{"type":"object","name":"CDSView","id":"p1256","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1257"}}},"glyph":{"type":"object","name":"Line","id":"p1252","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_width":2,"line_dash":[2,4]}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1253","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.1,"line_width":2,"line_dash":[2,4]}},"muted_glyph":{"type":"object","name":"Line","id":"p1254","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.2,"line_width":2,"line_dash":[2,4]}}}}],"toolbar":{"type":"object","name":"Toolbar","id":"p1186","attributes":{"tools":[{"type":"object","name":"PanTool","id":"p1200"},{"type":"object","name":"WheelZoomTool","id":"p1201","attributes":{"renderers":"auto"}},{"type":"object","name":"BoxZoomTool","id":"p1202","attributes":{"overlay":{"type":"object","name":"BoxAnnotation","id":"p1203","attributes":{"syncable":false,"line_color":"black","line_alpha":1.0,"line_width":2,"line_dash":[4,4],"fill_color":"lightgrey","fill_alpha":0.5,"level":"overlay","visible":false,"left":{"type":"number","value":"nan"},"right":{"type":"number","value":"nan"},"top":{"type":"number","value":"nan"},"bottom":{"type":"number","value":"nan"},"left_units":"canvas","right_units":"canvas","top_units":"canvas","bottom_units":"canvas","handles":{"type":"object","name":"BoxInteractionHandles","id":"p1209","attributes":{"all":{"type":"object","name":"AreaVisuals","id":"p1208","attributes":{"fill_color":"white","hover_fill_color":"lightgray"}}}}}}}},{"type":"object","name":"SaveTool","id":"p1210"},{"type":"object","name":"ResetTool","id":"p1211"},{"type":"object","name":"HelpTool","id":"p1212"}]}},"left":[{"type":"object","name":"LinearAxis","id":"p1195","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1196","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1197"},"axis_label":"KL Divergence","axis_label_text_font":"Bitstream Charter","axis_label_text_font_size":"20pt","major_label_policy":{"type":"object","name":"AllLabels","id":"p1198"},"major_label_text_font":"Bitstream Charter","major_label_text_font_size":"18pt"}}],"right":[{"type":"object","name":"LinearAxis","id":"p1214","attributes":{"y_range_name":"ratio","ticker":{"type":"object","name":"BasicTicker","id":"p1215","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1216"},"axis_label":"Noise (%)","axis_label_text_font":"Bitstream Charter","axis_label_text_font_size":"20pt","major_label_policy":{"type":"object","name":"AllLabels","id":"p1217"},"major_label_text_font":"Bitstream Charter","major_label_text_font_size":"18pt"}}],"below":[{"type":"object","name":"LogAxis","id":"p1190","attributes":{"ticker":{"type":"object","name":"LogTicker","id":"p1191","attributes":{"num_minor_ticks":10,"mantissas":[1,5]}},"formatter":{"type":"object","name":"LogTickFormatter","id":"p1192"},"axis_label":"Prior Pseudo-count","axis_label_text_font":"Bitstream Charter","axis_label_text_font_size":"20pt","major_label_policy":{"type":"object","name":"AllLabels","id":"p1193"},"major_label_text_font":"Bitstream Charter","major_label_text_font_size":"18pt"}}],"center":[{"type":"object","name":"Grid","id":"p1194","attributes":{"axis":{"id":"p1190"}}},{"type":"object","name":"Grid","id":"p1199","attributes":{"dimension":1,"axis":{"id":"p1195"}}},{"type":"object","name":"Legend","id":"p1227","attributes":{"location":"top_left","click_policy":"hide","label_text_font":"Bitstream Charter","label_text_font_size":"18pt","items":[{"type":"object","name":"LegendItem","id":"p1228","attributes":{"label":{"type":"value","value":"DKL(P || R)"},"renderers":[{"id":"p1224"}]}},{"type":"object","name":"LegendItem","id":"p1238","attributes":{"label":{"type":"value","value":"DKL(Q || R)"},"renderers":[{"id":"p1235"}]}},{"type":"object","name":"LegendItem","id":"p1248","attributes":{"label":{"type":"value","value":"Prior Influence (%)"},"renderers":[{"id":"p1245"}]}},{"type":"object","name":"LegendItem","id":"p1258","attributes":{"label":{"type":"value","value":"5% noise limit"},"renderers":[{"id":"p1255"}]}}]}}]}}]}};
  const render_items = [{"docid":"d32062c2-3aef-4f26-a236-f762a6be5a59","roots":{"p1177":"ebb730ca-cfef-4f62-ad2e-a8cf1664f286"},"root_ids":["p1177"]}];
  void root.Bokeh.embed.embed_items_notebook(docs_json, render_items);
  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    let attempts = 0;
    const timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);</script></div>
</div>
<p>Let’s run through an example computation to see the difference between 4, 6, and 8 bit quantization, how each represents the total measurement range, and how each quantization aligns with your own expectation of heteroscedastic rating curve uncertainty.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">neg_log_likelihood</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>  <span class="c1"># Enforce positive scale</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logpdf</span> <span class="o">=</span> <span class="n">kappa4</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">logpdf</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">logpdf</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">logpdf</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

<span class="k">def</span> <span class="nf">fit_kappa4_mle</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Handle edge cases where MLE is not feasible</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
    
    <span class="c1"># Define the initial guesses for the parameters</span>
    <span class="n">initial_params</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
    
    <span class="c1"># Bounds for the parameters: h and k between -2 and 2, scale &gt; 1e-5</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
    
    <span class="c1"># Minimize the negative log-likelihood</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">neg_log_likelihood</span><span class="p">,</span> <span class="n">initial_params</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># Log or handle fitting failure if needed</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">h</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">compute_pdf_cdf_kde_scipy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">grid_points</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the probability density function (pdf) and cumulative distribution function (cdf)</span>
<span class="sd">    from an array of values using Kernel Density Estimation (KDE) with scipy.stats.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    data (array-like): Input data array.</span>
<span class="sd">    grid_points (int): Number of points in the grid where the pdf and cdf are evaluated.</span>
<span class="sd">    bandwidth (float or str, optional): The bandwidth of the kernel. If None, Scott&#39;s Rule is used.</span>
<span class="sd">                                         Can also be a string for methods like &#39;scott&#39; or &#39;silverman&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    x_grid (numpy.ndarray): Grid points where the pdf and cdf are evaluated.</span>
<span class="sd">    pdf_values (numpy.ndarray): Estimated pdf values corresponding to x_grid.</span>
<span class="sd">    cdf_values (numpy.ndarray): Estimated cdf values corresponding to x_grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert input data to a numpy array</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="c1"># Create a Gaussian KDE object</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">)</span>
    
    <span class="c1"># Create a grid over which to evaluate the KDE</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">grid_points</span><span class="p">)</span>
    
    <span class="c1"># Evaluate the pdf over the grid</span>
    <span class="n">pdf_values</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
    
    <span class="c1"># Compute the cdf by integrating the pdf</span>
    <span class="n">cdf_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kde</span><span class="o">.</span><span class="n">integrate_box_1d</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x_grid</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">,</span> <span class="n">cdf_values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">remap_low_to_high_resolution</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">which_binning</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized distribution of low-resolution frequencies over high-resolution bins.</span>
<span class="sd">    Expands each low-res bin&#39;s frequency uniformly across the corresponding high-res bins.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">b1_bin_dict</span> <span class="o">=</span> <span class="n">compute_discrete_distributions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>  <span class="c1"># Low-res (Q)</span>
    <span class="n">b2_bin_dict</span> <span class="o">=</span> <span class="n">compute_discrete_distributions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span>  <span class="c1"># High-res (P)</span>
    <span class="n">b1_bins</span> <span class="o">=</span> <span class="n">b1_bin_dict</span><span class="p">[</span><span class="n">which_binning</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span>
    <span class="n">b1_freqs</span> <span class="o">=</span> <span class="n">b1_bin_dict</span><span class="p">[</span><span class="n">which_binning</span><span class="p">][</span><span class="s1">&#39;freqs&#39;</span><span class="p">]</span>
    <span class="n">b2_bins</span> <span class="o">=</span> <span class="n">b2_bin_dict</span><span class="p">[</span><span class="n">which_binning</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span>
    <span class="n">b2_freqs</span> <span class="o">=</span> <span class="n">b2_bin_dict</span><span class="p">[</span><span class="n">which_binning</span><span class="p">][</span><span class="s1">&#39;freqs&#39;</span><span class="p">]</span>
    <span class="c1"># Normalize up-scaled low-res frequencies and convert to probabilities</span>
    <span class="n">b1_probs</span> <span class="o">=</span> <span class="n">b1_freqs</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b1_freqs</span><span class="p">)</span>
    <span class="c1"># Determine the low-res bin for each high-res bin</span>
    <span class="n">bin_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">b2_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">b1_bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Map high-res bins to low-res bins</span>
    
    <span class="c1"># Compute counts of high-res bins falling into each low-res bin</span>
    <span class="n">counts_per_low_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">bin_indices</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">b1_probs</span><span class="p">))</span>

    <span class="c1"># Broadcast low-res frequencies to high-res bins, dividing by the count to distribute uniformly</span>
    <span class="n">high_res_probs</span> <span class="o">=</span> <span class="n">b1_probs</span><span class="p">[</span><span class="n">bin_indices</span><span class="p">]</span> <span class="o">/</span> <span class="n">counts_per_low_bin</span><span class="p">[</span><span class="n">bin_indices</span><span class="p">]</span>
    <span class="c1"># Normalize to ensure the result sums to 1</span>
    <span class="n">high_res_probs</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">high_res_probs</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">high_res_probs</span><span class="p">,</span> <span class="n">b1_bin_dict</span><span class="p">,</span> <span class="n">b2_bin_dict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_discrete_distributions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># 1. Determine the log-spaced bin edges</span>
    <span class="n">bin_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># 1. Compute the histogram using equal-width bins</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">b</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">densities</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">b</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">bin_widths</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
    <span class="n">bin_dict</span><span class="p">[</span><span class="s1">&#39;equal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="s1">&#39;freqs&#39;</span><span class="p">:</span> <span class="n">freqs</span><span class="p">,</span> <span class="s1">&#39;densities&#39;</span><span class="p">:</span> <span class="n">densities</span><span class="p">,</span> <span class="s1">&#39;widths&#39;</span><span class="p">:</span> <span class="n">bin_widths</span><span class="p">}</span>

    <span class="c1"># 2. Compute the histogram using log-spaced bins</span>
    <span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">log_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">minx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">maxx</span><span class="p">),</span> <span class="mi">2</span><span class="o">**</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bin_widths</span> <span class="o">=</span> <span class="n">log_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">log_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">log_densities</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">log_edges</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">log_counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">log_edges</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">log_freqs</span> <span class="o">=</span> <span class="n">log_counts</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">log_freqs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">log_freqs</span><span class="p">)</span>
    <span class="n">bin_dict</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="n">log_edges</span><span class="p">,</span> <span class="s1">&#39;freqs&#39;</span><span class="p">:</span> <span class="n">log_freqs</span><span class="p">,</span> <span class="s1">&#39;densities&#39;</span><span class="p">:</span> <span class="n">densities</span><span class="p">,</span> <span class="s1">&#39;widths&#39;</span><span class="p">:</span> <span class="n">bin_widths</span><span class="p">}</span>

    <span class="c1"># 3. Compute the histogram using uniform (probability) bins</span>
    <span class="n">quantiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">uniform_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">)</span>
    <span class="n">bin_widths</span> <span class="o">=</span> <span class="n">uniform_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">uniform_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">uniform_freqs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">uniform_edges</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">uniform_counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">uniform_edges</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">uniform_freqs</span> <span class="o">=</span> <span class="n">uniform_counts</span> <span class="o">/</span> <span class="n">total_count</span>
    <span class="c1"># assert abs(sum(uniform_freqs) - 1) &lt; 0.001, sum(uniform_freqs)</span>
    <span class="n">bin_dict</span><span class="p">[</span><span class="s1">&#39;uniform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="n">uniform_edges</span><span class="p">,</span> <span class="s1">&#39;freqs&#39;</span><span class="p">:</span> <span class="n">uniform_freqs</span><span class="p">,</span> <span class="s1">&#39;densities&#39;</span><span class="p">:</span> <span class="n">densities</span><span class="p">,</span> <span class="s1">&#39;widths&#39;</span><span class="p">:</span> <span class="n">bin_widths</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">bin_dict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_MLE_fit_plot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">stn</span><span class="p">):</span>
    <span class="n">test_fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>  

    <span class="c1"># plot empirical (discrete) distributions using linear and log binning</span>
    <span class="n">b</span><span class="o">=</span><span class="mi">8</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">_bit_log&#39;</span>
    <span class="n">bin_edges</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">log_bin_edges</span><span class="p">,</span> <span class="n">log_freqs</span> <span class="o">=</span> <span class="n">compute_discrete_distributions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">stn</span><span class="p">)</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">top</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">],</span> 
                  <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="w"> </span><span class="si">}</span><span class="s1">bits linear bins&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Sunset10</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">log_bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">log_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">top</span><span class="o">=</span><span class="n">log_freqs</span><span class="p">,</span> 
                  <span class="n">bottom</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">],</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1"> bits log bins&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Sunset10</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> 
                  <span class="n">line_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

    <span class="c1"># fit and plot a lognormal distribution</span>
    <span class="n">ln_shape</span><span class="p">,</span> <span class="n">ln_loc</span><span class="p">,</span> <span class="n">ln_scale</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">],</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Fixing location to 0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">ln_mle_pdf</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ln_shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">ln_scale</span><span class="p">)</span>

    <span class="c1"># fit and plot an exponential distribution</span>
    <span class="n">ex_loc</span><span class="p">,</span> <span class="n">ex_scale</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">],</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ex_mle_pdf</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">ex_scale</span><span class="p">)</span>

    <span class="n">test_fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ln_mle_pdf</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;LN MLE pdf&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ex_mle_pdf</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;EXP MLE pdf&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.6</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;top_right&#39;</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">click_policy</span><span class="o">=</span><span class="s1">&#39;hide&#39;</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text{Mean Daily Flow } [m^3/s]$$&#39;</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$P(X)$$&#39;</span>
    <span class="n">test_fig</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">test_fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_fig</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_logspace_bins</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create linearly spaced bins in log space over the range of `data`.&quot;&quot;&quot;</span>
    <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">log_min</span><span class="p">,</span> <span class="n">log_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">min_val</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">max_val</span><span class="p">)</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">log_min</span><span class="p">,</span> <span class="n">log_max</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bin_edges</span>

<span class="k">def</span> <span class="nf">calculate_probabilities</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the probabilities of data falling into each bin given `bin_edges`.&quot;&quot;&quot;</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="n">counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># Normalize to get probabilities</span>
    <span class="k">return</span> <span class="n">probabilities</span>

<span class="k">def</span> <span class="nf">aggregate_probabilities</span><span class="p">(</span><span class="n">high_res_probs</span><span class="p">,</span> <span class="n">high_res_bins</span><span class="p">,</span> <span class="n">low_res_bins</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregate high-resolution probabilities to match low-resolution bins.</span>
<span class="sd">    This will sum the high_res_probs that fall within each low-res bin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">low_res_probs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">low_res_bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Find indices of high-resolution bins that fall within the current low-res bin</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">high_res_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">low_res_bins</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">high_res_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">low_res_bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Sum probabilities within the range</span>
        <span class="n">low_res_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">high_res_probs</span><span class="p">[</span><span class="n">indices</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">low_res_probs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute_kl_divergence</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute KL divergence between two probability distributions `p` and `q`.&quot;&quot;&quot;</span>
    <span class="c1"># Avoid division by zero and log of zero by adding a small epsilon</span>
    <span class="c1"># epsilon = 1e-10</span>
    <span class="c1"># p = np.maximum(p, epsilon)</span>
    <span class="c1"># q = np.maximum(q, epsilon)</span>
    <span class="n">kl_divergence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="n">q</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">kl_divergence</span>
    
<span class="k">def</span> <span class="nf">fit_continuous_distributions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;simulate the target using the parametric MLE parameters from the proxy&quot;&quot;&quot;</span>
    <span class="c1"># fit and plot a lognormal distribution</span>
    <span class="n">ln_shape</span><span class="p">,</span> <span class="n">ln_loc</span><span class="p">,</span> <span class="n">ln_scale</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Fixing location to 0</span>
    <span class="n">ex_loc</span><span class="p">,</span> <span class="n">ex_scale</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kp</span> <span class="o">=</span> <span class="n">fit_kappa4_mle</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># kp = constrained_optimization(data)</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">bw_method</span><span class="o">=</span><span class="s1">&#39;scott&#39;</span><span class="p">)</span>

    <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span><span class="c1"># + [np.inf]</span>
    <span class="n">ln_cdf_vals</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">ln_shape</span><span class="p">,</span> 
                              <span class="n">loc</span><span class="o">=</span><span class="n">ln_loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">ln_scale</span><span class="p">)</span>
    <span class="n">expon_cdf_vals</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">ex_loc</span><span class="p">,</span> 
                               <span class="n">scale</span><span class="o">=</span><span class="n">ex_scale</span><span class="p">)</span>
    <span class="n">kappa4_cdf_vals</span> <span class="o">=</span> <span class="n">kappa4</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">kp</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">],</span> <span class="n">kp</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span>
                                 <span class="n">loc</span><span class="o">=</span><span class="n">kp</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">kp</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">])</span>
    
    <span class="c1"># Compute the KDE-based CDF at the evaluation points</span>
    <span class="n">kde_cdf_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kde</span><span class="o">.</span><span class="n">integrate_box_1d</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xi</span><span class="p">))</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">])</span>
    
    <span class="n">p_sim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">p_sim</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_LN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ln_cdf_vals</span><span class="p">)</span>
    <span class="n">p_sim</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_EXP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">expon_cdf_vals</span><span class="p">)</span>
    <span class="n">p_sim</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_KP4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">kappa4_cdf_vals</span><span class="p">)</span>
    <span class="n">p_sim</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_KDE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">kde_cdf_vals</span><span class="p">)</span>
    <span class="c1"># normalize the distributions </span>
    <span class="n">p_sim</span> <span class="o">/=</span> <span class="n">p_sim</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># make sure all distributions sum to 1</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">p_sim</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">p_sim</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">bin_midpoints</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1"># replace the last bin midpoint with half the previous bin&#39;s width</span>
    <span class="c1"># because our right bin edge is np.inf</span>
    <span class="c1"># right_bin_midpoint = edges[-2] + (edges[-2] - edges[-3]) / 2.0</span>
    <span class="c1"># bin_midpoints[-1] = right_bin_midpoint</span>
    <span class="n">p_sim</span><span class="p">[</span><span class="s1">&#39;bin_midpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_midpoints</span>
    <span class="k">return</span> <span class="n">p_sim</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_quantization_comparison</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">stn</span><span class="p">):</span>
    <span class="n">test_fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>  

    <span class="c1"># plot empirical (discrete) distributions using linear and log binning</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">]:</span>
        <span class="n">clr</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">_bit_log&#39;</span>
        <span class="n">bin_edges</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">log_bin_edges</span><span class="p">,</span> <span class="n">log_freqs</span> <span class="o">=</span> <span class="n">compute_discrete_distributions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">stn</span><span class="p">)</span>
        <span class="n">test_fig</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">log_bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">log_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">top</span><span class="o">=</span><span class="n">log_freqs</span><span class="p">,</span> 
                      <span class="n">bottom</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">],</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1"> bits log bins&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">clr</span><span class="p">,</span> 
                      <span class="n">line_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># fit and plot a lognormal distribution</span>
    <span class="n">ln_shape</span><span class="p">,</span> <span class="n">ln_loc</span><span class="p">,</span> <span class="n">ln_scale</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">],</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Fixing location to 0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">ln_mle_pdf</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ln_shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">ln_scale</span><span class="p">)</span>

    <span class="n">kld_test</span> <span class="o">=</span> <span class="n">kl_divergence_between_quantizations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">stn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;KLd between </span><span class="si">{</span><span class="n">b1</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">b2</span><span class="si">}</span><span class="s1"> bit quantizations = </span><span class="si">{</span><span class="n">kld_test</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># fit and plot an exponential distribution</span>
    <span class="n">ex_loc</span><span class="p">,</span> <span class="n">ex_scale</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">],</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ex_mle_pdf</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">ex_scale</span><span class="p">)</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ln_mle_pdf</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;LN MLE pdf&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ex_mle_pdf</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;EXP MLE pdf&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.6</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;top_right&#39;</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">click_policy</span><span class="o">=</span><span class="s1">&#39;hide&#39;</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text{Mean Daily Flow } [m^3/s]$$&#39;</span>
    <span class="n">test_fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$P(X)$$&#39;</span>
    <span class="n">test_fig</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">test_fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_fig</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quantization_noise_results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">binning_method</span><span class="o">=</span><span class="s1">&#39;log&#39;</span>
<span class="k">for</span> <span class="n">stn</span> <span class="ow">in</span> <span class="n">filtered_stns</span><span class="p">:</span>
    <span class="n">test_df</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">get_timeseries_data</span><span class="p">(</span><span class="n">stn</span><span class="p">)</span>
    <span class="n">test_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">stn</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_bs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_bs</span><span class="p">:</span>
        <span class="n">high_res_probs</span><span class="p">,</span> <span class="n">b1_bin_dict</span><span class="p">,</span> <span class="n">b2_bin_dict</span> <span class="o">=</span> <span class="n">remap_low_to_high_resolution</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">test_bs</span><span class="p">),</span> <span class="n">which_binning</span><span class="o">=</span><span class="n">binning_method</span><span class="p">)</span>
        <span class="n">continuous_b1</span> <span class="o">=</span> <span class="n">fit_continuous_distributions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b1_bin_dict</span><span class="p">[</span><span class="n">binning_method</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">])</span>
        <span class="n">continuous_b2</span> <span class="o">=</span> <span class="n">fit_continuous_distributions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b2_bin_dict</span><span class="p">[</span><span class="n">binning_method</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">])</span>
        <span class="c1"># print(continuous_b1)</span>
        <span class="c1"># print(continuous_b2)</span>
        <span class="c1"># print(asdf)</span>
        <span class="n">quantization_noise_results</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kl_divergence_between_quantizations</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">test_bs</span><span class="p">),</span> <span class="n">stn</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_bs</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_stns</span><span class="p">)</span><span class="si">}</span><span class="s1"> completed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">line</span> <span class="mi">16</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span>     <span class="n">continuous_b2</span> <span class="o">=</span> <span class="n">fit_continuous_distributions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b2_bin_dict</span><span class="p">[</span><span class="n">binning_method</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>     <span class="c1"># print(continuous_b1)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="c1"># print(continuous_b2)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="c1"># print(asdf)</span>
<span class="ne">---&gt; </span><span class="mi">16</span>     <span class="n">quantization_noise_results</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kl_divergence_between_quantizations</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">test_bs</span><span class="p">),</span> <span class="n">stn</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_bs</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

<span class="nn">Cell In[13], line 16,</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span>     <span class="n">continuous_b2</span> <span class="o">=</span> <span class="n">fit_continuous_distributions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b2_bin_dict</span><span class="p">[</span><span class="n">binning_method</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>     <span class="c1"># print(continuous_b1)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="c1"># print(continuous_b2)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="c1"># print(asdf)</span>
<span class="ne">---&gt; </span><span class="mi">16</span>     <span class="n">quantization_noise_results</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kl_divergence_between_quantizations</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">test_bs</span><span class="p">),</span> <span class="n">stn</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_bs</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

<span class="ne">NameError</span>: name &#39;kl_divergence_between_quantizations&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">quantization_noise_results</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">test_bs</span><span class="p">)</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">qn_fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mf">98.5</span><span class="p">]:</span>
    <span class="n">bounds</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">qn_df</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">test_bs</span><span class="p">]</span>
<span class="n">bounds</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">test_bs</span>
<span class="n">qn_fig</span><span class="o">.</span><span class="n">varea</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">test_bs</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="mf">2.5</span><span class="p">],</span> <span class="n">y2</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="mf">98.5</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;95% CI&#39;</span><span class="p">)</span>
<span class="n">qn_fig</span><span class="o">.</span><span class="n">varea</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">test_bs</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">y2</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="mi">75</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;IQR&#39;</span><span class="p">)</span>
<span class="n">qn_fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">test_bs</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="mi">50</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">qn_fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$$\text{Noise [bits/sample]}$$&quot;</span>
<span class="n">qn_fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$$\text{Dictionary Size (b)} [2^b = \text{N symbols}]$$&quot;</span>
<span class="n">qn_fig</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">qn_fig</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">qn_fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stn</span> <span class="o">=</span> <span class="n">filtered_stns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">get_timeseries_data</span><span class="p">(</span><span class="n">stn</span><span class="p">)</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">plot_quantization_comparison</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">stn</span><span class="p">)</span>

<span class="n">show</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">export_png</span>

<span class="n">test_stn</span> <span class="o">=</span> <span class="n">filtered_stns</span>
<span class="k">for</span> <span class="n">stn</span> <span class="ow">in</span> <span class="n">filtered_stns</span><span class="p">:</span>
    <span class="n">output_folder</span> <span class="o">=</span> <span class="s1">&#39;MLE_plots&#39;</span>
    <span class="n">plot_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s2">_LN_and_expon_fits.png&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plot_fpath</span><span class="p">):</span>
        <span class="k">continue</span>
    <span class="n">test_df</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">get_timeseries_data</span><span class="p">(</span><span class="n">stn</span><span class="p">)</span>
    <span class="n">test_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">stn</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">test_df</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="c1"># print(f&#39;X range is {minx:.1f} to {maxx:.1f} cms&#39;)</span>
    <span class="c1"># print(&#39;&#39;)</span>
    
    <span class="n">test_fig</span> <span class="o">=</span> <span class="n">create_MLE_fit_plot</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">stn</span><span class="p">)</span>
    
    <span class="n">export_png</span><span class="p">(</span><span class="n">test_fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">plot_fpath</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">stn</span> <span class="ow">in</span> <span class="n">filtered_stns</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">get_timeseries_data</span><span class="p">(</span><span class="n">stn</span><span class="p">)</span>
    <span class="n">ln_shape</span><span class="p">,</span> <span class="n">ln_loc</span><span class="p">,</span> <span class="n">ln_scale</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">],</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">expon_loc</span><span class="p">,</span> <span class="n">expon_scale</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">],</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># kh, kk, k_loc, k_scale = fit_kappa4_mle(df[stn])</span>
    <span class="c1"># kh, kk, k_loc, k_scale = constrained_optimization(df[stn])</span>
    <span class="n">attr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ln_shape&#39;</span><span class="p">,</span> <span class="s1">&#39;ln_loc&#39;</span><span class="p">,</span> <span class="s1">&#39;ln_scale&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ln_shape</span><span class="p">,</span> <span class="n">ln_loc</span><span class="p">,</span> <span class="n">ln_scale</span><span class="p">)</span>
    <span class="n">attr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;expon_loc&#39;</span><span class="p">,</span> <span class="s1">&#39;expon_scale&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">expon_loc</span><span class="p">,</span> <span class="n">expon_scale</span><span class="p">)</span>
    <span class="c1"># attr_df.loc[attr_df[&#39;official_id&#39;] == stn, [&#39;kappa_h&#39;, &#39;kappa_k&#39;, &#39;kappa_loc&#39;, &#39;kappa_scale&#39;]] = (kh, kk, k_loc, k_scale)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_bs</span><span class="p">:</span>
        <span class="n">attr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">_quantization_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kl_divergence_between_quantizations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">test_bs</span><span class="p">),</span> <span class="n">stn</span><span class="p">)</span> 
    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">150</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    ...</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_stns</span><span class="p">)</span><span class="si">}</span><span class="s1"> completed.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span> <span class="n">line</span> <span class="mi">12</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="c1"># attr_df.loc[attr_df[&#39;official_id&#39;] == stn, [&#39;kappa_h&#39;, &#39;kappa_k&#39;, &#39;kappa_loc&#39;, &#39;kappa_scale&#39;]] = (kh, kk, k_loc, k_scale)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_bs</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">12</span>     <span class="n">attr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">_quantization_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kl_divergence_between_quantizations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">test_bs</span><span class="p">),</span> <span class="n">stn</span><span class="p">)</span> 
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">150</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

<span class="ne">NameError</span>: name &#39;kl_divergence_between_quantizations&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert the MLE parameters to dicts for easier access</span>
<span class="n">ln_dict</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">attr_df</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;official_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;ln_shape&#39;</span><span class="p">,</span> <span class="s1">&#39;ln_loc&#39;</span><span class="p">,</span> <span class="s1">&#39;ln_scale&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">expon_dict</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">attr_df</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;official_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;expon_loc&#39;</span><span class="p">,</span> <span class="s1">&#39;expon_scale&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># kappa_dict = (</span>
<span class="c1">#     attr_df</span>
<span class="c1">#     .set_index(&#39;official_id&#39;)[[&#39;kappa_a&#39;, &#39;kappa_b&#39;, &#39;kappa_c&#39;, &#39;kappa_d&#39;]]</span>
<span class="c1">#     .to_dict(orient=&#39;index&#39;)</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compute-the-noise-added-to-a-discriminant-value-due-to-assuming-an-error-distribution-as-a-prior">
<h2>Compute the “noise” added to a discriminant value due to assuming an error distribution as a prior<a class="headerlink" href="#compute-the-noise-added-to-a-discriminant-value-due-to-assuming-an-error-distribution-as-a-prior" title="Link to this heading">#</a></h2>
<p>Rating curve uncertainty is a hard problem in hydrology.  Instead of treating daily flow observations as discrete measurements with the fixed (often overzealous) precision that it is published by governing agencies, we can assume some kind of basic error model and test how much the error model distorts the information in the distribution.  In other words, how much noise/uncertainty is added for any model error.</p>
<p>Below we’ll test a range of uniform error distributions as models for the observations.  We’ll take an example streamflow record, and we’ll quantize it to a range of dictionary sizes in two ways.  One way is to bin the observations as they are, we’ll refer to this as the “deterministic” treatment.  The second way is to apply a series of error distribution models, calling it the “stochastic treatment”, and bin the observations by counting the fraction of the observation distribution interval that lies in each bin.  In other words, we’ll count partial observations in proportion to where they fall over the binning intervals as opposed to counting a whole observation based on the interval alone.</p>
<p>The quantization will take in a bitrate <span class="math notranslate nohighlight">\(b\)</span>, and it will divide and log-transform the measured interval <span class="math notranslate nohighlight">\((\log(x_\text{min}),\log(x_\text{max}))\)</span> into <span class="math notranslate nohighlight">\(2^b\)</span> log-spaced bins.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_log_uniform_bins</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stn</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">):</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">bitrate</span>
    <span class="n">min_log_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">max_log_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="c1"># set the bin edges to be evenly spaced between the</span>
    <span class="c1"># observed range of the proxy/donor series</span>
    <span class="c1"># np.digitize will assign 0 for out-of-range values at left</span>
    <span class="c1"># and n_bins + 1 for out-of-range values at right</span>
    <span class="n">log_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="n">min_log_val</span><span class="p">,</span>
        <span class="n">max_log_val</span><span class="p">,</span>
        <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># convert back to linear space</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">log_bin_edges</span><span class="p">]</span>

    <span class="c1"># there should be n_bins edges which define n_bins - 1 bins</span>
    <span class="c1"># this is to reserve 2 bin for out-of-range values to the right</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">bin_edges</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">apply_error_to_observations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stn</span><span class="p">,</span> <span class="n">bitrate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="n">min_q</span><span class="p">,</span> <span class="n">max_q</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-9</span>
    <span class="k">assert</span> <span class="n">min_q</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="c1"># use equal width bins in log10 space</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">compute_log_uniform_bins</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stn</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">)</span>
    <span class="c1"># df[f&#39;{bitrate}_bits_quantized&#39;] = np.digitize(df[stn], bin_edges)</span>
    <span class="n">fractional_obs_counts</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">error_adjusted_fractional_bin_counts</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">),</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">error_factor</span><span class="o">=</span><span class="n">error</span>
    <span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">error</span><span class="p">)</span><span class="si">}</span><span class="s1">_error&#39;</span>
    <span class="n">count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">bitrate</span><span class="p">))</span>
    <span class="n">count_df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count_df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fractional_obs_counts</span>
    <span class="n">count_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">n_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">count_df</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
    <span class="c1"># normalize p_obs and p_sim</span>
    <span class="k">return</span> <span class="n">count_df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">n_obs</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_unadjusted_counts</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stn</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">):</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">compute_log_uniform_bins</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stn</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_simple_</span><span class="si">{</span><span class="n">bitrate</span><span class="si">}</span><span class="s1">bits&#39;</span>
    <span class="n">df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">stn</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">)</span>
    <span class="c1"># print(df[[stn, f&#39;{stn}_quantized_{bitrate}bits&#39;]].head(4))</span>
    <span class="c1"># count the occurrences of each quantized value</span>
    <span class="c1"># the &quot;simulated&quot; series is the proxy/donor series</span>
    <span class="c1"># and the &quot;observed&quot; series is the target location</span>
    <span class="n">obs_count_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">bitrate</span><span class="p">))</span>
    <span class="n">count_df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count_df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="n">obs_count_df</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span>
    <span class="n">count_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">adjusted_p</span> <span class="o">=</span> <span class="n">count_df</span> <span class="o">/</span> <span class="n">obs_count_df</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">adjusted_p</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_distortion</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">stn</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">inputs</span>
    <span class="n">simple_frequencies</span> <span class="o">=</span> <span class="n">compute_unadjusted_counts</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stn</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">error_adjusted_frequencies</span> <span class="o">=</span> <span class="n">apply_error_to_observations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stn</span><span class="p">,</span> <span class="n">bitrate</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
    <span class="c1"># compute KL divergence between the simple and adjusted frequencies</span>
    <span class="c1"># this represents the distortion due to the error model</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">simple_frequencies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">error_adjusted_frequencies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">distortion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">simple_frequencies</span><span class="p">)</span>
    <span class="n">distortion</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_frequencies</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">simple_frequencies</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">error_adjusted_frequencies</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="n">kld</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">distortion</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stn</span><span class="p">,</span> <span class="n">kld</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">err</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="pairwise-processing">
<h2>Pairwise Processing<a class="headerlink" href="#pairwise-processing" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>

<span class="c1"># generate all combinations of pairs of station ids</span>
<span class="n">id_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">filtered_stns</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">id_pairs</span><span class="p">)</span><span class="si">}</span><span class="s1"> unique pairings in the dataset&#39;</span><span class="p">)</span>
<span class="c1"># shuffle the pairs to make testing smaller batches more robust</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">id_pairs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> There are 877150 unique pairings in the dataset
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the attributes file with catchment geometries</span>
<span class="n">geom_file</span> <span class="o">=</span> <span class="s1">&#39;BCUB_watershed_attributes_updated.geojson&#39;</span>
<span class="n">bcub_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">geom_file</span><span class="p">))</span>
<span class="n">bcub_gdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set a revision date for the results output file</span>
<span class="n">revision_date</span> <span class="o">=</span> <span class="s1">&#39;20241112&#39;</span>

<span class="c1"># how many pairs to compute in each batch</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="c1"># batch_size = 10</span>

<span class="c1"># # what percentage of 365 observations in a year counts as a &quot;complete&quot; year</span>
<span class="c1"># completeness_threshold = 0.9</span>
<span class="c1"># min_observations = 365 * 0.9</span>

<span class="c1"># station pairs with less than min_years concurrent years of data are excluded (for concurrent analysis),</span>
<span class="c1"># stations with less than min_years are excluded (for non-concurrent analysis),</span>
<span class="n">min_years</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#[2, 3, 4, 5, 10]</span>

<span class="c1"># a prior is applied to q in the form of a uniform array of 10**c pseudo-counts &quot;c&quot;</span>
<span class="c1"># this prior is used to test the effect of the choice of prior on the model</span>
<span class="n">pseudo_counts</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="c1"># set the number of quantization levels to test, equal to 2^bitrate</span>
<span class="n">bitrates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span>

<span class="c1"># Preload all records into a dictionary for fast lookup</span>
<span class="n">records_dict</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;official_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">input_batch_generator</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id_pairs_filtered</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> 
                          <span class="n">min_years</span><span class="p">,</span> <span class="n">use_partial_counts</span><span class="p">):</span>
    <span class="n">batch_inputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">id_pairs_filtered</span><span class="p">:</span>
        
        <span class="n">proxy_dict</span> <span class="o">=</span> <span class="n">records_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">target_dict</span> <span class="o">=</span> <span class="n">records_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">proxy_dict</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span>
        <span class="n">target_dict</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>

        <span class="k">assert</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">proxy_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">proxy_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">target_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">target_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        
        <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">proxy_dict</span><span class="p">,</span> <span class="n">target_dict</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> 
            <span class="n">min_years</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">batch_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">batch_inputs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data/&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulated_parametric_probabilities</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;simulate the target using the parametric MLE parameters from the proxy&quot;&quot;&quot;</span>
    <span class="n">ln_params</span> <span class="o">=</span> <span class="n">ln_dict</span><span class="p">[</span><span class="n">proxy</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
    <span class="n">exp_params</span> <span class="o">=</span> <span class="n">expon_dict</span><span class="p">[</span><span class="n">proxy</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
    <span class="n">p_sim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>

    <span class="c1"># ln_pdf_vals = lognorm.pdf(bin_midpoints, ln_params[&#39;ln_shape&#39;], loc=ln_params[&#39;ln_loc&#39;], scale=ln_params[&#39;ln_scale&#39;])</span>
    <span class="c1"># expon_pdf_vals = expon.pdf(bin_midpoints, loc=ln_params[&#39;ln_loc&#39;], scale=ln_params[&#39;ln_scale&#39;])</span>
    <span class="n">ln_cdf_vals</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">ln_params</span><span class="p">[</span><span class="s1">&#39;ln_shape&#39;</span><span class="p">],</span> 
                              <span class="n">loc</span><span class="o">=</span><span class="n">ln_params</span><span class="p">[</span><span class="s1">&#39;ln_loc&#39;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">ln_params</span><span class="p">[</span><span class="s1">&#39;ln_scale&#39;</span><span class="p">])</span>
    <span class="n">expon_cdf_vals</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">ln_params</span><span class="p">[</span><span class="s1">&#39;ln_loc&#39;</span><span class="p">],</span> 
                               <span class="n">scale</span><span class="o">=</span><span class="n">ln_params</span><span class="p">[</span><span class="s1">&#39;ln_scale&#39;</span><span class="p">])</span>
    <span class="c1"># p_sim[target.ln_pdf_label] = ln_pdf_vals</span>
    <span class="n">p_sim</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">ln_cdf_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ln_cdf_vals</span><span class="p">)</span>
    <span class="c1"># p_sim[target.expon_pdf_label] = expon_pdf_vals</span>
    <span class="n">p_sim</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">expon_cdf_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">expon_cdf_vals</span><span class="p">)</span>

    <span class="c1"># normalize the distributions</span>
    <span class="n">p_sim</span> <span class="o">/=</span> <span class="n">p_sim</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">p_sim</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">p_sim</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">p_sim</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_KL_divergence</span><span class="p">(</span><span class="n">p_obs</span><span class="p">,</span> <span class="n">p_sim</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">concurrent_data</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes the Kullback-Leibler (KL) divergence between observed and simulated probability distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p_obs : np.ndarray</span>
<span class="sd">        The observed probability distribution.</span>
<span class="sd">    p_sim : pd.DataFrame</span>
<span class="sd">        A DataFrame containing the simulated probability distributions with different priors.</span>
<span class="sd">    bitrate : int</span>
<span class="sd">        The number of bits used for quantizing the observed series.</span>
<span class="sd">    concurrent_data : bool</span>
<span class="sd">        A flag indicating whether the data is concurrent.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.Series</span>
<span class="sd">        A series containing the sum of KL divergences for each simulated distribution.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        If any value in the simulated distribution is zero, which should not happen due to the addition of pseudo-counts.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The function computes the KL divergence for each simulated distribution in `p_sim`.</span>
<span class="sd">    - It ensures that the probability distributions sum to 1 before computing the divergence.</span>
<span class="sd">    - If the data is concurrent, the divergence labels are prefixed with &#39;dkl_concurrent_&#39;, otherwise &#39;dkl_nonconcurrent_&#39;.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; p_obs = np.array([0.2, 0.3, 0.5])</span>
<span class="sd">    &gt;&gt;&gt; p_sim = pd.DataFrame({&#39;q_post_0.1R&#39;: [0.1, 0.4, 0.5], &#39;q_post_0.5R&#39;: [0.2, 0.3, 0.5]})</span>
<span class="sd">    &gt;&gt;&gt; bitrate = 3</span>
<span class="sd">    &gt;&gt;&gt; concurrent_data = True</span>
<span class="sd">    &gt;&gt;&gt; sum_dkl = process_KL_divergence(p_obs, p_sim, bitrate, concurrent_data)</span>
<span class="sd">    &gt;&gt;&gt; print(sum_dkl)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dkl_df = uf.compute_kl_divergence(p_obs, p_sim, bitrate, concurrent_data)</span>

    <span class="c1"># explicitly set data types before vectorization</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">bitrate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">small_val_flags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p_sim</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;dkl_nonconcurrent_&quot;</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">concurrent_data</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;dkl_concurrent_&quot;</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_sim</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> 
        <span class="n">small_values</span> <span class="o">=</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="n">epsilon</span>
        <span class="n">kld_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kld_array</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">q</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">kld_array</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">small_values</span><span class="p">):</span>
            <span class="n">small_val_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">n_flags</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">small_val_flags</span><span class="p">)</span>
    <span class="n">q_flag</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">n_flags</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">q_flag</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">small_val_flags</span><span class="p">)</span>
        <span class="c1"># print(q_flag)</span>
    <span class="n">sum_dkl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">sum_dkl</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;negative or zero dkl&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sum_dkl</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;negative or zero dkl&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sum_dkl</span><span class="p">,</span> <span class="n">q_flag</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_divergences</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">p_obs</span><span class="p">,</span> <span class="n">p_sim</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">concurrent_data</span><span class="p">):</span>
    <span class="n">dkl</span><span class="p">,</span> <span class="n">q_flag</span> <span class="o">=</span> <span class="n">process_KL_divergence</span><span class="p">(</span><span class="n">p_obs</span><span class="p">,</span> <span class="n">p_sim</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">concurrent_data</span><span class="p">)</span>

    <span class="c1"># p = p_obs</span>
    <span class="c1"># q = p_sim[&quot;q_sim_no_prior&quot;].values</span>
    <span class="c1"># q_uniform = p_sim[&quot;q_uniform&quot;].values</span>
    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dkl</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;small_q_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_flag</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_probabilities</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">concurrent_data</span><span class="p">,</span> <span class="c1">#pseudo_counts, p_errors</span>
<span class="p">):</span>
    <span class="n">target</span><span class="o">.</span><span class="n">obs_quantized_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;obs_quantized_</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bitrate</span><span class="si">}</span><span class="s2">b&quot;</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sim_quantized_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sim_quantized_</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bitrate</span><span class="si">}</span><span class="s2">b&quot;</span>
    <span class="c1"># compute the bin edges based on equal width in log space</span>
    <span class="c1"># binning should be done on the &#39;ground truth&#39; observed range (the target)</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">uniform_log_bins</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">)</span>

    <span class="n">simple_count_df</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">compute_unadjusted_counts</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">concurrent_data</span>
    <span class="p">)</span>
    
    <span class="n">p_obs</span> <span class="o">=</span> <span class="n">simple_count_df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">obs_label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">simple_count_df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">obs_label</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># add a uniformly distributed error to the observed data</span>
    <span class="c1"># and compute probabilities from partial observation counts</span>
    <span class="c1"># where counts are divided based on the proportion of the bin</span>
    <span class="c1"># that the measurement error falls within</span>
    <span class="n">fractional_obs_counts</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">error_adjusted_fractional_bin_counts</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">obs_label</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">),</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">error_factor</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">)</span>
    <span class="n">fractional_sim_counts</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">error_adjusted_fractional_bin_counts</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">sim_label</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">),</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">error_factor</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">)</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="c1"># print(f&#39; {t1-t0:.2f}s to process fractional bin counts&#39;)</span>

    <span class="n">partial_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">bitrate</span><span class="p">))</span>
    <span class="n">partial_count_df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">obs_label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">partial_count_df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">sim_label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">partial_count_df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">obs_label</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fractional_obs_counts</span>
    <span class="n">partial_count_df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">sim_label</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fractional_sim_counts</span>
    <span class="n">partial_count_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">partial_count_df</span> <span class="o">/=</span> <span class="n">partial_count_df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="c1"># Check if the sums are close enough to 1 within a tolerance of 0.001</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">partial_count_df</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">partial_count_df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">p_sim</span> <span class="o">=</span> <span class="n">simulated_parametric_probabilities</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">p_obs</span><span class="p">,</span> <span class="n">p_sim</span><span class="p">,</span> <span class="n">bin_edges</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>    
    <span class="p">(</span>
        <span class="n">proxy</span><span class="p">,</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">bitrate</span><span class="p">,</span>
        <span class="n">min_concurrent_years</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">inputs</span>
    
    <span class="n">proxy_id</span><span class="p">,</span> <span class="n">target_id</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span>
    <span class="n">bitrate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bitrate</span><span class="p">)</span>

    <span class="c1"># create a result dict object for tracking results of the batch comparison</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;proxy&quot;</span><span class="p">:</span> <span class="n">proxy_id</span><span class="p">,</span>
        <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
        <span class="s2">&quot;bitrate&quot;</span><span class="p">:</span> <span class="n">bitrate</span><span class="p">,</span>
        <span class="s2">&quot;min_concurrent_years&quot;</span><span class="p">:</span> <span class="n">min_concurrent_years</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">station_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;proxy&quot;</span><span class="p">:</span> <span class="n">proxy</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">}</span>

    <span class="c1"># check if the polygons are nested</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;nested_catchments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">check_if_nested</span><span class="p">(</span>
        <span class="n">proxy</span><span class="p">,</span> <span class="n">target</span>
    <span class="p">)</span>

    <span class="c1"># for stn in pair:</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">Station</span><span class="p">(</span><span class="n">station_info</span><span class="p">[</span><span class="s2">&quot;proxy&quot;</span><span class="p">])</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">Station</span><span class="p">(</span><span class="n">station_info</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
    <span class="n">target</span><span class="o">.</span><span class="n">ln_pdf_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_sim_lognorm_pdf&#39;</span>
    <span class="n">target</span><span class="o">.</span><span class="n">ln_cdf_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_sim_lognorm_cdf&#39;</span>
    <span class="n">target</span><span class="o">.</span><span class="n">expon_pdf_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_sim_expon_pdf&#39;</span>
    <span class="n">target</span><span class="o">.</span><span class="n">expon_cdf_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_sim_expon_cdf&#39;</span>

    <span class="c1"># compute spatial distance</span>
    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">station_info</span><span class="p">[</span><span class="s2">&quot;proxy&quot;</span><span class="p">][</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="p">,</span>
        <span class="n">station_info</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># compute the distance between catchment centroids (km)</span>
    <span class="n">centroid_distance</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;centroid_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">centroid_distance</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">centroid_distance</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">drainage_area_km2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No drainage area for </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">drainage_area_km2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No drainage area for </span><span class="si">{</span><span class="n">proxy_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Retrieve the data for both stations</span>
    <span class="c1"># this is all data, including non-concurrent</span>
    <span class="n">adf</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">retrieve_nonconcurrent_data</span><span class="p">(</span><span class="n">proxy_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>

    <span class="k">assert</span> <span class="o">~</span><span class="n">adf</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="s2">&quot;No data returned.&quot;</span>

    <span class="k">for</span> <span class="n">stn</span> <span class="ow">in</span> <span class="p">[</span><span class="n">proxy</span><span class="p">,</span> <span class="n">target</span><span class="p">]:</span>
        <span class="n">adf</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">transform_and_jitter</span><span class="p">(</span><span class="n">adf</span><span class="p">,</span> <span class="n">stn</span><span class="p">)</span>

    <span class="c1"># simulate flow at the target based on equal unit area runoff scaling</span>
    <span class="n">adf</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">sim_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">adf</span><span class="p">[</span><span class="n">proxy</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">target</span><span class="o">.</span><span class="n">drainage_area_km2</span> <span class="o">/</span> <span class="n">proxy</span><span class="o">.</span><span class="n">drainage_area_km2</span>
    <span class="p">)</span>

    <span class="c1"># filter for the concurrent data</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">adf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">proxy_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;num_concurrent_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">num_complete_concurrent_years</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">num_complete_concurrent_years</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">count_complete_years</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">proxy_id</span><span class="p">)</span>
        
    <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">proxy_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">adf</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">proxy</span><span class="o">.</span><span class="n">n_obs</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">proxy_id</span><span class="p">],</span> <span class="n">counts</span><span class="p">[</span><span class="n">target_id</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;proxy_n_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="n">n_obs</span>
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;target_n_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">n_obs</span>
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;proxy_frac_concurrent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="n">proxy</span><span class="o">.</span><span class="n">n_obs</span>
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;target_frac_concurrent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span><span class="o">.</span><span class="n">n_obs</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">proxy_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">target_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Zero observations.  Skipping.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># process the PMFs and divergences for concurrent data</span>
    <span class="c1"># using a range of uniform priors via pseudo counts</span>
    <span class="k">if</span> <span class="n">num_complete_concurrent_years</span> <span class="o">&gt;</span> <span class="n">min_concurrent_years</span><span class="p">:</span>
        <span class="c1"># df is concurrent data, so the results</span>
        <span class="c1"># are updating concurrent data here</span>
        <span class="c1"># df, proxy, target, bitrate, concurrent_data, partial_counts, pseudo_counts</span>
        <span class="n">concurrent_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">p_obs</span><span class="p">,</span> <span class="n">p_sim</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">process_probabilities</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">concurrent_data</span><span class="p">,</span> <span class="c1">#pseudo_counts, p_errors</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">&gt;</span> <span class="mi">365</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">&gt;</span> <span class="mi">365</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">):</span>
        <span class="c1"># adf is all data (includes non-concurrent), so the results</span>
        <span class="c1"># are updated if both series meet the minimum length</span>
        <span class="n">concurrent_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">p_obs</span><span class="p">,</span> <span class="n">p_sim</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">process_probabilities</span><span class="p">(</span>
            <span class="n">adf</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">concurrent_data</span><span class="p">,</span><span class="c1"># pseudo_counts, p_errors</span>
        <span class="p">)</span>
        
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_divergences</span><span class="p">(</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">p_obs</span><span class="p">,</span> <span class="n">p_sim</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">concurrent_data</span>
    <span class="p">)</span>

    <span class="n">noise</span> <span class="o">=</span> <span class="n">process_noise</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">p_obs</span><span class="p">,</span> <span class="n">p_sim</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">concurrent_data</span><span class="p">)</span>
    <span class="c1"># result[&#39;underspecified_model_flag&#39;] = underspecified_flag</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the &#39;process&#39; variable is here so jupyter doesn&#39;t go computing </span>
<span class="c1"># a million rows per iteration when the book is built for pushing to github pages.</span>
<span class="n">reordered_bitrates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span>
<span class="n">process</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">partial_counts</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">process</span><span class="p">:</span> 
    <span class="k">for</span> <span class="n">bitrate</span> <span class="ow">in</span> <span class="n">reordered_bitrates</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing pairs at </span><span class="si">{</span><span class="n">bitrate</span><span class="si">}</span><span class="s1"> bits quantization (partial counts=</span><span class="si">{</span><span class="n">partial_counts</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">results_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;KL_parametric_fits_</span><span class="si">{</span><span class="n">bitrate</span><span class="si">}</span><span class="s1">bits_</span><span class="si">{</span><span class="n">revision_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>

        <span class="n">out_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data/&#39;</span><span class="p">,</span> <span class="s1">&#39;parametric_divergence_test&#39;</span><span class="p">,</span> <span class="n">results_fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_fpath</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">id_pairs</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">id_pairs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">),</span> <span class="n">n_batches</span><span class="p">)</span>
        <span class="n">n_pairs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_pairs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;    Processing </span><span class="si">{</span><span class="n">n_pairs</span><span class="si">}</span><span class="s2"> pairs in </span><span class="si">{</span><span class="n">n_batches</span><span class="si">}</span><span class="s2"> batches at </span><span class="si">{</span><span class="n">bitrate</span><span class="si">}</span><span class="s2"> bits&quot;</span>
        <span class="p">)</span>
        <span class="n">batch_no</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">batch_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="c1"># error_df = error_model_df[error_model_df[&#39;bitrate&#39;] == bitrate].copy()</span>
        <span class="k">for</span> <span class="n">batch_ids</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting batch </span><span class="si">{</span><span class="n">batch_no</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span><span class="si">}</span><span class="s1"> processing.&#39;</span><span class="p">)</span>
            <span class="n">batch_fname</span> <span class="o">=</span> <span class="n">results_fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_batch_</span><span class="si">{</span><span class="n">batch_no</span><span class="si">:</span><span class="s1">03d</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>
            <span class="n">batch_output_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">batch_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">batch_output_fpath</span><span class="p">):</span>
                <span class="n">batch_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_output_fpath</span><span class="p">)</span>
                <span class="n">batch_no</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            
            <span class="c1"># define the input array for multiprocessing</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">input_batch_generator</span><span class="p">(</span><span class="n">bcub_gdf</span><span class="p">,</span> <span class="n">batch_ids</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span>
                     <span class="n">min_years</span><span class="p">,</span> <span class="n">partial_counts</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_batch</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

            <span class="n">batch_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Empty batch.  Skipping&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch_result</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">batch_output_fpath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_result</span><span class="p">)</span><span class="si">}</span><span class="s2"> new results to file.&quot;</span><span class="p">)</span>
            
            <span class="n">batch_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_output_fpath</span><span class="p">)</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_ids</span><span class="p">)</span><span class="si">}</span><span class="s1"> pairs at (</span><span class="si">{</span><span class="n">bitrate</span><span class="si">}</span><span class="s1"> bits) in </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>
            <span class="n">batch_no</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Concatenating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> batch files.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">all_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">batch_files</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_fpath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_fpath</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">batch_files</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_results</span><span class="p">)</span><span class="si">}</span><span class="s1"> results to </span><span class="si">{</span><span class="n">out_fpath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    No new results to write to file.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Link to this heading">#</a></h2>
<span class="target" id="id1"></span></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="1c_Process_Target_Variables.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Process Target Variables</p>
      </div>
    </a>
    <a class="right-next"
       href="2_Methods.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Methods</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-underspecification-assuming-a-prior-on-q">Dealing with Underspecification: Assuming a Prior on Q</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-the-noise-added-to-a-discriminant-value-due-to-assuming-an-error-distribution-as-a-prior">Compute the “noise” added to a discriminant value due to assuming an error distribution as a prior</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pairwise-processing">Pairwise Processing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dan Kovacek
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>