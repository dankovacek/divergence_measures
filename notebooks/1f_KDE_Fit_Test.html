
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>KL Divergence Estimation &#8212; On the predictability of f-divergence measures from catchment attributes</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/1f_KDE_Fit_Test';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="On the predictability of f-divergence measures from catchment attributes - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="On the predictability of f-divergence measures from catchment attributes - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="1_data.html">Data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="1a_Update_Catchment_Bounds.html">Update HYSETS Catchment Polygons</a></li>
<li class="toctree-l2"><a class="reference internal" href="1b_Update_Catchment_Attributes.html">Update HYSETS Catchment Attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="1c_Process_Target_Variables.html">Process Target Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="1d_Fit_Continuous_Distributions.html">Fit Continuous Distributions</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="2_Methods.html">Methods</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="2a_Predictability_of_Mean_Runoff.html">Predict Mean Runoff</a></li>
<li class="toctree-l2"><a class="reference internal" href="2b_Predictability_of_entropy.html">Predict (Shannon) Entropy</a></li>
<li class="toctree-l2"><a class="reference internal" href="2c_Predictability_of_KL_divergence.html">Predict Kullback-Leibler (KL) Divergence</a></li>
<li class="toctree-l2"><a class="reference internal" href="2d_Predictability_of_TVD.html">Predict Total Variation Distance (TVD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="2e_Predictability_of_EMD.html">Predict Earth Mover’s Distance (EMD)</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="Discussion.html">Discussion</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/dankovacek/divergence_measures" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/dankovacek/divergence_measures/issues/new?title=Issue%20on%20page%20%2Fnotebooks/1f_KDE_Fit_Test.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/1f_KDE_Fit_Test.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>KL Divergence Estimation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">KL Divergence Estimation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">Methodology</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-cases">Problem Cases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pairwise-processing">Pairwise Processing</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#code-graveyard">Code Graveyard</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">entropy</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">data_processing_functions</span> <span class="k">as</span> <span class="nn">dpf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="c1"># visualize the catchment centroid locations</span>
<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span><span class="p">,</span> <span class="n">show</span>
<span class="kn">from</span> <span class="nn">bokeh.layouts</span> <span class="kn">import</span> <span class="n">gridplot</span>
<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">output_notebook</span><span class="p">,</span> <span class="n">export_png</span><span class="p">,</span> <span class="n">reset_output</span>
<span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">ColumnDataSource</span><span class="p">,</span> <span class="n">LinearAxis</span><span class="p">,</span> <span class="n">Range1d</span><span class="p">,</span> <span class="n">Div</span>
<span class="kn">from</span> <span class="nn">bokeh.palettes</span> <span class="kn">import</span> <span class="n">Colorblind</span><span class="p">,</span> <span class="n">Sunset10</span>
<span class="n">output_notebook</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">lognorm</span><span class="p">,</span> <span class="n">expon</span><span class="p">,</span> <span class="n">kappa4</span><span class="p">,</span> <span class="n">gaussian_kde</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">kl_div</span><span class="p">,</span> <span class="n">gammaln</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>

<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax.scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span> <span class="k">as</span> <span class="n">jkde</span>

<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">    <style>
        .bk-notebook-logo {
            display: block;
            width: 20px;
            height: 20px;
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAOkSURBVDiNjZRtaJVlGMd/1/08zzln5zjP1LWcU9N0NkN8m2CYjpgQYQXqSs0I84OLIC0hkEKoPtiH3gmKoiJDU7QpLgoLjLIQCpEsNJ1vqUOdO7ppbuec5+V+rj4ctwzd8IIbbi6u+8f1539dt3A78eXC7QizUF7gyV1fD1Yqg4JWz84yffhm0qkFqBogB9rM8tZdtwVsPUhWhGcFJngGeWrPzHm5oaMmkfEg1usvLFyc8jLRqDOMru7AyC8saQr7GG7f5fvDeH7Ej8CM66nIF+8yngt6HWaKh7k49Soy9nXurCi1o3qUbS3zWfrYeQDTB/Qj6kX6Ybhw4B+bOYoLKCC9H3Nu/leUTZ1JdRWkkn2ldcCamzrcf47KKXdAJllSlxAOkRgyHsGC/zRday5Qld9DyoM4/q/rUoy/CXh3jzOu3bHUVZeU+DEn8FInkPBFlu3+nW3Nw0mk6vCDiWg8CeJaxEwuHS3+z5RgY+YBR6V1Z1nxSOfoaPa4LASWxxdNp+VWTk7+4vzaou8v8PN+xo+KY2xsw6une2frhw05CTYOmQvsEhjhWjn0bmXPjpE1+kplmmkP3suftwTubK9Vq22qKmrBhpY4jvd5afdRA3wGjFAgcnTK2s4hY0/GPNIb0nErGMCRxWOOX64Z8RAC4oCXdklmEvcL8o0BfkNK4lUg9HTl+oPlQxdNo3Mg4Nv175e/1LDGzZen30MEjRUtmXSfiTVu1kK8W4txyV6BMKlbgk3lMwYCiusNy9fVfvvwMxv8Ynl6vxoByANLTWplvuj/nF9m2+PDtt1eiHPBr1oIfhCChQMBw6Aw0UulqTKZdfVvfG7VcfIqLG9bcldL/+pdWTLxLUy8Qq38heUIjh4XlzZxzQm19lLFlr8vdQ97rjZVOLf8nclzckbcD4wxXMidpX30sFd37Fv/GtwwhzhxGVAprjbg0gCAEeIgwCZyTV2Z1REEW8O4py0wsjeloKoMr6iCY6dP92H6Vw/oTyICIthibxjm/DfN9lVz8IqtqKYLUXfoKVMVQVVJOElGjrnnUt9T9wbgp8AyYKaGlqingHZU/uG2NTZSVqwHQTWkx9hxjkpWDaCg6Ckj5qebgBVbT3V3NNXMSiWSDdGV3hrtzla7J+duwPOToIg42ChPQOQjspnSlp1V+Gjdged7+8UN5CRAV7a5EdFNwCjEaBR27b3W890TE7g24NAP/mMDXRWrGoFPQI9ls/MWO2dWFAar/xcOIImbbpA3zgAAAABJRU5ErkJggg==);
        }
    </style>
    <div>
        <a href="https://bokeh.org" target="_blank" class="bk-notebook-logo"></a>
        <span id="fd0a0202-ebab-48bc-bdbf-13cf0541ebcb">Loading BokehJS ...</span>
    </div>
</div><script type="application/javascript">'use strict';
(function(root) {
  function now() {
    return new Date();
  }

  const force = true;

  if (typeof root._bokeh_onload_callbacks === "undefined" || force === true) {
    root._bokeh_onload_callbacks = [];
    root._bokeh_is_loading = undefined;
  }

const JS_MIME_TYPE = 'application/javascript';
  const HTML_MIME_TYPE = 'text/html';
  const EXEC_MIME_TYPE = 'application/vnd.bokehjs_exec.v0+json';
  const CLASS_NAME = 'output_bokeh rendered_html';

  /**
   * Render data to the DOM node
   */
  function render(props, node) {
    const script = document.createElement("script");
    node.appendChild(script);
  }

  /**
   * Handle when an output is cleared or removed
   */
  function handleClearOutput(event, handle) {
    function drop(id) {
      const view = Bokeh.index.get_by_id(id)
      if (view != null) {
        view.model.document.clear()
        Bokeh.index.delete(view)
      }
    }

    const cell = handle.cell;

    const id = cell.output_area._bokeh_element_id;
    const server_id = cell.output_area._bokeh_server_id;

    // Clean up Bokeh references
    if (id != null) {
      drop(id)
    }

    if (server_id !== undefined) {
      // Clean up Bokeh references
      const cmd_clean = "from bokeh.io.state import curstate; print(curstate().uuid_to_server['" + server_id + "'].get_sessions()[0].document.roots[0]._id)";
      cell.notebook.kernel.execute(cmd_clean, {
        iopub: {
          output: function(msg) {
            const id = msg.content.text.trim()
            drop(id)
          }
        }
      });
      // Destroy server and session
      const cmd_destroy = "import bokeh.io.notebook as ion; ion.destroy_server('" + server_id + "')";
      cell.notebook.kernel.execute(cmd_destroy);
    }
  }

  /**
   * Handle when a new output is added
   */
  function handleAddOutput(event, handle) {
    const output_area = handle.output_area;
    const output = handle.output;

    // limit handleAddOutput to display_data with EXEC_MIME_TYPE content only
    if ((output.output_type != "display_data") || (!Object.prototype.hasOwnProperty.call(output.data, EXEC_MIME_TYPE))) {
      return
    }

    const toinsert = output_area.element.find("." + CLASS_NAME.split(' ')[0]);

    if (output.metadata[EXEC_MIME_TYPE]["id"] !== undefined) {
      toinsert[toinsert.length - 1].firstChild.textContent = output.data[JS_MIME_TYPE];
      // store reference to embed id on output_area
      output_area._bokeh_element_id = output.metadata[EXEC_MIME_TYPE]["id"];
    }
    if (output.metadata[EXEC_MIME_TYPE]["server_id"] !== undefined) {
      const bk_div = document.createElement("div");
      bk_div.innerHTML = output.data[HTML_MIME_TYPE];
      const script_attrs = bk_div.children[0].attributes;
      for (let i = 0; i < script_attrs.length; i++) {
        toinsert[toinsert.length - 1].firstChild.setAttribute(script_attrs[i].name, script_attrs[i].value);
        toinsert[toinsert.length - 1].firstChild.textContent = bk_div.children[0].textContent
      }
      // store reference to server id on output_area
      output_area._bokeh_server_id = output.metadata[EXEC_MIME_TYPE]["server_id"];
    }
  }

  function register_renderer(events, OutputArea) {

    function append_mime(data, metadata, element) {
      // create a DOM node to render to
      const toinsert = this.create_output_subarea(
        metadata,
        CLASS_NAME,
        EXEC_MIME_TYPE
      );
      this.keyboard_manager.register_events(toinsert);
      // Render to node
      const props = {data: data, metadata: metadata[EXEC_MIME_TYPE]};
      render(props, toinsert[toinsert.length - 1]);
      element.append(toinsert);
      return toinsert
    }

    /* Handle when an output is cleared or removed */
    events.on('clear_output.CodeCell', handleClearOutput);
    events.on('delete.Cell', handleClearOutput);

    /* Handle when a new output is added */
    events.on('output_added.OutputArea', handleAddOutput);

    /**
     * Register the mime type and append_mime function with output_area
     */
    OutputArea.prototype.register_mime_type(EXEC_MIME_TYPE, append_mime, {
      /* Is output safe? */
      safe: true,
      /* Index of renderer in `output_area.display_order` */
      index: 0
    });
  }

  // register the mime type if in Jupyter Notebook environment and previously unregistered
  if (root.Jupyter !== undefined) {
    const events = require('base/js/events');
    const OutputArea = require('notebook/js/outputarea').OutputArea;

    if (OutputArea.prototype.mime_types().indexOf(EXEC_MIME_TYPE) == -1) {
      register_renderer(events, OutputArea);
    }
  }
  if (typeof (root._bokeh_timeout) === "undefined" || force === true) {
    root._bokeh_timeout = Date.now() + 5000;
    root._bokeh_failed_load = false;
  }

  const NB_LOAD_WARNING = {'data': {'text/html':
     "<div style='background-color: #fdd'>\n"+
     "<p>\n"+
     "BokehJS does not appear to have successfully loaded. If loading BokehJS from CDN, this \n"+
     "may be due to a slow or bad network connection. Possible fixes:\n"+
     "</p>\n"+
     "<ul>\n"+
     "<li>re-rerun `output_notebook()` to attempt to load from CDN again, or</li>\n"+
     "<li>use INLINE resources instead, as so:</li>\n"+
     "</ul>\n"+
     "<code>\n"+
     "from bokeh.resources import INLINE\n"+
     "output_notebook(resources=INLINE)\n"+
     "</code>\n"+
     "</div>"}};

  function display_loaded(error = null) {
    const el = document.getElementById("fd0a0202-ebab-48bc-bdbf-13cf0541ebcb");
    if (el != null) {
      const html = (() => {
        if (typeof root.Bokeh === "undefined") {
          if (error == null) {
            return "BokehJS is loading ...";
          } else {
            return "BokehJS failed to load.";
          }
        } else {
          const prefix = `BokehJS ${root.Bokeh.version}`;
          if (error == null) {
            return `${prefix} successfully loaded.`;
          } else {
            return `${prefix} <b>encountered errors</b> while loading and may not function as expected.`;
          }
        }
      })();
      el.innerHTML = html;

      if (error != null) {
        const wrapper = document.createElement("div");
        wrapper.style.overflow = "auto";
        wrapper.style.height = "5em";
        wrapper.style.resize = "vertical";
        const content = document.createElement("div");
        content.style.fontFamily = "monospace";
        content.style.whiteSpace = "pre-wrap";
        content.style.backgroundColor = "rgb(255, 221, 221)";
        content.textContent = error.stack ?? error.toString();
        wrapper.append(content);
        el.append(wrapper);
      }
    } else if (Date.now() < root._bokeh_timeout) {
      setTimeout(() => display_loaded(error), 100);
    }
  }

  function run_callbacks() {
    try {
      root._bokeh_onload_callbacks.forEach(function(callback) {
        if (callback != null)
          callback();
      });
    } finally {
      delete root._bokeh_onload_callbacks
    }
    console.debug("Bokeh: all callbacks have finished");
  }

  function load_libs(css_urls, js_urls, callback) {
    if (css_urls == null) css_urls = [];
    if (js_urls == null) js_urls = [];

    root._bokeh_onload_callbacks.push(callback);
    if (root._bokeh_is_loading > 0) {
      console.debug("Bokeh: BokehJS is being loaded, scheduling callback at", now());
      return null;
    }
    if (js_urls == null || js_urls.length === 0) {
      run_callbacks();
      return null;
    }
    console.debug("Bokeh: BokehJS not loaded, scheduling load and callback at", now());
    root._bokeh_is_loading = css_urls.length + js_urls.length;

    function on_load() {
      root._bokeh_is_loading--;
      if (root._bokeh_is_loading === 0) {
        console.debug("Bokeh: all BokehJS libraries/stylesheets loaded");
        run_callbacks()
      }
    }

    function on_error(url) {
      console.error("failed to load " + url);
    }

    for (let i = 0; i < css_urls.length; i++) {
      const url = css_urls[i];
      const element = document.createElement("link");
      element.onload = on_load;
      element.onerror = on_error.bind(null, url);
      element.rel = "stylesheet";
      element.type = "text/css";
      element.href = url;
      console.debug("Bokeh: injecting link tag for BokehJS stylesheet: ", url);
      document.body.appendChild(element);
    }

    for (let i = 0; i < js_urls.length; i++) {
      const url = js_urls[i];
      const element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error.bind(null, url);
      element.async = false;
      element.src = url;
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
  };

  function inject_raw_css(css) {
    const element = document.createElement("style");
    element.appendChild(document.createTextNode(css));
    document.body.appendChild(element);
  }

  const js_urls = ["https://cdn.bokeh.org/bokeh/release/bokeh-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-gl-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.6.0.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-3.6.0.min.js"];
  const css_urls = [];

  const inline_js = [    function(Bokeh) {
      Bokeh.set_log_level("info");
    },
function(Bokeh) {
    }
  ];

  function run_inline_js() {
    if (root.Bokeh !== undefined || force === true) {
      try {
            for (let i = 0; i < inline_js.length; i++) {
      inline_js[i].call(root, root.Bokeh);
    }

      } catch (error) {display_loaded(error);throw error;
      }if (force === true) {
        display_loaded();
      }} else if (Date.now() < root._bokeh_timeout) {
      setTimeout(run_inline_js, 100);
    } else if (!root._bokeh_failed_load) {
      console.log("Bokeh: BokehJS failed to load within specified timeout.");
      root._bokeh_failed_load = true;
    } else if (force !== true) {
      const cell = $(document.getElementById("fd0a0202-ebab-48bc-bdbf-13cf0541ebcb")).parents('.cell').data().cell;
      cell.output_area.append_execute_result(NB_LOAD_WARNING)
    }
  }

  if (root._bokeh_is_loading === 0) {
    console.debug("Bokeh: BokehJS loaded, going straight to plotting");
    run_inline_js();
  } else {
    load_libs(css_urls, js_urls, function() {
      console.debug("Bokeh: BokehJS plotting callback run at", now());
      run_inline_js();
    });
  }
}(window));</script></div>
</div>
<section id="kl-divergence-estimation">
<h1>KL Divergence Estimation<a class="headerlink" href="#kl-divergence-estimation" title="Link to this heading">#</a></h1>
<p>[&#64;perez_KL_estimation] presents a method for estimatingKL divergence directly from empirical CDFs, avoiding explicit parametric or nonparametric distribution fitting. The proposed method uses intervals defined by data points to approximate probability mass, bypassing problems introduced by intermediate distribution fitting like the noise introduced by bandwidth selection in kernel density estimation (KDE), parametric distribution fitting, or discrete quantization.  However, the problem of incomplete support coverage is not resolved, requiring methodological choices that introduce additional noise to handle unsupported regions.</p>
</section>
<section id="methodology">
<h1>Methodology<a class="headerlink" href="#methodology" title="Link to this heading">#</a></h1>
<ol class="arabic simple">
<li><p>Draw pairs of catchments with minimum 1 year concurrent record.</p></li>
<li><p>Let the first be the target catchmnet and the second the proxy catchment.</p></li>
<li><p>Runoff in the target catchment is simulated by assuming runoff on a unit area basis is equal to the proxy catchment.</p></li>
<li><p>The estimated target catchment flow is given by <span class="math notranslate nohighlight">\(f(x) = \frac{A_\text{target}}{A_\text{proxy}} * x_\text{proxy}\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(Q(x)\)</span> represent the runoff distribution of the proxy catchment,</p></li>
<li><p><span class="math notranslate nohighlight">\(Q(x)\)</span> represents the approximation of the “ground truth” distribution <span class="math notranslate nohighlight">\(P(x)\)</span> of the target runoff.</p></li>
<li><p>Fit a distribution to <span class="math notranslate nohighlight">\(X_\text{proxy}\)</span> by Kernel Density Estimation.</p></li>
<li><p>For the KDE, set the bandwidth using “Scott’s Rule”, given by <span class="math notranslate nohighlight">\(\sigma_\text{target} \cdot n^{-1/5}\)</span> where n is the sample size and <span class="math notranslate nohighlight">\(\sigma_\text{target}\)</span> is the sample standard deviation.</p></li>
<li><p>Set a quantization of 6 bits and compute the cdf of the t</p></li>
</ol>
</section>
<section id="problem-cases">
<h1>Problem Cases<a class="headerlink" href="#problem-cases" title="Link to this heading">#</a></h1>
<p><img alt="image.png" src="notebooks/attachment:ced28635-393b-40fd-aea3-270f4b5da802.png" /></p>
<p>The plot above shows a common issue with using KDE to estimate KL divergence where the approximation <span class="math notranslate nohighlight">\(Q(x)\)</span> does not provide support coverage of <span class="math notranslate nohighlight">\(P(x)\)</span>. Mismatch combined with steep cutoffs means the bandwidth is increased until <span class="math notranslate nohighlight">\(Q &gt; 0\)</span> for all <span class="math notranslate nohighlight">\(P &gt; 0\)</span>. To provide support coverage to the far left of the target distribution requires smoothing that represents significant distortion noise, diminishing the divergence.  (what is the concurrent period?)  The KL divergence in this case is small compared to the distortion rate due to KDE fit.</p>
<p>Another point about this is the precision.  The quantization dictates how much of the precision is retained from the original signal.  If the level of precision is not justifiable from measurement uncertainty, what does the KL divergence, or any measure from the class of f-divergences, represent?</p>
<p><img alt="image.png" src="notebooks/attachment:6ef5e849-b28f-4070-8b2c-bc3c10ac8a33.png" /></p>
<p>In the figure above, note how the <span class="math notranslate nohighlight">\(D_\text{KL}(P_d||Q_d)\)</span> decreases with increasing bitrate. This represents a lack of robustness in the estimate.</p>
<p>If we want to compare the KL divergence across <em>discrete</em> bitrates, we must account for how much information is added by the prior.  We can’t simply add a constant Dirichlet prior of <span class="math notranslate nohighlight">\(\text{Dirichlet}(\alpha + n_i)\)</span> since this adds <span class="math notranslate nohighlight">\(N\cdot \alpha\)</span> total counts to the distribution.  Dividing by the number of bins regularizes the information added (the total number of counts).  One effect of this adjustment is that the prior is now much smaller, which tends to cause heavier penalties where <span class="math notranslate nohighlight">\(q_i\)</span> was otherwise zero.  However this is offset by the probabilities being spread out more anyway.</p>
<p>If the ultimate goal is to represent floating point precision data losslessly. then we should pick a precision or a quantization that aligns with something practical.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import streamflow record timeseries</span>
<span class="n">attributes_filename</span> <span class="o">=</span> <span class="s1">&#39;BCUB_watershed_attributes_updated.csv&#39;</span>
<span class="n">attributes_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">attributes_filename</span><span class="p">)</span>
<span class="n">attr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">attributes_fpath</span><span class="p">)</span>
<span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="c1"># df.columns</span>
<span class="n">filtered_stns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>

<span class="c1"># load the attributes file with catchment geometries</span>
<span class="n">geom_file</span> <span class="o">=</span> <span class="s1">&#39;BCUB_watershed_attributes_updated.geojson&#39;</span>
<span class="n">bcub_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">geom_file</span><span class="p">))</span>
<span class="n">bcub_gdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_kl_divergence</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="c1"># compute DKL(Q||Q_post), or the divergence</span>
    <span class="c1"># of the posterior from the likelihood due to the prior</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">q</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="pairwise-processing">
<h1>Pairwise Processing<a class="headerlink" href="#pairwise-processing" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a new output filename </span>
<span class="n">attributes_filename</span> <span class="o">=</span> <span class="s1">&#39;BCUB_watershed_attributes_updated.csv&#39;</span>
<span class="n">attributes_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">attributes_filename</span><span class="p">)</span>
<span class="n">attr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">attributes_fpath</span><span class="p">)</span>
<span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="c1"># df.columns</span>
<span class="n">filtered_stns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate all combinations of pairs of station ids</span>
<span class="n">id_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">filtered_stns</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">id_pairs</span><span class="p">)</span><span class="si">}</span><span class="s1"> unique pairings in the dataset&#39;</span><span class="p">)</span>
<span class="c1"># shuffle the pairs to make testing smaller batches more robust</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">id_pairs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> There are 877150 unique pairings in the dataset
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set a revision date for the results output file</span>
<span class="n">revision_date</span> <span class="o">=</span> <span class="s1">&#39;20241125&#39;</span>

<span class="c1"># how many pairs to compute in each batch</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="c1"># batch_size = 10</span>

<span class="c1"># # what percentage of 365 observations in a year counts as a &quot;complete&quot; year</span>
<span class="c1"># completeness_threshold = 0.9</span>
<span class="c1"># min_observations = 365 * 0.9</span>

<span class="c1"># station pairs with less than min_years concurrent years of data are excluded (for concurrent analysis),</span>
<span class="c1"># stations with less than min_years are excluded (for non-concurrent analysis),</span>
<span class="n">min_years</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#[2, 3, 4, 5, 10]</span>

<span class="c1"># a prior is applied to q in the form of a uniform array of 10**c pseudo-counts &quot;c&quot;</span>
<span class="c1"># this prior is used to test the effect of the choice of prior on the model</span>
<span class="n">pseudo_counts</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="c1"># set the number of quantization levels to test, equal to 2^bitrate</span>
<span class="n">bitrates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span>

<span class="c1"># Preload all records into a dictionary for fast lookup</span>
<span class="n">records_dict</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;official_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data/&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">input_batch_generator</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id_pairs_filtered</span><span class="p">,</span> <span class="n">min_years</span><span class="p">,</span> <span class="n">use_partial_counts</span><span class="p">,</span> <span class="n">bitrates</span><span class="p">):</span>
    <span class="n">batch_inputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">id_pairs_filtered</span><span class="p">:</span>
        
        <span class="n">proxy_dict</span> <span class="o">=</span> <span class="n">records_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">target_dict</span> <span class="o">=</span> <span class="n">records_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">proxy_dict</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span>
        <span class="n">target_dict</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>

        <span class="k">assert</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">proxy_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">proxy_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">target_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">target_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        
        <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">proxy_dict</span><span class="p">,</span> <span class="n">target_dict</span><span class="p">,</span> <span class="n">min_years</span><span class="p">,</span> <span class="n">bitrates</span><span class="p">]</span>
        <span class="n">batch_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">batch_inputs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_hist_and_log_edges</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">):</span>
    <span class="n">min_log_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">max_log_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># set the bin edges to be evenly spaced between the</span>
    <span class="c1"># observed range of the proxy/donor series</span>
    <span class="n">log_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="n">min_log_val</span><span class="p">,</span>
        <span class="n">max_log_val</span><span class="p">,</span>
        <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">log_bin_edges</span><span class="p">]</span>
    <span class="n">log_counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">log_counts</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0001</span>
    <span class="k">return</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">bin_edges</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_cdf_kde_histogram</span><span class="p">(</span><span class="n">hist_targ</span><span class="p">,</span> <span class="n">hist_proxy</span><span class="p">,</span> <span class="n">edges_target</span><span class="p">,</span> <span class="n">edges_proxy</span><span class="p">,</span> <span class="n">kde_target</span><span class="p">,</span> <span class="n">kde_proxy_og</span><span class="p">,</span> <span class="n">kde_proxy_approx</span><span class="p">,</span> <span class="n">kde_proxy_adj</span><span class="p">,</span> 
                                    <span class="n">kde_kld</span><span class="p">,</span> <span class="n">kde_proxy_bias</span><span class="p">,</span> <span class="n">kde_adj_proxy_bias</span><span class="p">,</span> <span class="n">kde_target_bias</span><span class="p">,</span> <span class="n">n_years</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot and save the empirical CDF, KDE fit, and histogram using Bokeh.</span>
<span class="sd">    Args:</span>
<span class="sd">        x: 1D array of x values (for KDE and CDF).</span>
<span class="sd">        cdf: Empirical CDF values corresponding to x.</span>
<span class="sd">        kde: KDE fit values corresponding to x.</span>
<span class="sd">        hist: Histogram heights.</span>
<span class="sd">        bins: Bin edges for the histogram.</span>
<span class="sd">        output_path: Path to save the PNG output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">bin_midpts_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges_target</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges_target</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Create the figure</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;b = </span><span class="si">{</span><span class="n">bitrate</span><span class="si">}</span><span class="s2"> bits quantization (2^</span><span class="si">{</span><span class="n">bitrate</span><span class="si">}</span><span class="s2"> symbol dictionary)&quot;</span><span class="p">,</span>
              <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bitrate</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">bitrate</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bitrate</span> <span class="o">==</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Pr(x)&quot;</span>

    <span class="c1"># Add histogram (muted grey with alpha)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="n">hist_targ</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">edges_target</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">edges_target</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
           <span class="n">fill_color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s2">&quot;Obs.&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="n">hist_proxy</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">edges_proxy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">edges_proxy</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
           <span class="n">fill_color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s2">&quot;Sim.&quot;</span><span class="p">)</span>

    <span class="c1"># Add KDE lines series </span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">bin_midpts_target</span><span class="p">,</span> <span class="n">kde_target</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s2">&quot;P̂(x)&quot;</span><span class="p">,)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">bin_midpts_target</span><span class="p">,</span> <span class="n">kde_proxy_approx</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
           <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s2">&quot;Q̂(x)&quot;</span><span class="p">,)</span>

    <span class="c1"># Add original proxy PDF</span>
    <span class="n">bin_midpts_proxy</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges_proxy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges_proxy</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">bin_midpts_proxy</span><span class="p">,</span> <span class="n">kde_proxy_og</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> 
           <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s2">&quot;Q(x)&quot;</span><span class="p">,)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">bin_midpts_proxy</span><span class="p">,</span> <span class="n">kde_proxy_adj</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> 
           <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s2">&quot;Q̂_adj(x)&quot;</span><span class="p">,)</span>

    <span class="c1"># Style the legend</span>
    <span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;top_right&quot;</span>
    <span class="c1"># p.legend.title = &quot;Legend&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_missing_coverage_probability_mass</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="n">min_x2</span><span class="p">,</span> <span class="n">max_x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">missing_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x1</span> <span class="o">&lt;</span> <span class="n">min_x2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">missing_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">max_x2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">left_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">missing_left</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">right_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">missing_right</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">left_mass</span><span class="p">,</span> <span class="n">right_mass</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_discrete_kl_divergence</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    X1 is observed.</span>
<span class="sd">    X2 is simulated.</span>
<span class="sd">    </span>
<span class="sd">    We want to know the extra description, the memory overhead, </span>
<span class="sd">    resulting from mis-estimated frequencies of an approximate Q</span>
<span class="sd">    when the &quot;ground truth&quot; is P.</span>
<span class="sd">    The ground truth P should reflect the binning &quot;optimized for P&quot;, </span>
<span class="sd">    so it should represent the &quot;a posteriori&quot; frequencies.</span>
<span class="sd">    So then the simulated values should be binned according to </span>
<span class="sd">    a version of P where two edge bins are reserved for out-of-range </span>
<span class="sd">    simulated values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">P_hist</span><span class="p">,</span> <span class="n">P_edges</span> <span class="o">=</span> <span class="n">compute_hist_and_log_edges</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">b</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
    <span class="c1"># Q_hist, Q_edges = compute_hist_and_log_edges(x2, n_bins=int(2**b - 2))</span>
    
    <span class="c1"># digitize the target based on the proxy edges</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;obs_digitized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">P_edges</span><span class="p">)</span>
    <span class="c1"># digitize the proxy based on the &quot;ground truth&quot; edges</span>
    <span class="c1"># to see how the &quot;proxy model&quot; estimates the &quot;true&quot; frequences</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sim_digitized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">P_edges</span><span class="p">)</span>

    <span class="c1"># count the occurrences of each quantized value</span>
    <span class="c1"># the &quot;simulated&quot; series is the proxy/donor series</span>
    <span class="c1"># and the &quot;observed&quot; series is the target location</span>
    <span class="n">obs_count_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;obs_digitized&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">sim_count_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;sim_digitized&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">sim_col</span> <span class="o">=</span> <span class="n">sim_count_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">obs_col</span> <span class="o">=</span> <span class="n">obs_count_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">b</span><span class="p">))</span>
    <span class="n">count_df</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># divide the prior by the bitrate so that the same information is added across bitrates</span>
    <span class="n">count_df</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="n">b</span>

    <span class="c1"># note that the labels here don&#39;t matter</span>
    <span class="n">count_df</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">obs_count_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">count_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">count_df</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sim_count_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">count_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">count_df</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">count_df</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x2</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">q</span>
    <span class="n">kld_discrete</span> <span class="o">=</span> <span class="n">compute_kl_divergence</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kld_discrete</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">save_gridplot</span><span class="p">(</span><span class="n">plots</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">gridplot</span><span class="p">(</span><span class="n">plots</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">550</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">450</span><span class="p">)</span>
    <span class="c1"># Save as PNG</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">export_png</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up Bokeh output state</span>
        <span class="n">reset_output</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vectorized_kde_integration</span><span class="p">(</span><span class="n">kde_fit_object</span><span class="p">,</span> <span class="n">edges</span><span class="p">):</span>
    <span class="n">integrate_cdf</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">xi</span><span class="p">:</span> <span class="n">kde_fit_object</span><span class="o">.</span><span class="n">integrate_box_1d</span><span class="p">(</span><span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xi</span><span class="p">)))</span>
    <span class="n">cdf_values</span> <span class="o">=</span> <span class="n">integrate_cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges</span><span class="p">))</span>
    <span class="n">pmf_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cdf_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pmf_values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">adjust_kde_bandwidth</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">smoothing_factor</span><span class="o">=</span><span class="mf">1.01</span><span class="p">,</span> <span class="n">adjusted_bw</span><span class="o">=</span><span class="s1">&#39;scott&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjust the bandwidth of a Gaussian KDE by scaling Scott&#39;s bandwidth.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: 1D array of data points for KDE.</span>
<span class="sd">        factor: Scaling factor for the bandwidth (default is 1.0, i.e., no adjustment).</span>

<span class="sd">    Returns:</span>
<span class="sd">        proxy_kde: KDE object with adjusted bandwidth.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute Scott&#39;s bandwidth</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="n">adjusted_bw</span> <span class="o">==</span> <span class="s1">&#39;scott&#39;</span><span class="p">:</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># Scott&#39;s rule</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="n">adjusted_bw</span>

    <span class="c1"># Scale the bandwidth by the smoothing factor</span>
    <span class="k">return</span> <span class="n">smoothing_factor</span> <span class="o">*</span> <span class="n">bw</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_KDE_and_check_min_Qx</span><span class="p">(</span><span class="n">kde_fit</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">adjusted_bw</span><span class="o">=</span><span class="s1">&#39;scott&#39;</span><span class="p">,</span> <span class="n">min_q_allowed</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">modified_bw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that the smallest x1 (target value) probability mass evaluated</span>
<span class="sd">    on the proxy fit is greater than some minimum threshold </span>
<span class="sd">    (the purpose is to avoid dividing by zero later on -- just setting != 0 is not enough</span>
<span class="sd">    use KDE to estimate the pdf for the proxy / simulated values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">vectorized_kde_integration</span><span class="p">(</span><span class="n">kde_fit</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>

    <span class="c1"># min_probability_mass = np.nanmin(np.diff(np.array([kde_proxy_fit.integrate_box_1d(-np.inf, np.log10(xi)) for xi in edges_target])))</span>
    <span class="n">min_probability_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
    <span class="n">log_x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">adjusted_bw</span> <span class="o">==</span> <span class="s1">&#39;scott&#39;</span><span class="p">:</span>
        <span class="n">max_bw_exceeded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_bw_exceeded</span> <span class="o">=</span> <span class="n">adjusted_bw</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">log_x2</span><span class="p">)</span>
    <span class="c1"># recursively change the bandwidth until the smallest probability is </span>
    <span class="c1"># something we deem acceptable--this smooths the distribution</span>
    <span class="k">if</span> <span class="n">max_bw_exceeded</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    MAX BANDWIDTH EXCEEDED.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kde_fit</span><span class="p">,</span> <span class="n">max_bw_exceeded</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">min_probability_mass</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">adj_bw</span> <span class="o">=</span> <span class="n">adjust_kde_bandwidth</span><span class="p">(</span><span class="n">log_x2</span><span class="p">,</span> <span class="n">adjusted_bw</span><span class="o">=</span><span class="n">adjusted_bw</span><span class="p">)</span>
        <span class="c1"># print(f&#39;    min probability mass = {100*min_probability_mass:.3f}% adjusted bw to {adj_bw:.2f}&#39;)</span>
        <span class="n">kde_fit</span> <span class="o">=</span> <span class="n">jkde</span><span class="p">(</span><span class="n">log_x2</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">adj_bw</span><span class="p">)</span>
        
        <span class="c1"># recursively adjust the bandwidth</span>
        <span class="k">return</span> <span class="n">fit_KDE_and_check_min_Qx</span><span class="p">(</span>
            <span class="c1"># x1, x2, adjusted_bw=adj_bw, underspecified_kde=True</span>
            <span class="n">kde_fit</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">adjusted_bw</span><span class="o">=</span><span class="n">adj_bw</span><span class="p">,</span> <span class="n">modified_bw</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">kde_fit</span><span class="p">,</span> <span class="n">max_bw_exceeded</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">kl_divergence_convergence</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">n_complete_years</span><span class="p">,</span> <span class="n">bitrates</span><span class="p">,</span>
                              <span class="n">n_resamples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized estimation of KL divergence convergence using bootstrap resampling.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - x1, x2: Arrays of observations from target (posteriori observed) and proxy (simulated)</span>
<span class="sd">    - n_resamples: Number of bootstrap resamples.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - KL divergence estimate D_KL(P||Q).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;N=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> samples, (</span><span class="si">{</span><span class="n">n_complete_years</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> years)&#39;</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    
    <span class="c1"># use KDE to estimate the pdf for the target / true values</span>
    <span class="n">log_x1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">kde_target</span> <span class="o">=</span> <span class="n">jkde</span><span class="p">(</span><span class="n">log_x1</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    
    <span class="c1"># use KDE to estimate the pdf for the proxy / simulated values</span>
    <span class="n">log_x2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> 
    <span class="c1"># compute the baseline (unadjusted) proxy KDE PDF</span>
    <span class="n">kde_proxy_baseline</span> <span class="o">=</span> <span class="n">jkde</span><span class="p">(</span><span class="n">log_x2</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;n_concurrent_years&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_complete_years</span>
    <span class="c1"># compute the probability mass out of range (left and right separately)</span>
    <span class="n">missing_support_left</span><span class="p">,</span> <span class="n">missing_support_right</span> <span class="o">=</span> <span class="n">compute_missing_coverage_probability_mass</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;missing_support_coverage_PMF_left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_support_left</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;missing_support_coverage_PMF_right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_support_right</span>
    <span class="n">underspecified_kde</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">missing_support_left</span> <span class="o">+</span> <span class="n">missing_support_right</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
        <span class="n">underspecified_kde</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;underspecified_kde&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">underspecified_kde</span>
    <span class="n">plots</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kde_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bitrates</span><span class="p">:</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">b</span><span class="p">)</span>
        <span class="c1"># compute discrete distributions on 2**b - 2 bins so it is comparable</span>
        <span class="c1"># with the discrete KL divergence computation where we reserve 2 bins at the extremes</span>
        <span class="c1"># for simulations out of range of the &quot;ground truth&quot; distribution</span>
        <span class="n">hist_target</span><span class="p">,</span> <span class="n">edges_target</span> <span class="o">=</span> <span class="n">compute_hist_and_log_edges</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">)</span>
        <span class="n">hist_proxy</span><span class="p">,</span> <span class="n">edges_proxy</span> <span class="o">=</span> <span class="n">compute_hist_and_log_edges</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">)</span>

        <span class="c1"># compute the proxy KDE PDF with adjusted bandwidth </span>
        <span class="c1"># to provide support coverage of target </span>
        <span class="n">kde_proxy_approx</span><span class="p">,</span> <span class="n">max_bw_exceeded</span> <span class="o">=</span> <span class="n">fit_KDE_and_check_min_Qx</span><span class="p">(</span><span class="n">kde_proxy_baseline</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">edges_target</span><span class="p">)</span>

        <span class="c1"># compute the &quot;ground truth&quot; PMF </span>
        <span class="c1"># --&gt; this is P(x)</span>
        <span class="n">kde_target_pmf</span> <span class="o">=</span> <span class="n">vectorized_kde_integration</span><span class="p">(</span><span class="n">kde_target</span><span class="p">,</span> <span class="n">edges_target</span><span class="p">)</span>
        <span class="n">kde_target_pmf</span> <span class="o">/=</span> <span class="n">kde_target_pmf</span>
        
        <span class="c1"># compute the &quot;baseline&quot; proxy/observed PMF using the PROXY edges</span>
        <span class="n">kde_proxy_pmf_baseline</span> <span class="o">=</span> <span class="n">vectorized_kde_integration</span><span class="p">(</span><span class="n">kde_proxy_baseline</span><span class="p">,</span> <span class="n">edges_proxy</span><span class="p">)</span>
        <span class="n">kde_proxy_pmf_baseline</span> <span class="o">/=</span> <span class="n">kde_proxy_pmf_baseline</span>

        <span class="c1"># compute the &quot;approximate&quot; PMF from the adjusted fit on the TARGET edges</span>
        <span class="c1"># --&gt; this is Q(x)</span>
        <span class="k">if</span> <span class="n">max_bw_exceeded</span><span class="p">:</span>
            <span class="n">kde_proxy_pmf_approx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_bins</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">n_bins</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kde_proxy_pmf_approx</span> <span class="o">=</span> <span class="n">vectorized_kde_integration</span><span class="p">(</span><span class="n">kde_proxy_approx</span><span class="p">,</span> <span class="n">edges_target</span><span class="p">)</span>

        <span class="c1"># do not normalize the KDE since it would transfer out of range </span>
        <span class="c1"># probability mass into the target range </span>
        <span class="c1"># kde_target = kde_target / np.nansum(kde_target) </span>
        <span class="c1"># kde_proxy = kde_proxy / np.nansum(kde_proxy) </span>
        
        <span class="c1"># compute KL divergence between the observed (target, P(x)) and simulated (proxy, Q(x)) </span>
        <span class="c1"># THE PMFs COMPARED HERE MUST USE THE SAME EDGES</span>
        <span class="n">kde_kl_divergence</span> <span class="o">=</span> <span class="n">compute_kl_divergence</span><span class="p">(</span><span class="n">kde_target_pmf</span><span class="p">,</span> <span class="n">kde_proxy_pmf_approx</span><span class="p">)</span> 
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">_bit_kld_kde&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kde_kl_divergence</span>
    
        <span class="c1"># compute the &quot;approximate&quot; PMF from the ADJUSTED fit on the PROXY edges</span>
        <span class="c1"># this measures how much bias was added to the PMF in order to </span>
        <span class="c1"># provide complete support coverage to P(x)</span>
        <span class="c1"># kde_proxy_pmf_adj = np.diff(np.array([kde_proxy_approx.integrate_box_1d(-np.inf, np.log10(xi)) for xi in edges_proxy]))</span>
        <span class="n">kde_proxy_pmf_adj</span> <span class="o">=</span> <span class="n">vectorized_kde_integration</span><span class="p">(</span><span class="n">kde_proxy_approx</span><span class="p">,</span> <span class="n">edges_proxy</span><span class="p">)</span>
        <span class="n">proxy_adjusted_kde_bias</span> <span class="o">=</span> <span class="n">compute_kl_divergence</span><span class="p">(</span><span class="n">kde_proxy_pmf_baseline</span><span class="p">,</span> <span class="n">kde_proxy_pmf_adj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">proxy_adjusted_kde_bias</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">proxy_adjusted_kde_bias</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">proxy_adjusted_kde_bias</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Adjusted proxy KDE bias DKL is negative&quot;</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">_bit_kde_adjusted_proxy_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_adjusted_kde_bias</span>

        <span class="c1"># compute the representation bias from the discrete to baseline kde</span>
        <span class="n">kde_proxy_bias</span> <span class="o">=</span> <span class="n">compute_kl_divergence</span><span class="p">(</span><span class="n">hist_proxy</span><span class="p">,</span> <span class="n">kde_proxy_pmf_baseline</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">_bit_kde_baseline_proxy_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kde_proxy_bias</span>
        <span class="n">kde_target_bias</span> <span class="o">=</span> <span class="n">compute_kl_divergence</span><span class="p">(</span><span class="n">hist_target</span><span class="p">,</span> <span class="n">kde_target_pmf</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">_bit_kde_baseline_target_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kde_target_bias</span>

        <span class="n">kld_discrete</span> <span class="o">=</span> <span class="n">compute_discrete_kl_divergence</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">kde_results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kde_kl_divergence</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">kld_discrete</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">proxy_adjusted_kde_bias</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">kde_proxy_bias</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">kde_target_bias</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>

        <span class="c1"># don&#39;t plot above 10 bits as it doesn&#39;t show anything meaningful</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="c1"># Compute median and confidence intervals</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="n">plot_cdf_kde_histogram</span><span class="p">(</span><span class="n">hist_target</span><span class="p">,</span> <span class="n">hist_proxy</span><span class="p">,</span> <span class="n">edges_target</span><span class="p">,</span> <span class="n">edges_proxy</span><span class="p">,</span> 
                                            <span class="n">kde_target_pmf</span><span class="p">,</span> <span class="n">kde_proxy_pmf_baseline</span><span class="p">,</span> <span class="n">kde_proxy_pmf_approx</span><span class="p">,</span> <span class="n">kde_proxy_pmf_adj</span><span class="p">,</span>
                                            <span class="n">kde_kl_divergence</span><span class="p">,</span> <span class="n">kde_proxy_bias</span><span class="p">,</span> <span class="n">proxy_adjusted_kde_bias</span><span class="p">,</span> <span class="n">kde_target_bias</span><span class="p">,</span> 
                                            <span class="n">n_complete_years</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">plot</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1"> bits KDE KLD = </span><span class="si">{</span><span class="n">kde_kl_divergence</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> bits/sample, proxy_baseline/proxy_adj/target bias: </span><span class="si">{</span><span class="n">kde_proxy_bias</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">proxy_adjusted_kde_bias</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">kde_target_bias</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> bits/sample (</span><span class="si">{</span><span class="n">missing_support_left</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">missing_support_right</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> L/R missing support)&#39;</span><span class="p">)</span>
    <span class="c1"># print(asdf)</span>
    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kde_results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bitrate&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$$D_\text</span><span class="si">{KL}</span><span class="s1">(\hat P||\hat Q)$$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$$D_\text</span><span class="si">{KL}</span><span class="s1">(P_\text</span><span class="si">{d}</span><span class="s1">|| Q_\text</span><span class="si">{d}</span><span class="s1">)$$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$$D_\text</span><span class="si">{KL}</span><span class="s1">(Q||\hat Q_\text</span><span class="si">{adj}</span><span class="s1">)$$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$$D_\text</span><span class="si">{KL}</span><span class="s1">(Q_\text</span><span class="si">{d}</span><span class="s1">||\hat Q)$$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$$D_\text</span><span class="si">{KL}</span><span class="s1">(P_\text</span><span class="si">{d}</span><span class="s1">|| \hat P)$$&#39;</span><span class="p">])</span>
    <span class="n">html_table</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="s2">&quot;styled-table&quot;</span><span class="p">)</span>
    <span class="n">styled_html</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dpf</span><span class="o">.</span><span class="n">table_style</span><span class="si">}{</span><span class="n">html_table</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">styled_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;h3&gt;Notes:&lt;/h3&gt;&lt;ol&gt;&lt;li&gt;&lt;b&gt;N&lt;/b&gt;: </span><span class="si">{</span><span class="n">n_complete_years</span><span class="si">}</span><span class="s2"> (years) concurrent record&lt;/li&gt;&quot;</span>
    <span class="n">styled_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&lt;li&gt;The &lt;b&gt;subscript d&lt;/b&gt; denotes &quot;discrete&quot; (i.e. Q&lt;sub&gt;d&lt;/sub&gt;)&lt;/li&gt;&#39;</span>
    <span class="n">styled_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;li&gt;&lt;b&gt;Incomplete Support Coverage:&lt;/b&gt;:</span><span class="si">{</span><span class="n">underspecified_kde</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">missing_support_left</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">missing_support_right</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% L/R)&lt;/li&gt;&lt;/ol&gt;&quot;</span>
    <span class="n">t4</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X1 KDE fit:</span><span class="si">{</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">s, X2 base KDE fit:</span><span class="si">{</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">s, X2 adj. compute KLDs:</span><span class="si">{</span><span class="n">t4</span><span class="o">-</span><span class="n">t2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>

    <span class="c1"># Render in a Bokeh Div</span>
    <span class="n">result_div</span> <span class="o">=</span> <span class="n">Div</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">styled_html</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_div</span><span class="p">)</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;KDE_fit_plots/sim_</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">_using_</span><span class="si">{</span><span class="n">proxy</span><span class="si">}</span><span class="s1">.png&#39;</span>
    <span class="n">save_gridplot</span><span class="p">(</span><span class="n">plots</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>    
    <span class="n">proxy</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">min_concurrent_years</span><span class="p">,</span> <span class="n">bitrates</span> <span class="o">=</span> <span class="n">inputs</span>
    
    <span class="n">proxy_id</span><span class="p">,</span> <span class="n">target_id</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span>

    <span class="c1"># create a result dict object for tracking results of the batch comparison</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;proxy&quot;</span><span class="p">:</span> <span class="n">proxy_id</span><span class="p">,</span>
        <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
        <span class="s2">&quot;min_concurrent_years&quot;</span><span class="p">:</span> <span class="n">min_concurrent_years</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">station_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;proxy&quot;</span><span class="p">:</span> <span class="n">proxy</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">}</span>

    <span class="c1"># check if the polygons are nested</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;nested_catchments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">check_if_nested</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="c1"># for stn in pair:</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">Station</span><span class="p">(</span><span class="n">station_info</span><span class="p">[</span><span class="s2">&quot;proxy&quot;</span><span class="p">])</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">Station</span><span class="p">(</span><span class="n">station_info</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
    <span class="n">target</span><span class="o">.</span><span class="n">ln_pdf_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_sim_lognorm_pdf&#39;</span>
    <span class="n">target</span><span class="o">.</span><span class="n">ln_cdf_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_sim_lognorm_cdf&#39;</span>
    <span class="n">target</span><span class="o">.</span><span class="n">expon_pdf_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_sim_expon_pdf&#39;</span>
    <span class="n">target</span><span class="o">.</span><span class="n">expon_cdf_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_sim_expon_cdf&#39;</span>

    <span class="c1"># compute spatial distance</span>
    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">station_info</span><span class="p">[</span><span class="s2">&quot;proxy&quot;</span><span class="p">][</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="p">,</span>
        <span class="n">station_info</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># compute the distance between catchment centroids (km)</span>
    <span class="n">centroid_distance</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;centroid_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">centroid_distance</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">centroid_distance</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">drainage_area_km2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No drainage area for </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">drainage_area_km2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No drainage area for </span><span class="si">{</span><span class="n">proxy_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Retrieve the data for both stations</span>
    <span class="c1"># this is all data, including non-concurrent</span>
    <span class="n">adf</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">retrieve_nonconcurrent_data</span><span class="p">(</span><span class="n">proxy_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>

    <span class="k">assert</span> <span class="o">~</span><span class="n">adf</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="s2">&quot;No data returned.&quot;</span>

    <span class="k">for</span> <span class="n">stn</span> <span class="ow">in</span> <span class="p">[</span><span class="n">proxy</span><span class="p">,</span> <span class="n">target</span><span class="p">]:</span>
        <span class="n">adf</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">transform_and_jitter</span><span class="p">(</span><span class="n">adf</span><span class="p">,</span> <span class="n">stn</span><span class="p">)</span>

    <span class="c1"># simulate flow at the target based on equal unit area runoff scaling</span>
    <span class="n">adf</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">sim_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">adf</span><span class="p">[</span><span class="n">proxy</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">target</span><span class="o">.</span><span class="n">drainage_area_km2</span> <span class="o">/</span> <span class="n">proxy</span><span class="o">.</span><span class="n">drainage_area_km2</span>
    <span class="p">)</span>

    <span class="c1"># filter for the concurrent data</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">adf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">proxy_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;num_concurrent_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">num_complete_concurrent_years</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">num_complete_concurrent_years</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">count_complete_years</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">proxy_id</span><span class="p">)</span>
        
    <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">proxy_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">adf</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">proxy</span><span class="o">.</span><span class="n">n_obs</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">proxy_id</span><span class="p">],</span> <span class="n">counts</span><span class="p">[</span><span class="n">target_id</span><span class="p">]</span>
    
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;proxy_n_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="n">n_obs</span>
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;target_n_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">n_obs</span>
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;proxy_frac_concurrent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="n">proxy</span><span class="o">.</span><span class="n">n_obs</span>
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;target_frac_concurrent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span><span class="o">.</span><span class="n">n_obs</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">proxy_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">target_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Zero observations.  Skipping.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># process the PMFs and divergences for concurrent data </span>
    <span class="c1"># using a range of uniform priors via pseudo counts  </span>
    <span class="k">if</span> <span class="n">num_complete_concurrent_years</span> <span class="o">&gt;</span> <span class="n">min_concurrent_years</span><span class="p">:</span>
        <span class="c1"># df is concurrent data, so the results</span>
        <span class="c1"># are updating concurrent data here    </span>
        <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">sim_label</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># x1 is the observed, x2 is the simulated</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">sim_label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># fit kde to proxy values</span>
        <span class="n">pair_result</span> <span class="o">=</span> <span class="n">kl_divergence_convergence</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">num_complete_concurrent_years</span><span class="p">,</span> <span class="n">bitrates</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pair_result</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the &#39;process&#39; variable is here so jupyter doesn&#39;t go computing </span>
<span class="c1"># a million rows per iteration when the book is built for pushing to github pages.</span>

<span class="n">process</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">partial_counts</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">bitrates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>
<span class="k">if</span> <span class="n">process</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing empirical CDF pairs (partial counts=</span><span class="si">{</span><span class="n">partial_counts</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">results_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;KL_kde_fits_</span><span class="si">{</span><span class="n">revision_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>

    <span class="n">out_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data/&#39;</span><span class="p">,</span> <span class="s1">&#39;nonparametric_divergence_test&#39;</span><span class="p">,</span> <span class="n">results_fname</span><span class="p">)</span>

    <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">id_pairs</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">id_pairs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">),</span> <span class="n">n_batches</span><span class="p">)</span>
    <span class="n">n_pairs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_pairs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Processing </span><span class="si">{</span><span class="n">n_pairs</span><span class="si">}</span><span class="s2"> pairs in </span><span class="si">{</span><span class="n">n_batches</span><span class="si">}</span><span class="s2"> batches.&quot;</span><span class="p">)</span>
    <span class="n">batch_no</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">batch_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="c1"># error_df = error_model_df[error_model_df[&#39;bitrate&#39;] == bitrate].copy()</span>
    <span class="k">for</span> <span class="n">batch_ids</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting batch </span><span class="si">{</span><span class="n">batch_no</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span><span class="si">}</span><span class="s1"> processing.&#39;</span><span class="p">)</span>
        <span class="n">batch_fname</span> <span class="o">=</span> <span class="n">results_fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_batch_</span><span class="si">{</span><span class="n">batch_no</span><span class="si">:</span><span class="s1">04d</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>
        <span class="n">batch_output_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">batch_fname</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">batch_output_fpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">batch_output_fpath</span><span class="p">):</span>
            <span class="n">batch_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_output_fpath</span><span class="p">)</span>
            <span class="n">batch_no</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1">#     continue</span>
        
        <span class="c1"># define the input array for multiprocessing</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">input_batch_generator</span><span class="p">(</span><span class="n">bcub_gdf</span><span class="p">,</span> <span class="n">batch_ids</span><span class="p">,</span> <span class="n">min_years</span><span class="p">,</span> <span class="n">partial_counts</span><span class="p">,</span> <span class="n">bitrates</span><span class="p">)</span>

        <span class="c1"># with mp.Pool(20) as pool:</span>
        <span class="c1">#     results = pool.map(process_batch, inputs)</span>
        <span class="c1">#     results = [r for r in results if r is not None]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">process_batch</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="n">batch_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="c1"># print(batch_result)</span>
        <span class="c1"># print(asdf)</span>
        <span class="k">if</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Empty batch.  Skipping&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_result</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">batch_output_fpath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_result</span><span class="p">)</span><span class="si">}</span><span class="s2"> new results to file.&quot;</span><span class="p">)</span>
        
        <span class="n">batch_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_output_fpath</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_ids</span><span class="p">)</span><span class="si">}</span><span class="s1"> pairs in </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>
        <span class="n">batch_no</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Concatenating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> batch files.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">all_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">batch_files</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_fpath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_fpath</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">batch_files</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_results</span><span class="p">)</span><span class="si">}</span><span class="s1"> results to </span><span class="si">{</span><span class="n">out_fpath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    No new results to write to file.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing empirical CDF pairs (partial counts=False)
    Processing 877150 pairs in 175 batches.
Starting batch 1/175 processing.
/home/danbot2/code_5820/24/divergence_measures/docs/notebooks/data/temp/KL_kde_fits_20241125_batch_0001.csv
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=5557 samples, (2.0 years)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    4 bits KDE KLD = 72.16 bits/sample, proxy_baseline/proxy_adj/target bias: -3.48/82.88/-3.90 bits/sample (0.00/0.00 L/R missing support)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    6 bits KDE KLD = 416.94 bits/sample, proxy_baseline/proxy_adj/target bias: -5.44/461.92/-5.87 bits/sample (0.00/0.00 L/R missing support)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    8 bits KDE KLD = 2179.83 bits/sample, proxy_baseline/proxy_adj/target bias: -7.39/2360.33/-7.80 bits/sample (0.00/0.00 L/R missing support)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    10 bits KDE KLD = 10767.36 bits/sample, proxy_baseline/proxy_adj/target bias: -8.96/11489.51/-9.04 bits/sample (0.00/0.00 L/R missing support)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    12 bits KDE KLD = 51261.45 bits/sample, proxy_baseline/proxy_adj/target bias: -9.10/54150.63/-9.05 bits/sample (0.00/0.00 L/R missing support)
X1 KDE fit:0.9s, X2 base KDE fit:0.0s, X2 adj. compute KLDs:4.2s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Plot saved to KDE_fit_plots/sim_08LF051_using_05CA001.png
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=20241 samples, (53.0 years)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    4 bits KDE KLD = 142.57 bits/sample, proxy_baseline/proxy_adj/target bias: -3.78/68.09/-3.25 bits/sample (0.00/0.31 L/R missing support)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    6 bits KDE KLD = 643.60 bits/sample, proxy_baseline/proxy_adj/target bias: -5.77/401.96/-5.24 bits/sample (0.00/0.31 L/R missing support)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    8 bits KDE KLD = 2988.12 bits/sample, proxy_baseline/proxy_adj/target bias: -7.73/2123.12/-7.22 bits/sample (0.00/0.31 L/R missing support)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    10 bits KDE KLD = 13380.77 bits/sample, proxy_baseline/proxy_adj/target bias: -9.12/10568.11/-8.99 bits/sample (0.00/0.31 L/R missing support)
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span> <span class="n">line</span> <span class="mi">39</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span> <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">39</span>     <span class="n">res</span> <span class="o">=</span> <span class="n">process_batch</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span>     <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span>         <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="nn">Cell In[18], line 87,</span> in <span class="ni">process_batch</span><span class="nt">(inputs)</span>
<span class="g g-Whitespace">     </span><span class="mi">85</span>     <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">sim_label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="g g-Whitespace">     </span><span class="mi">86</span>     <span class="c1"># fit kde to proxy values</span>
<span class="ne">---&gt; </span><span class="mi">87</span>     <span class="n">pair_result</span> <span class="o">=</span> <span class="n">kl_divergence_convergence</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">num_complete_concurrent_years</span><span class="p">,</span> <span class="n">bitrates</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">88</span>     <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pair_result</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">90</span> <span class="k">return</span> <span class="n">result</span>

<span class="nn">Cell In[17], line 50,</span> in <span class="ni">kl_divergence_convergence</span><span class="nt">(proxy, target, x1, x2, n_complete_years, bitrates, n_resamples, epsilon, n_bins)</span>
<span class="g g-Whitespace">     </span><span class="mi">46</span> <span class="n">hist_proxy</span><span class="p">,</span> <span class="n">edges_proxy</span> <span class="o">=</span> <span class="n">compute_hist_and_log_edges</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span> <span class="c1"># compute the proxy KDE PDF with adjusted bandwidth </span>
<span class="g g-Whitespace">     </span><span class="mi">49</span> <span class="c1"># to provide support coverage of target </span>
<span class="ne">---&gt; </span><span class="mi">50</span> <span class="n">kde_proxy_approx</span><span class="p">,</span> <span class="n">max_bw_exceeded</span> <span class="o">=</span> <span class="n">fit_KDE_and_check_min_Qx</span><span class="p">(</span><span class="n">kde_proxy_baseline</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">edges_target</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span> <span class="c1"># compute the &quot;ground truth&quot; PMF </span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> <span class="c1"># --&gt; this is P(x)</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span> <span class="n">kde_target_pmf</span> <span class="o">=</span> <span class="n">vectorized_kde_integration</span><span class="p">(</span><span class="n">kde_target</span><span class="p">,</span> <span class="n">edges_target</span><span class="p">)</span>

<span class="nn">Cell In[16], line 29,</span> in <span class="ni">fit_KDE_and_check_min_Qx</span><span class="nt">(kde_fit, x1, x2, bin_edges, adjusted_bw, min_q_allowed, modified_bw)</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>     <span class="n">kde_fit</span> <span class="o">=</span> <span class="n">jkde</span><span class="p">(</span><span class="n">log_x2</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">adj_bw</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span>     <span class="c1"># recursively adjust the bandwidth</span>
<span class="ne">---&gt; </span><span class="mi">29</span>     <span class="k">return</span> <span class="n">fit_KDE_and_check_min_Qx</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span>         <span class="c1"># x1, x2, adjusted_bw=adj_bw, underspecified_kde=True</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>         <span class="n">kde_fit</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">adjusted_bw</span><span class="o">=</span><span class="n">adj_bw</span><span class="p">,</span> <span class="n">modified_bw</span><span class="o">=</span><span class="kc">True</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span> <span class="k">return</span> <span class="n">kde_fit</span><span class="p">,</span> <span class="n">max_bw_exceeded</span>

<span class="nn">Cell In[16], line 29,</span> in <span class="ni">fit_KDE_and_check_min_Qx</span><span class="nt">(kde_fit, x1, x2, bin_edges, adjusted_bw, min_q_allowed, modified_bw)</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>     <span class="n">kde_fit</span> <span class="o">=</span> <span class="n">jkde</span><span class="p">(</span><span class="n">log_x2</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">adj_bw</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span>     <span class="c1"># recursively adjust the bandwidth</span>
<span class="ne">---&gt; </span><span class="mi">29</span>     <span class="k">return</span> <span class="n">fit_KDE_and_check_min_Qx</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span>         <span class="c1"># x1, x2, adjusted_bw=adj_bw, underspecified_kde=True</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>         <span class="n">kde_fit</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">adjusted_bw</span><span class="o">=</span><span class="n">adj_bw</span><span class="p">,</span> <span class="n">modified_bw</span><span class="o">=</span><span class="kc">True</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span> <span class="k">return</span> <span class="n">kde_fit</span><span class="p">,</span> <span class="n">max_bw_exceeded</span>

    <span class="p">[</span><span class="o">...</span> <span class="n">skipping</span> <span class="n">similar</span> <span class="n">frames</span><span class="p">:</span> <span class="n">fit_KDE_and_check_min_Qx</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">29</span> <span class="p">(</span><span class="mi">43</span> <span class="n">times</span><span class="p">)]</span>

<span class="nn">Cell In[16], line 29,</span> in <span class="ni">fit_KDE_and_check_min_Qx</span><span class="nt">(kde_fit, x1, x2, bin_edges, adjusted_bw, min_q_allowed, modified_bw)</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>     <span class="n">kde_fit</span> <span class="o">=</span> <span class="n">jkde</span><span class="p">(</span><span class="n">log_x2</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">adj_bw</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span>     <span class="c1"># recursively adjust the bandwidth</span>
<span class="ne">---&gt; </span><span class="mi">29</span>     <span class="k">return</span> <span class="n">fit_KDE_and_check_min_Qx</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span>         <span class="c1"># x1, x2, adjusted_bw=adj_bw, underspecified_kde=True</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>         <span class="n">kde_fit</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">adjusted_bw</span><span class="o">=</span><span class="n">adj_bw</span><span class="p">,</span> <span class="n">modified_bw</span><span class="o">=</span><span class="kc">True</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span> <span class="k">return</span> <span class="n">kde_fit</span><span class="p">,</span> <span class="n">max_bw_exceeded</span>

<span class="nn">Cell In[16], line 8,</span> in <span class="ni">fit_KDE_and_check_min_Qx</span><span class="nt">(kde_fit, x1, x2, bin_edges, adjusted_bw, min_q_allowed, modified_bw)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">def</span> <span class="nf">fit_KDE_and_check_min_Qx</span><span class="p">(</span><span class="n">kde_fit</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">adjusted_bw</span><span class="o">=</span><span class="s1">&#39;scott&#39;</span><span class="p">,</span> <span class="n">min_q_allowed</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">modified_bw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span><span class="sd">     Check that the smallest x1 (target value) probability mass evaluated</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span><span class="sd">     on the proxy fit is greater than some minimum threshold </span>
<span class="g g-Whitespace">      </span><span class="mi">5</span><span class="sd">     (the purpose is to avoid dividing by zero later on -- just setting != 0 is not enough</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span><span class="sd">     use KDE to estimate the pdf for the proxy / simulated values</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">----&gt; </span><span class="mi">8</span>     <span class="n">pmf</span> <span class="o">=</span> <span class="n">vectorized_kde_integration</span><span class="p">(</span><span class="n">kde_fit</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="c1"># min_probability_mass = np.nanmin(np.diff(np.array([kde_proxy_fit.integrate_box_1d(-np.inf, np.log10(xi)) for xi in edges_target])))</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="n">min_probability_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>

<span class="nn">Cell In[14], line 3,</span> in <span class="ni">vectorized_kde_integration</span><span class="nt">(kde_fit_object, edges)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">def</span> <span class="nf">vectorized_kde_integration</span><span class="p">(</span><span class="n">kde_fit_object</span><span class="p">,</span> <span class="n">edges</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">integrate_cdf</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">xi</span><span class="p">:</span> <span class="n">kde_fit_object</span><span class="o">.</span><span class="n">integrate_box_1d</span><span class="p">(</span><span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xi</span><span class="p">)))</span>
<span class="ne">----&gt; </span><span class="mi">3</span>     <span class="n">cdf_values</span> <span class="o">=</span> <span class="n">integrate_cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">pmf_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cdf_values</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="k">return</span> <span class="n">pmf_values</span>

    <span class="p">[</span><span class="o">...</span> <span class="n">skipping</span> <span class="n">hidden</span> <span class="mi">1</span> <span class="n">frame</span><span class="p">]</span>

<span class="nn">File ~/code_5820/data_analysis/lib/python3.10/site-packages/jax/_src/api.py:992,</span> in <span class="ni">vmap.&lt;locals&gt;.vmap_f</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">989</span> <span class="n">axis_size_</span> <span class="o">=</span> <span class="p">(</span><span class="n">axis_size</span> <span class="k">if</span> <span class="n">axis_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
<span class="g g-Whitespace">    </span><span class="mi">990</span>               <span class="n">_mapped_axis_size</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">in_tree</span><span class="p">,</span> <span class="n">args_flat</span><span class="p">,</span> <span class="n">in_axes_flat</span><span class="p">,</span> <span class="s2">&quot;vmap&quot;</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">991</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">992</span>   <span class="n">out_flat</span> <span class="o">=</span> <span class="n">batching</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">993</span>       <span class="n">flat_fun</span><span class="p">,</span> <span class="n">axis_name</span><span class="p">,</span> <span class="n">axis_size_</span><span class="p">,</span> <span class="n">in_axes_flat</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">994</span>       <span class="k">lambda</span><span class="p">:</span> <span class="n">flatten_axes</span><span class="p">(</span><span class="s2">&quot;vmap out_axes&quot;</span><span class="p">,</span> <span class="n">out_tree</span><span class="p">(),</span> <span class="n">out_axes</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">995</span>       <span class="n">spmd_axis_name</span><span class="o">=</span><span class="n">spmd_axis_name</span>
<span class="g g-Whitespace">    </span><span class="mi">996</span>   <span class="p">)</span><span class="o">.</span><span class="n">call_wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args_flat</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">997</span> <span class="k">except</span> <span class="n">batching</span><span class="o">.</span><span class="n">SpecMatchError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">998</span>   <span class="n">out_axes_flat</span> <span class="o">=</span> <span class="n">flatten_axes</span><span class="p">(</span><span class="s2">&quot;vmap out_axes&quot;</span><span class="p">,</span> <span class="n">out_tree</span><span class="p">(),</span> <span class="n">out_axes</span><span class="p">)</span>

<span class="nn">File ~/code_5820/data_analysis/lib/python3.10/site-packages/jax/_src/linear_util.py:193,</span> in <span class="ni">WrappedFun.call_wrapped</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span> <span class="n">gen</span> <span class="o">=</span> <span class="n">gen_static_args</span> <span class="o">=</span> <span class="n">out_store</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">192</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">193</span>   <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span> <span class="k">except</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">195</span>   <span class="c1"># Some transformations yield from inside context managers, so we have to</span>
<span class="g g-Whitespace">    </span><span class="mi">196</span>   <span class="c1"># interrupt them before reraising the exception. Otherwise they will only</span>
<span class="g g-Whitespace">    </span><span class="mi">197</span>   <span class="c1"># get garbage-collected at some later time, running their cleanup tasks</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span>   <span class="c1"># only after this exception is handled, which can corrupt the global</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span>   <span class="c1"># state.</span>
<span class="g g-Whitespace">    </span><span class="mi">200</span>   <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>

<span class="nn">Cell In[14], line 2,</span> in <span class="ni">vectorized_kde_integration.&lt;locals&gt;.&lt;lambda&gt;</span><span class="nt">(xi)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">def</span> <span class="nf">vectorized_kde_integration</span><span class="p">(</span><span class="n">kde_fit_object</span><span class="p">,</span> <span class="n">edges</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">2</span>     <span class="n">integrate_cdf</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">xi</span><span class="p">:</span> <span class="n">kde_fit_object</span><span class="o">.</span><span class="n">integrate_box_1d</span><span class="p">(</span><span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xi</span><span class="p">)))</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">cdf_values</span> <span class="o">=</span> <span class="n">integrate_cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">pmf_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cdf_values</span><span class="p">)</span>

<span class="nn">File ~/code_5820/data_analysis/lib/python3.10/site-packages/jax/_src/scipy/stats/kde.py:162,</span> in <span class="ni">gaussian_kde.integrate_box_1d</span><span class="nt">(self, low, high)</span>
<span class="g g-Whitespace">    </span><span class="mi">160</span> <span class="n">low</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">((</span><span class="n">low</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">161</span> <span class="n">high</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">((</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">162</span> <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">*</span> <span class="p">(</span><span class="n">special</span><span class="o">.</span><span class="n">ndtr</span><span class="p">(</span><span class="n">high</span><span class="p">)</span> <span class="o">-</span> <span class="n">special</span><span class="o">.</span><span class="n">ndtr</span><span class="p">(</span><span class="n">low</span><span class="p">)))</span>

<span class="nn">File ~/code_5820/data_analysis/lib/python3.10/site-packages/jax/_src/scipy/special.py:907,</span> in <span class="ni">ndtr</span><span class="nt">(x)</span>
<span class="g g-Whitespace">    </span><span class="mi">903</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">904</span>   <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">905</span>       <span class="s2">&quot;x.dtype=</span><span class="si">{}</span><span class="s2"> is not supported, see docstring for supported types.&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">906</span>       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
<span class="ne">--&gt; </span><span class="mi">907</span> <span class="k">return</span> <span class="n">_ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nn">File ~/code_5820/data_analysis/lib/python3.10/site-packages/jax/_src/scipy/special.py:918,</span> in <span class="ni">_ndtr</span><span class="nt">(x)</span>
<span class="g g-Whitespace">    </span><span class="mi">914</span> <span class="n">w</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">half_sqrt_2</span>
<span class="g g-Whitespace">    </span><span class="mi">915</span> <span class="n">z</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">916</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">half_sqrt_2</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">917</span>                     <span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">+</span> <span class="n">lax</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">w</span><span class="p">),</span>
<span class="ne">--&gt; </span><span class="mi">918</span>                     <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.</span><span class="p">)),</span>
<span class="g g-Whitespace">    </span><span class="mi">919</span>                                     <span class="n">dtype</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">lax</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">920</span>                                     <span class="n">lax</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span>
<span class="g g-Whitespace">    </span><span class="mi">921</span> <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>

<span class="nn">File ~/code_5820/data_analysis/lib/python3.10/site-packages/jax/_src/lax/lax.py:499,</span> in <span class="ni">gt</span><span class="nt">(x, y)</span>
<span class="g g-Whitespace">    </span><span class="mi">497</span> <span class="k">def</span> <span class="nf">gt</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">498</span><span class="w">   </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Elementwise greater-than: :math:`x &gt; y`.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">499</span>   <span class="k">return</span> <span class="n">gt_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="nn">File ~/code_5820/data_analysis/lib/python3.10/site-packages/jax/_src/core.py:438,</span> in <span class="ni">Primitive.bind</span><span class="nt">(self, *args, **params)</span>
<span class="g g-Whitespace">    </span><span class="mi">435</span> <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">436</span>   <span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_checks</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span>
<span class="g g-Whitespace">    </span><span class="mi">437</span>           <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Tracer</span><span class="p">)</span> <span class="ow">or</span> <span class="n">valid_jaxtype</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)),</span> <span class="n">args</span>
<span class="ne">--&gt; </span><span class="mi">438</span>   <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_with_trace</span><span class="p">(</span><span class="n">find_top_trace</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">args</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

<span class="nn">File ~/code_5820/data_analysis/lib/python3.10/site-packages/jax/_src/core.py:442,</span> in <span class="ni">Primitive.bind_with_trace</span><span class="nt">(self, trace, args, params)</span>
<span class="g g-Whitespace">    </span><span class="mi">440</span> <span class="k">def</span> <span class="nf">bind_with_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">441</span>   <span class="k">with</span> <span class="n">pop_level</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">level</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">442</span>     <span class="n">out</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">process_primitive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">full_raise</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">443</span>   <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">full_lower</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_results</span> <span class="k">else</span> <span class="n">full_lower</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="nn">File ~/code_5820/data_analysis/lib/python3.10/site-packages/jax/_src/core.py:955,</span> in <span class="ni">EvalTrace.process_primitive</span><span class="nt">(self, primitive, tracers, params)</span>
<span class="g g-Whitespace">    </span><span class="mi">953</span>   <span class="k">return</span> <span class="n">call_impl_with_key_reuse_checks</span><span class="p">(</span><span class="n">primitive</span><span class="p">,</span> <span class="n">primitive</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span> <span class="o">*</span><span class="n">tracers</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">954</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">955</span>   <span class="k">return</span> <span class="n">primitive</span><span class="o">.</span><span class="n">impl</span><span class="p">(</span><span class="o">*</span><span class="n">tracers</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>

<span class="nn">File ~/code_5820/data_analysis/lib/python3.10/site-packages/jax/_src/dispatch.py:91,</span> in <span class="ni">apply_primitive</span><span class="nt">(prim, *args, **params)</span>
<span class="g g-Whitespace">     </span><span class="mi">89</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">swap_thread_local_state_disable_jit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">90</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">91</span>   <span class="n">outs</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">92</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">93</span>   <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">swap_thread_local_state_disable_jit</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/parametric_divergence_test/KL_parametric_fits_4bits_20241125.csv&#39;</span><span class="p">)</span>
<span class="c1"># print(len(result_df))</span>
<span class="c1"># foo = result_df.copy()</span>
<span class="c1"># foo.dropna(subset=[&#39;kld_lb&#39;], inplace=True)</span>
<span class="c1"># foo[&#39;kld_ci_range&#39;] = foo[&#39;kld_ub&#39;] - foo[&#39;kld_lb&#39;]</span>
<span class="c1"># print(foo[&#39;kld_ci_range&#39;].max())</span>
<span class="c1"># foo.head()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;num_concurrent_obs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">bin_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bin_size</span><span class="si">}</span><span class="s1"> samples per bin&#39;</span><span class="p">)</span>
<span class="n">foo</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">index</span> <span class="o">//</span> <span class="n">bin_size</span>
<span class="n">foo</span><span class="p">[</span><span class="s1">&#39;n_years&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">foo</span><span class="p">[</span><span class="s1">&#39;num_concurrent_obs&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">365.24</span>

<span class="n">bin_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">foo</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">foo</span><span class="p">[</span><span class="n">foo</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kld_ci_range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">sample_size</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;n_years&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">bin_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">95</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>   
    
<span class="n">bdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">bin_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;lb&#39;</span><span class="p">,</span> <span class="s1">&#39;25&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;75&#39;</span><span class="p">,</span> <span class="s1">&#39;ub&#39;</span><span class="p">])</span>
<span class="c1"># grouped[&#39;bin_center&#39;] = foo.groupby(&#39;bin&#39;)[&#39;num_concurrent_obs&#39;].median().values</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">varea</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">bdf</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="n">y1</span><span class="o">=</span><span class="n">bdf</span><span class="p">[</span><span class="s1">&#39;lb&#39;</span><span class="p">],</span> <span class="n">y2</span><span class="o">=</span><span class="n">bdf</span><span class="p">[</span><span class="s1">&#39;ub&#39;</span><span class="p">],</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;95% CI&#39;</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">varea</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">bdf</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="n">y1</span><span class="o">=</span><span class="n">bdf</span><span class="p">[</span><span class="s1">&#39;25&#39;</span><span class="p">],</span> <span class="n">y2</span><span class="o">=</span><span class="n">bdf</span><span class="p">[</span><span class="s1">&#39;75&#39;</span><span class="p">],</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;IQR&#39;</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">bdf</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">bdf</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">],</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Concurrent Record Length [years]&quot;</span>
<span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$$95\% \text{ CI } \hat D_\text</span><span class="si">{KL}</span><span class="s2">(P||Q)$$&quot;</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The plot above describes how the (bootstrapped) uncertainty of the KL divergence estimate decreases with sample size.  The series are computed on record length intervals determined by equal sample size, approximately 6000 samples per interval.</p>
</section>
<section id="code-graveyard">
<h1>Code Graveyard<a class="headerlink" href="#code-graveyard" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># Evaluate KDE on grid points for each sample set</span>
<span class="k">def</span> <span class="nf">kde_per_row</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">bw</span><span class="p">):</span>
    <span class="c1"># Compute Gaussian kernel values for each grid point</span>
    <span class="n">kernels</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">((</span><span class="n">grid_points</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">)</span> <span class="o">/</span> <span class="n">bw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">kernels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">bw</span>

<span class="k">def</span> <span class="nf">kde_fit_per_row</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">bw</span><span class="p">):</span>    
    <span class="c1"># Vectorized computation across all rows</span>
    <span class="n">kde_values</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">kde_per_row</span><span class="p">)(</span><span class="n">samples</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">assert_alignment</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># Define a mask for valid kde_density values</span>
    <span class="n">valid_mask_1</span> <span class="o">=</span> <span class="o">~</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    
    <span class="c1"># Define a mask for valid x1_diffs values</span>
    <span class="n">valid_mask_2</span> <span class="o">=</span> <span class="o">~</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    
    <span class="c1"># Assert that wherever kde_density is valid, x1_diffs is also valid</span>
    <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">valid_mask_1</span><span class="p">)</span> <span class="o">|</span> <span class="n">valid_mask_2</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">&quot;x1_diffs contains invalid (NaN) values where kde_density is valid.&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">justify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">invalid_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Justifies a 2D array</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    A : ndarray</span>
<span class="sd">        Input array to be justified</span>
<span class="sd">    axis : int</span>
<span class="sd">        Axis along which justification is to be made</span>
<span class="sd">    side : str</span>
<span class="sd">        Direction of justification. It could be &#39;left&#39;, &#39;right&#39;, &#39;up&#39;, &#39;down&#39;</span>
<span class="sd">        It should be &#39;left&#39; or &#39;right&#39; for axis=1 and &#39;up&#39; or &#39;down&#39; for axis=0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">invalid_val</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">a</span><span class="o">!=</span><span class="n">invalid_val</span>
    <span class="n">justified_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">side</span><span class="o">==</span><span class="s1">&#39;up&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">side</span><span class="o">==</span><span class="s1">&#39;left&#39;</span><span class="p">):</span>
        <span class="n">justified_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">justified_mask</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">invalid_val</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">axis</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="n">justified_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">justified_mask</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">compute_adjusted_cdf_and_density</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute adjusted CDF and density for each row of a 2D array using JAX.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: 2D JAX array, where each row represents a sample set.</span>

<span class="sd">    Returns:</span>
<span class="sd">        adjusted_cdfs: 2D array of adjusted CDFs, padded with NaN where necessary.</span>
<span class="sd">        adjusted_densities: 2D array of adjusted densities, padded with NaN where necessary.</span>
<span class="sd">        unique_vals: 2D array of unique values per row, padded with NaN where necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
   <span class="c1"># Sort rows and handle NaNs by sorting them to the end</span>
    <span class="n">sorted_data</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Count consecutive duplicates to determine unique values and counts</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sorted_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">unique_mask</span> <span class="o">=</span> <span class="n">diffs</span> <span class="o">!=</span> <span class="mi">0</span>  <span class="c1"># Marks unique values in each row</span>

    <span class="c1"># Create unique values and compute their counts</span>
    <span class="n">unique_vals</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unique_mask</span><span class="p">,</span> <span class="n">sorted_data</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">counts_per_row</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">unique_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Compute cumulative counts for unique values only</span>
    <span class="n">adjusted_cdf</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">unique_mask</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">unique_mask</span> <span class="o">/</span> <span class="n">counts_per_row</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">)</span>

    <span class="n">sorted_cdf</span> <span class="o">=</span> <span class="n">justify</span><span class="p">(</span><span class="n">adjusted_cdf</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">sorted_unique</span> <span class="o">=</span> <span class="n">justify</span><span class="p">(</span><span class="n">unique_vals</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="c1"># Compute the density (difference of CDF)</span>
    <span class="n">density</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sorted_cdf</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]),</span> <span class="n">sorted_cdf</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    

    <span class="k">return</span> <span class="n">sorted_cdf</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">sorted_unique</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="citations">
<h1>Citations<a class="headerlink" href="#citations" title="Link to this heading">#</a></h1>
<span class="target" id="id1"></span></section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">KL Divergence Estimation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">Methodology</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-cases">Problem Cases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pairwise-processing">Pairwise Processing</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#code-graveyard">Code Graveyard</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dan Kovacek
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>