
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Update HYSETS Catchment Polygons &#8212; On the predictability of f-divergence measures from catchment attributes</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/1a_Update_Catchment_Bounds';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Update HYSETS Catchment Attributes" href="1b_Update_Catchment_Attributes.html" />
    <link rel="prev" title="Data" href="1_data.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="On the predictability of f-divergence measures from catchment attributes - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="On the predictability of f-divergence measures from catchment attributes - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="1_data.html">Data</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Update HYSETS Catchment Polygons</a></li>
<li class="toctree-l2"><a class="reference internal" href="1b_Update_Catchment_Attributes.html">Update HYSETS Catchment Attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="1c_Process_Target_Variables.html">Process Target Variables</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="2_Methods.html">Methods</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="2a_Predictability_of_Mean_Runoff.html">Predictability of Mean Runoff</a></li>
<li class="toctree-l2"><a class="reference internal" href="2b_Predictability_of_entropy.html">Predictability of (Shannon) Entropy</a></li>
<li class="toctree-l2"><a class="reference internal" href="2c_Predictability_of_KL_divergence.html">Predictability of Kullback-Leibler (KL) Divergence</a></li>
<li class="toctree-l2"><a class="reference internal" href="2d_Predictability_of_TVD.html">Predictability of Total Variation Distance (TVD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="2e_Predictability_of_WD.html">Predictability of Earth Mover’s (Wasserstein) Distance (EMD)</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="Discussion.html">Discussion</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/dankovacek/divergence_measures" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/dankovacek/divergence_measures/issues/new?title=Issue%20on%20page%20%2Fnotebooks/1a_Update_Catchment_Bounds.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/1a_Update_Catchment_Bounds.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Update HYSETS Catchment Polygons</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-data">Import Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-hysets-data">Import HYSETS data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-working-folders-to-organize-temporary-and-final-files">Set up working folders to organize temporary and final files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-bcub-study-region-bounds">Import (BCUB) study region bounds</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-original-hysets-polygons">Load the original HYSETS polygons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-for-updated-wsc-polygons">Check for updated WSC polygons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-for-updated-usgs-polygons">Check for updated USGS polygons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#delineate-the-remaining-catchments-from-1-arc-second-usgs-3dep-dem">Delineate the remaining catchments from 1 arc-second USGS 3DEP DEM.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-stations-individually">Process stations individually</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#find-the-nearest-pixel-in-the-stream-raster-corresponding-to-the-point-geometry">Find the nearest pixel in the stream raster corresponding to the point geometry</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-plots-to-visualize-the-results-of-adjusting-pour-points-to-the-derived-stream-network">Create plots to visualize the results of adjusting pour points to the derived stream network</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-validation-plots-set">Create validation plots set</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#show-an-example-validation-plot">Show an example validation plot</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-validation-notes">Additional validation notes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#re-delineate-basins-with-adjusted-pour-points">Re-delineate basins with adjusted pour points</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#revise-the-plots">Revise the plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#final-review-notes-excluded-stations">Final review notes (excluded stations)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assemble-final-catchment-bounds-into-a-dataframe-to-be-used-in-subsequent-computation">Assemble final catchment bounds into a dataframe to be used in subsequent computation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="update-hysets-catchment-polygons">
<h1>Update HYSETS Catchment Polygons<a class="headerlink" href="#update-hysets-catchment-polygons" title="Link to this heading">#</a></h1>
<p>The HYSETS dataset <span id="id1">[<a class="reference internal" href="markdown.html#id5" title="Richard Arsenault, François Brissette, Jean-Luc Martel, Magali Troin, Guillaume Lévesque, Jonathan Davidson-Chaput, Mariana Castañeda Gonzalez, Ali Ameli, and Annie Poulin. A comprehensive, multisource database for hydrometeorological modeling of 14,425 north american watersheds. Scientific Data, 7(1):243, 2020.">Arsenault <em>et al.</em>, 2020</a>]</span> contains an “artificial boundaries” flag to indicate where the catchment boundary for the monitoring location is approximated due to either missing data or uncertainty in catchment delineation, in general due to small drainage area.  Approximately 25% of the catchments in the study region (British Columbia and surrounding areas) feature this flag.</p>
<p>In July 2022, the Water Survey of Canada (WSC) published updated polygons for over 8000 catchments in Canada.  We find updated catchment boundaries from WSC and USGS where available.  Polygons updated from USGS and WSC official sources represent over 3/4 of the “artificial bounds” flagged catchments, and the remaining 92 are updated using reprocessed USGS 3DEP DEM and an algorithm matching the closest stream pixel (required for catchment delineation) to the reported drainage area.</p>
<p>To start, download the HYSETS catchment polygons (<code class="docutils literal notranslate"><span class="pre">HYSETS_watershed_boundaries.zip</span></code>) from <a class="reference external" href="https://osf.io/rpc3w/">that dataset’s open data repository</a>.</p>
<p>The resulting updated polygons are used in the next chapter/section to extract and validate attributes as part of the supporting information for technical validation of the associated publication.</p>
<section id="import-data">
<h2>Import Data<a class="headerlink" href="#import-data" title="Link to this heading">#</a></h2>
<p>The following files are needed for this notebook:</p>
<ul class="simple">
<li><p><strong>HYSETS catchment polygons</strong>:</p></li>
<li><p><strong>HYSETS station points</strong>:</p></li>
</ul>
<section id="import-hysets-data">
<h3>Import HYSETS data<a class="headerlink" href="#import-hysets-data" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">import</span> <span class="nn">json</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-up-working-folders-to-organize-temporary-and-final-files">
<h3>Set up working folders to organize temporary and final files<a class="headerlink" href="#set-up-working-folders-to-organize-temporary-and-final-files" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">polygon_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;catchment_polygons&#39;</span><span class="p">)</span>
<span class="n">temp_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">polygon_folder</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">)</span>
<span class="n">updated_catchment_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">polygon_folder</span><span class="p">,</span> <span class="s1">&#39;updated_catchment_set&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_folder</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">temp_folder</span><span class="p">,</span> <span class="n">updated_catchment_folder</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import the HYSETS attributes data</span>
<span class="n">hysets_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/HYSETS_watershed_properties.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">hysets_df</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;Watershed_ID&#39;, &#39;Source&#39;, &#39;Name&#39;, &#39;Official_ID&#39;, &#39;Centroid_Lat_deg_N&#39;,
       &#39;Centroid_Lon_deg_E&#39;, &#39;Drainage_Area_km2&#39;, &#39;Drainage_Area_GSIM_km2&#39;,
       &#39;Flag_GSIM_boundaries&#39;, &#39;Flag_Artificial_Boundaries&#39;, &#39;Elevation_m&#39;,
       &#39;Slope_deg&#39;, &#39;Gravelius&#39;, &#39;Perimeter&#39;, &#39;Flag_Shape_Extraction&#39;,
       &#39;Aspect_deg&#39;, &#39;Flag_Terrain_Extraction&#39;, &#39;Land_Use_Forest_frac&#39;,
       &#39;Land_Use_Grass_frac&#39;, &#39;Land_Use_Wetland_frac&#39;, &#39;Land_Use_Water_frac&#39;,
       &#39;Land_Use_Urban_frac&#39;, &#39;Land_Use_Shrubs_frac&#39;, &#39;Land_Use_Crops_frac&#39;,
       &#39;Land_Use_Snow_Ice_frac&#39;, &#39;Flag_Land_Use_Extraction&#39;,
       &#39;Permeability_logk_m2&#39;, &#39;Porosity_frac&#39;, &#39;Flag_Subsoil_Extraction&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-bcub-study-region-bounds">
<h3>Import (BCUB) study region bounds<a class="headerlink" href="#import-bcub-study-region-bounds" title="Link to this heading">#</a></h3>
<p>Get the region bounds from the BCUB dataset <a class="reference external" href="https://doi.org/10.5683/SP3/JNKZVT">https://doi.org/10.5683/SP3/JNKZVT</a> or just skip this step and use the pre-processed file (<code class="docutils literal notranslate"><span class="pre">data/data/study_region_stations.geojson</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import the BCUB (study) region boundary</span>
<span class="n">region_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;data/BCUB_regions_4326.geojson&#39;</span><span class="p">)</span>
<span class="n">region_gdf</span> <span class="o">=</span> <span class="n">region_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">)</span>
<span class="c1"># simplify the geometries (100m threshold) and add a small buffer (250m) to capture HYSETS station points recorded with low accuracy near boundaries</span>
<span class="n">region_gdf</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">region_gdf</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="c1"># region_gdf = region_gdf.to_crs(4326)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the stations contained in the study region</span>
<span class="n">centroids</span> <span class="o">=</span> <span class="n">hysets_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Centroid_Lon_deg_E&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Centroid_Lat_deg_N&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">hysets_points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">hysets_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">centroids</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
<span class="n">hysets_points</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hysets_points</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Watershed_ID</th>
      <th>Source</th>
      <th>Name</th>
      <th>Official_ID</th>
      <th>Centroid_Lat_deg_N</th>
      <th>Centroid_Lon_deg_E</th>
      <th>Drainage_Area_km2</th>
      <th>Drainage_Area_GSIM_km2</th>
      <th>Flag_GSIM_boundaries</th>
      <th>Flag_Artificial_Boundaries</th>
      <th>...</th>
      <th>Land_Use_Water_frac</th>
      <th>Land_Use_Urban_frac</th>
      <th>Land_Use_Shrubs_frac</th>
      <th>Land_Use_Crops_frac</th>
      <th>Land_Use_Snow_Ice_frac</th>
      <th>Flag_Land_Use_Extraction</th>
      <th>Permeability_logk_m2</th>
      <th>Porosity_frac</th>
      <th>Flag_Subsoil_Extraction</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>HYDAT</td>
      <td>SAINT JOHN RIVER AT FORT KENT</td>
      <td>01AD002</td>
      <td>47.25806</td>
      <td>-68.59583</td>
      <td>14703.9211</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0258</td>
      <td>0.0089</td>
      <td>0.0749</td>
      <td>0.0242</td>
      <td>0.0</td>
      <td>1</td>
      <td>-14.719327</td>
      <td>0.180905</td>
      <td>1</td>
      <td>POINT (4899816.377 1923344.02)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>HYDAT</td>
      <td>ST. FRANCIS RIVER AT OUTLET OF GLASIER LAKE</td>
      <td>01AD003</td>
      <td>47.20661</td>
      <td>-68.95694</td>
      <td>1358.6435</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0219</td>
      <td>0.0174</td>
      <td>0.0410</td>
      <td>0.0414</td>
      <td>0.0</td>
      <td>1</td>
      <td>-14.056491</td>
      <td>0.206450</td>
      <td>1</td>
      <td>POINT (4884971.27 1899554.089)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>HYDAT</td>
      <td>MADAWASKA (RIVIERE) A 6 KM EN AVAL DU BARRAGE ...</td>
      <td>01AD015</td>
      <td>47.53850</td>
      <td>-68.59180</td>
      <td>2712.0000</td>
      <td>2693.814</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>0.0487</td>
      <td>0.0230</td>
      <td>0.0351</td>
      <td>0.0600</td>
      <td>0.0</td>
      <td>1</td>
      <td>-14.537390</td>
      <td>0.165357</td>
      <td>1</td>
      <td>POINT (4877510.023 1944961.323)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>HYDAT</td>
      <td>FISH RIVER NEAR FORT KENT</td>
      <td>01AE001</td>
      <td>47.23750</td>
      <td>-68.58278</td>
      <td>2245.7638</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0630</td>
      <td>0.0115</td>
      <td>0.0641</td>
      <td>0.0528</td>
      <td>0.0</td>
      <td>1</td>
      <td>-14.687869</td>
      <td>0.170597</td>
      <td>1</td>
      <td>POINT (4902150.016 1922495.089)</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 30 columns</p>
</div></div></div>
</div>
<p>Note that these are just the artificial bounds flagged rows, below we check for other corrections/updates from official sources.</p>
</section>
<section id="load-the-original-hysets-polygons">
<h3>Load the original HYSETS polygons<a class="headerlink" href="#load-the-original-hysets-polygons" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hs_path</span> <span class="o">=</span> <span class="s1">&#39;data/catchment_polygons/HYSETS_watershed_boundaries/HYSETS_watershed_boundaries_20200730.shp&#39;</span>
<span class="n">hs_polygons</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">hs_path</span><span class="p">)</span>
<span class="n">hs_polygons</span> <span class="o">=</span> <span class="n">hs_polygons</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bcub_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;data/study_region_stations.geojson&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bcub_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="c1"># the bcub geometries are (centroid) points from the HYSETS properties, </span>
<span class="c1"># set the geometry to the HYSETS polygons instead</span>
<span class="n">catchment_geometries</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hs_polygons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hs_polygons</span><span class="p">[</span><span class="s1">&#39;OfficialID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">],</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catchment_geometries</span>
<span class="n">bcub_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hs_polygons</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EPSG:4326
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ab_df</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;Flag_Artificial_Boundaries&#39;</span><span class="p">]</span><span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ab_df</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bcub_gdf</span><span class="p">)</span><span class="si">}</span><span class="s1"> catchment geometries are flagged &quot;artificial bounds&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>408/1618 catchment geometries are flagged &quot;artificial bounds&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gsim_df</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;Flag_GSIM_boundaries&#39;</span><span class="p">]</span><span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gsim_df</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bcub_gdf</span><span class="p">)</span><span class="si">}</span><span class="s1"> catchment geometries are flagged as using GSIM boundaries&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243/1618 catchment geometries are flagged as using GSIM boundaries
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wsc_ab</span> <span class="o">=</span> <span class="n">ab_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ab_df</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HYDAT&#39;</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">usgs_ab</span> <span class="o">=</span> <span class="n">ab_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ab_df</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;USGS&#39;</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">wsc_ab</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">usgs_ab</span><span class="p">)</span><span class="si">}</span><span class="s1"> WSC/USGS artificial bounds flags &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>269/139 WSC/USGS artificial bounds flags 
</pre></div>
</div>
</div>
</div>
</section>
<section id="check-for-updated-wsc-polygons">
<h3>Check for updated WSC polygons<a class="headerlink" href="#check-for-updated-wsc-polygons" title="Link to this heading">#</a></h3>
<p>The updated WSC catchments can be accessed at the Environment and Climate Change Canada (ECCC) <a class="reference external" href="https://collaboration.cmc.ec.gc.ca/cmc/hydrometrics/www/HydrometricNetworkBasinPolygons/">hydrometrics page</a>.  We only need to download the region files associated with the study region, corresponding to the first two digits of the station identifier (official id).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wsc_stn_df</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HYDAT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">wsc_stns</span> <span class="o">=</span> <span class="n">wsc_stn_df</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span>
<span class="n">prefixes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">e</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">wsc_stns</span><span class="p">])))</span>
<span class="n">prefixes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;05&#39;, &#39;07&#39;, &#39;08&#39;, &#39;09&#39;, &#39;10&#39;]
</pre></div>
</div>
</div>
</div>
<p>Download the above files <code class="docutils literal notranslate"><span class="pre">&lt;2-digit</span> <span class="pre">identifier&gt;.zip</span></code> and extract them in the <code class="docutils literal notranslate"><span class="pre">data</span></code> folder.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find updated catchment polygons</span>
<span class="k">def</span> <span class="nf">retrieve_and_update_WSC_polygon</span><span class="p">(</span><span class="n">stn_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an updated WSC polygon if it exists or returns an empty (geo)dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stn_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span>
    <span class="n">stn_prefix</span> <span class="o">=</span> <span class="n">stn_id</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">catchment_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;data/catchment_polygons/</span><span class="si">{</span><span class="n">stn_prefix</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_DrainageBasin_BassinDeDrainage.shp&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">catchment_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updated polygon found for </span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">updated_polygon</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">catchment_path</span><span class="p">)</span>
        <span class="n">updated_polygon</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updated_polygon</span>
    <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">retrieve_and_update_WSC_station_location</span><span class="p">(</span><span class="n">stn_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an updated WSC station location if it exists or returns an empty (geo)dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stn_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span>
    <span class="n">stn_prefix</span> <span class="o">=</span> <span class="n">stn_id</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;data/catchment_polygons/</span><span class="si">{</span><span class="n">stn_prefix</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_Station.shp&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updated station location found for </span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">updated_pt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">updated_pt</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updated_pt</span>
    <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="check-for-updated-usgs-polygons">
<h3>Check for updated USGS polygons<a class="headerlink" href="#check-for-updated-usgs-polygons" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># api url for nwis sites</span>
<span class="n">usgs_api_url</span> <span class="o">=</span> <span class="s1">&#39;https://labs.waterdata.usgs.gov/api/nldi/linked-data/nwissite/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">retrieve_usgs_stn_data</span><span class="p">(</span><span class="n">stn</span><span class="p">):</span>
    <span class="c1"># query the NWIS with the station number to get the station coordinates    </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">query_url</span> <span class="o">=</span> <span class="n">usgs_api_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;USGS-</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">usgs_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">query_url</span><span class="p">)</span>
        <span class="n">usgs_stn_loc</span> <span class="o">=</span> <span class="n">usgs_data</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span>
        <span class="n">stn_pt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="n">usgs_stn_loc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">stn_pt</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;USGS station query failed for </span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    

<span class="k">def</span> <span class="nf">usgs_basin_polygon_query</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;USGS polygons are in EPSG:4326 crs&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">retrieve_usgs_basin_data</span><span class="p">(</span><span class="n">stn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the USGS basin polygon and station location from the NLDI API. </span>
<span class="sd">    If there is no basin for the station, use the NLDI to retrieve upstream </span>
<span class="sd">    and downstream boundaries.  </span>
<span class="sd">    Pick the one closest in (HYSETS published) area to the station location.&quot;&quot;&quot;</span>    
    
    <span class="c1"># query the basin polygon from USGS</span>
    <span class="n">basin_query</span> <span class="o">=</span> <span class="n">usgs_api_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;USGS-</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">/basin?simplified=false&amp;splitCatchment=false&#39;</span>    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">usgs_basin_df</span> <span class="o">=</span> <span class="n">usgs_basin_polygon_query</span><span class="p">(</span><span class="n">basin_query</span><span class="p">)</span>
        <span class="c1"># dissolve the basin polygons</span>
        <span class="n">usgs_basin_df</span> <span class="o">=</span> <span class="n">usgs_basin_df</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span>
        <span class="n">usgs_basin_df</span> <span class="o">=</span> <span class="n">usgs_basin_df</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">)</span>
        <span class="c1"># check if geometry is multipolygon</span>
        <span class="k">if</span> <span class="n">usgs_basin_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MultiPolygon&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   ...MultiPolygon detected, attemping to make geometry valid.&#39;</span><span class="p">)</span>
            <span class="n">usgs_basin_df</span> <span class="o">=</span> <span class="n">usgs_basin_df</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
            <span class="n">usgs_basin_df</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usgs_basin_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="mf">1E6</span>
            <span class="n">usgs_basin_df</span><span class="p">[</span><span class="s1">&#39;area_pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usgs_basin_df</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">usgs_basin_df</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">usgs_basin_df</span> <span class="o">=</span> <span class="n">usgs_basin_df</span><span class="p">[</span><span class="n">usgs_basin_df</span><span class="p">[</span><span class="s1">&#39;area_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usgs_basin_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;USGS basin polygon query returned multiple polygons.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">usgs_basin_df</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;USGS basin polygon query failed for </span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">.  </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intermediate_step_path</span> <span class="o">=</span> <span class="s1">&#39;data/updated_geometries_intermediate.geojson&#39;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intermediate_step_path</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading existing file&#39;</span><span class="p">)</span>
    <span class="n">bcub_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">intermediate_step_path</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;geometry_updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># set a variable to prevent jupyter book from </span>
    <span class="c1"># processing during book building step</span>
    <span class="n">process_step</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">process_step</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">stn_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;HYDAT&#39;</span><span class="p">:</span>
                <span class="c1"># pt = retrieve_and_update_WSC_station_location(stn_id)</span>
                <span class="n">polygon</span> <span class="o">=</span> <span class="n">retrieve_and_update_WSC_polygon</span><span class="p">(</span><span class="n">stn_id</span><span class="p">)</span>            
            <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;USGS&#39;</span><span class="p">:</span>
                <span class="c1"># pt = retrieve_usgs_stn_data(stn_id)</span>
                <span class="n">polygon</span> <span class="o">=</span> <span class="n">retrieve_usgs_basin_data</span><span class="p">(</span><span class="n">stn_id</span><span class="p">)</span>    
            <span class="k">if</span> <span class="ow">not</span> <span class="n">polygon</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">polygon</span><span class="o">.</span><span class="n">crs</span> <span class="o">==</span> <span class="s1">&#39;EPSG:3005&#39;</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span>
                <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;Centroid_Lat_deg_N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span>
                <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;Centroid_Lon_deg_E&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon</span>
                <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;geometry_updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;Flag_Artificial_Boundaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;Flag_GSIM_boundaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">polygon</span> <span class="o">=</span> <span class="n">hs_polygons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hs_polygons</span><span class="p">[</span><span class="s1">&#39;OfficialID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn_id</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">updated_official</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">updated_official</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">intermediate_step_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loading existing file
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ab_df_remaining</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;Flag_Artificial_Boundaries&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">gsim_remaining</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;Flag_GSIM_boundaries&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ab_df_remaining</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bcub_gdf</span><span class="p">)</span><span class="si">}</span><span class="s1"> catchment geometries remain flagged &quot;artificial bounds&quot; (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ab_df</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">ab_df_remaining</span><span class="p">)</span><span class="si">}</span><span class="s1"> updated.)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gsim_remaining</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bcub_gdf</span><span class="p">)</span><span class="si">}</span><span class="s1"> catchment geometries remain flagged as using GSIM bounds.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>92/1618 catchment geometries remain flagged &quot;artificial bounds&quot; (316 updated.)
4/1618 catchment geometries remain flagged as using GSIM bounds.
</pre></div>
</div>
</div>
</div>
</section>
<section id="delineate-the-remaining-catchments-from-1-arc-second-usgs-3dep-dem">
<h3>Delineate the remaining catchments from 1 arc-second USGS 3DEP DEM.<a class="headerlink" href="#delineate-the-remaining-catchments-from-1-arc-second-usgs-3dep-dem" title="Link to this heading">#</a></h3>
<p>For all of the remaining rows labeled “FLAG_Artificial_Boundaries” or “FLAG_GSIM_boundaries”, follow the methodology in the <a class="reference external" href="https://dankovacek.github.io/bcub_demo/notebooks/2_DEM_Preprocessing.html">BCUB dataset demo</a> and reprocess the catchment bounds.</p>
<p>The code below assumes the underlying DEM has been hydraulically conditioned and flow direction, flow accumulation, and stream rasters have been generated for the area corresponding to each monitoring station catchment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># given the station location, get the corresponding (sub-)region code</span>
<span class="c1"># since rasters are broken up into regions for dem processing and </span>
<span class="c1"># catchment delineation</span>

<span class="k">if</span> <span class="s1">&#39;index_right&#39;</span> <span class="ow">in</span> <span class="n">ab_df_remaining</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">ab_df_remaining</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;index_right&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># ensure that all remaining points have a region code</span>
<span class="n">ab_stns</span> <span class="o">=</span> <span class="n">ab_df_remaining</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">gsim_stns</span> <span class="o">=</span> <span class="n">gsim_remaining</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># make sure no stations are included twice</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ab_stns</span><span class="p">,</span> <span class="n">gsim_stns</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">remaining_stns</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ab_df_remaining</span><span class="p">,</span> <span class="n">gsim_remaining</span><span class="p">]),</span> <span class="n">crs</span><span class="o">=</span><span class="n">ab_df_remaining</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">remaining_stns</span><span class="p">)</span><span class="si">}</span><span class="s1"> stations remain to re-process&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>96 stations remain to re-process
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="process-stations-individually">
<h2>Process stations individually<a class="headerlink" href="#process-stations-individually" title="Link to this heading">#</a></h2>
<p>In order to facilitate an iterative validation process for delineating catchment bounds that are uncertain, the stations will be processed one by one as follows:</p>
<section id="find-the-nearest-pixel-in-the-stream-raster-corresponding-to-the-point-geometry">
<h3>Find the nearest pixel in the stream raster corresponding to the point geometry<a class="headerlink" href="#find-the-nearest-pixel-in-the-stream-raster-corresponding-to-the-point-geometry" title="Link to this heading">#</a></h3>
<p>Note that where the catchment geometry is missing in HYSETS, the centroid point is just the station location, and the geometry is simply a square centred at the station location and with an area equal to the drainage area reported by the official source <span id="id2">[<a class="reference internal" href="markdown.html#id5" title="Richard Arsenault, François Brissette, Jean-Luc Martel, Magali Troin, Guillaume Lévesque, Jonathan Davidson-Chaput, Mariana Castañeda Gonzalez, Ali Ameli, and Annie Poulin. A comprehensive, multisource database for hydrometeorological modeling of 14,425 north american watersheds. Scientific Data, 7(1):243, 2020.">Arsenault <em>et al.</em>, 2020</a>]</span>.  We then find the nearest stream pixel to the “centroid” which is not actually the centroid but the reported station location.</p>
<p>Historical (discontinued) stations are difficult to align automatically with the correct stream location because often their geographic locations (representing pour points) were not recorded precisely.  Catchment delineation requires an x,y input that aligns precisely with the stream network raster, meaning greater pour point precision is required as resolution increases.  There are less than 100 catchments in the study region remaining with a <code class="docutils literal notranslate"><span class="pre">Artificial_Bounds_Flag</span></code>, and this is a reasonable number to validate “manually”, which is done here.</p>
<p>The process of validating these final catchments is as follows:</p>
<ul class="simple">
<li></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">rioxarray</span> <span class="k">as</span> <span class="nn">rxr</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">box</span>

<span class="kn">from</span> <span class="nn">attribute_processing_functions</span> <span class="kn">import</span> <span class="n">clip_raster_to_basin</span>

<span class="kn">import</span> <span class="nn">whitebox</span> 
<span class="n">wbt</span> <span class="o">=</span> <span class="n">whitebox</span><span class="o">.</span><span class="n">WhiteboxTools</span><span class="p">()</span>
<span class="n">wbt</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">retrieve_raster</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take in a file name and return the raster data, </span>
<span class="sd">    the coordinate reference system, and the affine transform.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raster</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mask_and_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>
    <span class="n">affine</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">raster</span><span class="p">,</span> <span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">(),</span> <span class="n">affine</span>


<span class="k">def</span> <span class="nf">affine_map_vec</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">affine</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span>
    <span class="n">new_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">new_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">new_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
        <span class="n">new_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">e</span> <span class="o">+</span> <span class="n">f</span>
    <span class="k">return</span> <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span>


<span class="k">def</span> <span class="nf">snap_pour_point</span><span class="p">(</span><span class="n">raster_filepath</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">distance_tol</span><span class="o">=</span><span class="mi">250</span><span class="p">):</span>
    <span class="n">raster</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">affine</span> <span class="o">=</span> <span class="n">retrieve_raster</span><span class="p">(</span><span class="n">raster_filepath</span><span class="p">)</span>     
    <span class="n">acc</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">resolution</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">resolution</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># Determine area fraction</span>
    <span class="n">area_frac</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="mi">5</span>
    <span class="n">expected_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">area</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">))</span>
    
    <span class="c1"># Calculate min and max cells</span>
    <span class="n">min_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">area_frac</span><span class="p">)</span> <span class="o">*</span> <span class="n">expected_cells</span><span class="p">)</span>
    <span class="n">max_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">area_frac</span> <span class="o">*</span> <span class="n">expected_cells</span><span class="p">)</span>
        
    <span class="c1"># Get potential stream cells within the expected range</span>
    <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">acc</span> <span class="o">&gt;=</span> <span class="n">min_cells</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">acc</span> <span class="o">&lt;=</span> <span class="n">max_cells</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No points returned meeting accumulation criteria.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    
    <span class="c1"># Convert to coordinates</span>
    <span class="n">affine_tup</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span> <span class="o">=</span> <span class="n">affine_map_vec</span><span class="p">(</span><span class="n">affine_tup</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span>

    <span class="c1"># Calculate distances and find the nearest stream cell</span>
    <span class="n">stn_coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x_coords</span> <span class="o">-</span> <span class="n">stn_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_coords</span> <span class="o">-</span> <span class="n">stn_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">distance_tol</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No points found within distance tolerance.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    
    <span class="n">min_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">x_snap</span><span class="p">,</span> <span class="n">y_snap</span> <span class="o">=</span> <span class="n">x_coords</span><span class="p">[</span><span class="n">min_idx</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">[</span><span class="n">min_idx</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dy</span>
    
    <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="n">x_snap</span><span class="p">,</span> <span class="n">y_snap</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dem_folder</span> <span class="o">=</span> <span class="s1">&#39;/home/danbot2/code_5820/large_sample_hydrology/bcub/processed_data/processed_dem/&#39;</span>
<span class="c1"># dem_folder = &#39;/home/danbot/Documents/code/23/bcub/processed_data/processed_dem/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">delineate_new_catchment</span><span class="p">(</span><span class="n">pour_pt_path</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">,</span> <span class="n">stn_folder</span><span class="p">):</span>
    <span class="n">d8_pntr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dem_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">_USGS_3DEP_3005_fdir.tif&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d8_pntr</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_basin.tif&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>        
        <span class="n">wbt</span><span class="o">.</span><span class="n">watershed</span><span class="p">(</span>
            <span class="n">d8_pntr</span><span class="p">,</span> 
            <span class="n">pour_pt_path</span><span class="p">,</span> 
            <span class="n">output</span><span class="p">,</span> 
            <span class="n">esri_pntr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_stream_vectors</span><span class="p">(</span><span class="n">stn_data</span><span class="p">,</span> <span class="n">adjusted_catchment_path</span><span class="p">,</span> <span class="n">stn_folder</span><span class="p">):</span>
    <span class="n">catchment</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">adjusted_catchment_path</span><span class="p">)</span>
    <span class="c1"># add a buffer to the clip to get a wider picture of streams</span>
    <span class="n">catchment</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">catchment</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">stn_id</span> <span class="o">=</span> <span class="n">stn_data</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">stn_data</span><span class="p">[</span><span class="s1">&#39;region_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># open and clip the stream raster</span>
    <span class="n">acc_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">_USGS_3DEP_3005_accum.tif&#39;</span>
    <span class="n">acc_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dem_folder</span><span class="p">,</span> <span class="n">acc_file</span><span class="p">)</span>
    <span class="n">acc_raster</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">retrieve_raster</span><span class="p">(</span><span class="n">acc_fpath</span><span class="p">)</span>
    <span class="n">nodata_value</span> <span class="o">=</span> <span class="n">acc_raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>
    
    <span class="n">raster_res</span> <span class="o">=</span> <span class="n">acc_raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">resolution</span><span class="p">()</span>
    <span class="n">cell_area</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">raster_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">raster_res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">assert</span> <span class="n">acc_raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span> <span class="o">==</span> <span class="n">catchment</span><span class="o">.</span><span class="n">crs</span>

    <span class="n">geoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">stn_data</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">catchment</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">combined_geom</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">geoms</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">stn_data</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="c1"># cvx_hull = combined_geom.dissolve().convex_hull</span>
    <span class="c1"># Get the bounding box of the combined geometries</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">combined_geom</span><span class="o">.</span><span class="n">total_bounds</span>  <span class="c1"># returns (minx, miny, maxx, maxy)</span>

    <span class="c1"># Create a Polygon from the bounding box and buffer it by 500 meters</span>
    <span class="n">bbox_polygon</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">bbox_buffered</span> <span class="o">=</span> <span class="n">bbox_polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    
    <span class="c1"># Create a GeoDataFrame for the buffered bounding box</span>
    <span class="n">bbox_mask</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">bbox_buffered</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">stn_data</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    
    <span class="c1"># clip the raster with the catchment polygon    </span>
    <span class="n">clip_ok</span><span class="p">,</span> <span class="n">clipped_acc_raster</span> <span class="o">=</span> <span class="n">clip_raster_to_basin</span><span class="p">(</span><span class="n">bbox_mask</span><span class="p">,</span> <span class="n">acc_raster</span><span class="p">)</span>   
    
    <span class="c1"># Save the clipped raster to a file</span>
    <span class="n">acc_clip_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_clipped_acc.tif&#39;</span><span class="p">)</span>
    <span class="n">clipped_acc_raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">acc_clip_fpath</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">acc_raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">clip_ok</span><span class="p">:</span>
        <span class="c1"># drop the raster to save memory</span>
        <span class="k">del</span> <span class="n">acc_raster</span>
    <span class="c1"># set the minimum area to 1 km^2 for filtering </span>
    <span class="c1"># the accumulation for stream pixels </span>
    <span class="n">min_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e6</span> <span class="o">/</span> <span class="n">cell_area</span><span class="p">)</span> 
    
    <span class="c1"># render the streams raster from the clip</span>
    <span class="n">streams_temp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_streams.tif&#39;</span><span class="p">)</span>
    <span class="n">wbt</span><span class="o">.</span><span class="n">extract_streams</span><span class="p">(</span>
        <span class="n">acc_clip_fpath</span><span class="p">,</span> 
        <span class="n">streams_temp</span><span class="p">,</span> 
        <span class="n">min_cells</span><span class="p">,</span> 
        <span class="n">zero_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
    <span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">streams_temp</span><span class="p">)</span>
    
    <span class="n">stream_vector_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_stream_vectors.shp&#39;</span><span class="p">)</span>
    
    <span class="n">wbt</span><span class="o">.</span><span class="n">raster_to_vector_lines</span><span class="p">(</span>
        <span class="n">streams_temp</span><span class="p">,</span> 
        <span class="n">stream_vector_output</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stream_vector_output</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">stream_vector_output</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">raster_to_vector_basin</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">catchment_raster_fpath</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">,</span> <span class="n">stn_folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If we send too many pour points per batch to the Whitebox &quot;unnest&quot; function, </span>
<span class="sd">    we generate a huge number of temporary raster files that could easily </span>
<span class="sd">    exceed current SSD disk capacities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raster</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">affine</span> <span class="o">=</span> <span class="n">retrieve_raster</span><span class="p">(</span><span class="n">catchment_raster_fpath</span><span class="p">)</span>
    <span class="n">polygon_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">_temp_polygon.shp&#39;</span><span class="p">)</span>

    <span class="c1"># this function creates rasters of ordered </span>
    <span class="c1"># sets of non-overlapping basins</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">polygon_path</span><span class="p">):</span>
        <span class="n">wbt</span><span class="o">.</span><span class="n">raster_to_vector_polygons</span><span class="p">(</span>
            <span class="n">catchment_raster_fpath</span><span class="p">,</span>
            <span class="n">polygon_path</span><span class="p">,</span>
        <span class="p">)</span>
    
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">polygon_path</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="n">index_parts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">gdf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
    <span class="c1"># drop the raster from memory</span>
    <span class="k">del</span> <span class="n">raster</span>
    <span class="k">return</span> <span class="n">gdf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">remaining_stns</span> <span class="o">=</span> <span class="n">remaining_stns</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;region_code&#39;</span><span class="p">])</span>
<span class="n">remaining_stns</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pour_pt_filenames</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">remaining_stns</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    
    <span class="n">stn_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;region_code&#39;</span><span class="p">]</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Drainage_Area_km2&#39;</span><span class="p">]</span>
    
    <span class="n">stn_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">updated_catchment_folder</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">)</span>
    <span class="c1"># accumulation raster path</span>
    <span class="n">acc_dem_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dem_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">_USGS_3DEP_3005_accum.tif&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">acc_dem_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;missing &#39;</span><span class="p">,</span> <span class="n">acc_dem_path</span><span class="p">)</span>
        <span class="k">continue</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">acc_dem_path</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">acc_dem_path</span><span class="si">}</span><span class="s1"> not found&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;processing </span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1"> region (</span><span class="si">{</span><span class="n">area</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> km²)&#39;</span><span class="p">)</span>
    <span class="n">stn_data</span> <span class="o">=</span> <span class="n">remaining_stns</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># 1) save the original HYSETS catchment geometry </span>
    <span class="n">hs_polygon_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_HYSETS_polygon.geojson&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hs_polygon_path</span><span class="p">):</span>
        <span class="n">stn_data</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">hs_polygon_path</span><span class="p">)</span>

    <span class="c1"># 2) save the original HYSETS station location</span>
    <span class="n">hs_pt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_HYSETS_pt.geojson&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hs_pt_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...processing HYSETS pour point&#39;</span><span class="p">)</span>
        <span class="n">hs_pt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">stn_data</span><span class="p">[</span><span class="s1">&#39;Centroid_Lon_deg_E&#39;</span><span class="p">],</span> <span class="n">stn_data</span><span class="p">[</span><span class="s1">&#39;Centroid_Lat_deg_N&#39;</span><span class="p">])</span>
        <span class="n">hs_pt_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">hs_pt</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;4326&#39;</span><span class="p">)</span>
        <span class="n">hs_pt_df</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">hs_pt_df</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">hs_pt_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hs_pt_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">hs_pt_path</span><span class="p">)</span>

    <span class="c1"># 3) find the nearest stream cell to the reported station location</span>
    <span class="n">adjusted_ppt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_adjusted_ppt.geojson&#39;</span><span class="p">)</span>
    <span class="n">adjusted_ppt_path_shp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_adjusted_ppt.shp&#39;</span><span class="p">)</span>    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adjusted_ppt_path</span><span class="p">)</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adjusted_ppt_path_shp</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...processing adjusted pour point&#39;</span><span class="p">)</span>
        <span class="n">nearest_pt</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">snap_pour_point</span><span class="p">(</span><span class="n">acc_dem_path</span><span class="p">,</span> <span class="n">hs_pt_df</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">distance_tol</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nearest_pt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">: no point returned within expected drainage area range.&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">adj_pt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">nearest_pt</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">remaining_stns</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">adj_pt</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stn_id</span>
        <span class="n">adj_pt</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">adjusted_ppt_path</span><span class="p">)</span>
        <span class="n">adj_pt</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">adjusted_ppt_path_shp</span><span class="p">)</span>
        
        
    <span class="c1"># 4) delineate a new catchment from the adjusted point</span>
    <span class="n">adjusted_catchment_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_adjusted_catchment.geojson&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adjusted_catchment_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...delineating basin raster&#39;</span><span class="p">)</span>
        <span class="n">catchment_raster_fpath</span> <span class="o">=</span> <span class="n">delineate_new_catchment</span><span class="p">(</span><span class="n">adjusted_ppt_path_shp</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">,</span> <span class="n">stn_folder</span><span class="p">)</span>
        <span class="n">adjusted_catchment</span> <span class="o">=</span> <span class="n">raster_to_vector_basin</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">catchment_raster_fpath</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">,</span> <span class="n">stn_folder</span><span class="p">)</span>
        <span class="n">adjusted_catchment</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">adjusted_catchment_path</span><span class="p">)</span>
        
    <span class="c1"># 5) save streamlines as a vector within some distance of the catchment polygon / ppt.</span>
    <span class="n">streams_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_streams.geojson&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">streams_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...processing streams vectors&#39;</span><span class="p">)</span>
        <span class="n">streams_temp_path</span> <span class="o">=</span> <span class="n">generate_stream_vectors</span><span class="p">(</span><span class="n">stn_data</span><span class="p">,</span> <span class="n">adjusted_catchment_path</span><span class="p">,</span> <span class="n">stn_folder</span><span class="p">)</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">streams_temp_path</span><span class="p">)</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">streams_path</span><span class="p">)</span>
        
        <span class="n">remove_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.dbf&#39;</span><span class="p">,</span> <span class="s1">&#39;.prj&#39;</span><span class="p">,</span> <span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;.shx&#39;</span><span class="p">,</span> <span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.cpg&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adjusted_catchment_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">remove_extensions</span><span class="p">]):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   ...processed </span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">, saved to </span><span class="si">{</span><span class="n">streams_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>processing 15195000 in 08A region (20.59 km²)
processing 15129600 in 08A region (6.47 km²)
processing 15129510 in 08A region (12.38 km²)
processing 15041200 in 08B region (17093.84 km²)
processing 15054600 in 08B region (2.46 km²)
processing 15054990 in 08B region (39.37 km²)
processing 15056030 in 08B region (3.96 km²)
processing 15056070 in 08B region (24.16 km²)
processing 15056095 in 08B region (7.56 km²)
processing 15056280 in 08B region (11.89 km²)
processing 15057580 in 08B region (26.16 km²)
processing 15100000 in 08B region (45.32 km²)
processing 15099900 in 08B region (27.97 km²)
processing 15094000 in 08B region (19.19 km²)
processing 15093200 in 08B region (6.89 km²)
processing 15054000 in 08B region (10.26 km²)
processing 15087700 in 08B region (31.08 km²)
processing 15087690 in 08B region (26.16 km²)
processing 15087618 in 08B region (11.11 km²)
processing 15087590 in 08B region (7.04 km²)
processing 15087565 in 08B region (39.89 km²)
processing 15087545 in 08B region (5.70 km²)
processing 15087500 in 08B region (1.17 km²)
processing 15087300 in 08B region (45.07 km²)
processing 15087200 in 08B region (3.78 km²)
processing 15093400 in 08B region (9.63 km²)
processing 15053800 in 08B region (6.47 km²)
processing 15053200 in 08B region (3.37 km²)
processing 15106920 in 08B region (26.42 km²)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>processing 15109000 in 08B region (35.22 km²)
processing 15108800 in 08B region (7.72 km²)
processing 15108600 in 08B region (6.79 km²)
processing 15107920 in 08B region (33.41 km²)
processing 15107910 in 08B region (7.82 km²)
processing 15106980 in 08B region (37.55 km²)
processing 15106960 in 08B region (20.72 km²)
processing 15106940 in 08B region (11.60 km²)
processing 15052800 in 08B region (36.52 km²)
processing 15102200 in 08B region (6.53 km²)
processing 15109048 in 08B region (11.21 km²)
processing 15101490 in 08B region (22.33 km²)
processing 15031000 in 08B region (21.47 km²)
processing 15039900 in 08B region (28.49 km²)
processing 15040000 in 08B region (39.37 km²)
processing 15048000 in 08B region (11.84 km²)
processing 15049900 in 08B region (21.78 km²)
processing 15050000 in 08B region (25.28 km²)
processing 15052000 in 08B region (31.86 km²)
processing 15052475 in 08B region (6.73 km²)
processing 15052495 in 08B region (40.92 km²)
processing 15101200 in 08B region (5.91 km²)
processing 15024750 in 08C region (44.81 km²)
processing 15086500 in 08D region (44.03 km²)
processing 15085900 in 08D region (4.25 km²)
processing 15086960 in 08D region (3.03 km²)
processing 15086600 in 08D region (29.01 km²)
processing 15085800 in 08D region (39.11 km²)
processing 15081610 in 08D region (17.17 km²)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>processing 15085400 in 08D region (7.98 km²)
processing 15011870 in 08D region (6.99 km²)
processing 15012000 in 08D region (40.14 km²)
processing 15085600 in 08D region (22.84 km²)
processing 15058000 in 08D region (17.28 km²)
processing 15058700 in 08D region (5.23 km²)
processing 15059500 in 08D region (13.70 km²)
processing 15060000 in 08D region (7.28 km²)
processing 15067900 in 08D region (5.26 km²)
processing 15068000 in 08D region (14.76 km²)
processing 15081495 in 08D region (7.95 km²)
processing 15020100 in 08D region (41.70 km²)
processing 15081580 in 08D region (4.71 km²)
processing 15081614 in 08D region (12.25 km²)
processing 15081800 in 08D region (45.07 km²)
processing 15081995 in 08D region (13.47 km²)
processing 15083500 in 08D region (8.75 km²)
processing 15085000 in 08D region (14.32 km²)
processing 15085100 in 08D region (15.28 km²)
processing 15085300 in 08D region (22.87 km²)
processing 15081510 in 08D region (7.04 km²)
processing 08EG013 in 08E region (33.20 km²)
processing 05CJ011 in ERK region (1.99 km²)
processing 05DC008 in ERK region (3.73 km²)
processing 07AD006 in ERK region (18.10 km²)
processing 05AE040 in ERK region (37.80 km²)
processing 08JC005 in FRA region (3390.00 km²)
processing 10CC001 in LRD region (43500.00 km²)
processing 07FD913 in PCR region (31.60 km²)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>processing 07FD912 in PCR region (9.43 km²)
    ...processing adjusted pour point
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="n">line</span> <span class="mi">45</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adjusted_ppt_path</span><span class="p">)</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adjusted_ppt_path_shp</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...processing adjusted pour point&#39;</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">45</span>     <span class="n">nearest_pt</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">snap_pour_point</span><span class="p">(</span><span class="n">acc_dem_path</span><span class="p">,</span> <span class="n">hs_pt_df</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">distance_tol</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">46</span>     <span class="k">if</span> <span class="n">nearest_pt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">47</span>         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">: no point returned within expected drainage area range.&#39;</span><span class="p">)</span>

<span class="nn">Cell In[19], line 46,</span> in <span class="ni">snap_pour_point</span><span class="nt">(raster_filepath, pt, area, distance_tol)</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span> <span class="c1"># Convert to coordinates</span>
<span class="g g-Whitespace">     </span><span class="mi">45</span> <span class="n">affine_tup</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="ne">---&gt; </span><span class="mi">46</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span> <span class="o">=</span> <span class="n">affine_map_vec</span><span class="p">(</span><span class="n">affine_tup</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span> <span class="c1"># Calculate distances and find the nearest stream cell</span>
<span class="g g-Whitespace">     </span><span class="mi">49</span> <span class="n">stn_coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nn">Cell In[19], line 19,</span> in <span class="ni">affine_map_vec</span><span class="nt">(affine, x, y)</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span>     <span class="n">new_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
<span class="ne">---&gt; </span><span class="mi">19</span>     <span class="n">new_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">e</span> <span class="o">+</span> <span class="n">f</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span> <span class="k">return</span> <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="create-plots-to-visualize-the-results-of-adjusting-pour-points-to-the-derived-stream-network">
<h2>Create plots to visualize the results of adjusting pour points to the derived stream network<a class="headerlink" href="#create-plots-to-visualize-the-results-of-adjusting-pour-points-to-the-derived-stream-network" title="Link to this heading">#</a></h2>
<section id="create-validation-plots-set">
<h3>Create validation plots set<a class="headerlink" href="#create-validation-plots-set" title="Link to this heading">#</a></h3>
<p>Create and save interactive html plots to compare HYSETS “artificial bounds” with catchment boundaries delineated by snapping pour points to nearest flow accumulation cell within 5% of expected area (for basins <span class="math notranslate nohighlight">\(&gt; 10 \text{km}^2\)</span> and 2.5% otherwise.  Also set a maximum search distance tolerance of 250m.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">save</span>
<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">output_notebook</span>
<span class="kn">import</span> <span class="nn">xyzservices.providers</span> <span class="k">as</span> <span class="nn">xyz</span>
<span class="c1"># output_notebook()</span>

<span class="n">usgs_tiles</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;USGS&#39;</span><span class="p">][</span><span class="s1">&#39;USTopo&#39;</span><span class="p">]</span>

<span class="c1"># dir(tiles)</span>
<span class="n">tiles</span> <span class="o">=</span> <span class="n">usgs_tiles</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">format_pt_for_plotting</span><span class="p">(</span><span class="n">pt_df</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pt_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3857</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">format_poly_for_plotting</span><span class="p">(</span><span class="n">poly_df</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">poly_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="n">index_parts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="mf">1e6</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3857</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>


<span class="k">def</span> <span class="nf">format_linestring_for_plotting</span><span class="p">(</span><span class="n">line_df</span><span class="p">):</span>
    <span class="c1"># Prepare data for Bokeh</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">line_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3857</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">geom</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s1">&#39;MultiLineString&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">geom</span><span class="p">:</span>
                <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">geom</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s1">&#39;LineString&#39;</span><span class="p">:</span>
            <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span>


<span class="k">def</span> <span class="nf">create_new_pt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">):</span>
    <span class="n">pt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">pt</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">pt_crs</span><span class="p">)</span>

    
<span class="k">def</span> <span class="nf">pour_point_plot</span><span class="p">(</span><span class="n">stn_id</span><span class="p">,</span> <span class="n">hs_pt</span><span class="p">,</span> <span class="n">hs_poly</span><span class="p">,</span> <span class="n">adj_pt</span><span class="p">,</span> <span class="n">adj_poly</span><span class="p">,</span> <span class="n">streams</span><span class="p">,</span> <span class="n">add_pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pt_crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="n">adjusted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Note if you add a point, it should be in decimal degrees (EPSG:4326) unless otherwise specified with pt_crs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">name</span> <span class="o">=</span> <span class="n">hysets_df</span><span class="p">[</span><span class="n">hysets_df</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn_id</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
        
    <span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s2">&quot;mercator&quot;</span><span class="p">,</span> <span class="n">y_axis_type</span><span class="o">=</span><span class="s2">&quot;mercator&quot;</span><span class="p">)</span>
    
    <span class="n">ppt_x</span><span class="p">,</span> <span class="n">ppt_y</span> <span class="o">=</span> <span class="n">format_pt_for_plotting</span><span class="p">(</span><span class="n">adj_pt</span><span class="p">)</span>
    <span class="n">stn_x</span><span class="p">,</span> <span class="n">stn_y</span> <span class="o">=</span> <span class="n">format_pt_for_plotting</span><span class="p">(</span><span class="n">hs_pt</span><span class="p">)</span>
    <span class="n">new_poly_x</span><span class="p">,</span> <span class="n">new_poly_y</span> <span class="o">=</span> <span class="n">format_poly_for_plotting</span><span class="p">(</span><span class="n">adj_poly</span><span class="p">)</span>
    <span class="n">hs_poly_x</span><span class="p">,</span> <span class="n">hs_poly_y</span> <span class="o">=</span> <span class="n">format_poly_for_plotting</span><span class="p">(</span><span class="n">hs_poly</span><span class="p">)</span>
    
    <span class="n">stream_x</span><span class="p">,</span> <span class="n">stream_y</span> <span class="o">=</span> <span class="n">format_linestring_for_plotting</span><span class="p">(</span><span class="n">streams</span><span class="p">)</span>
    
    <span class="n">hs_da</span> <span class="o">=</span> <span class="n">hs_poly</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
    <span class="n">new_area</span> <span class="o">=</span> <span class="n">adj_poly</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
    
    <span class="c1"># Add the transparent polygon to the plot</span>
    <span class="n">p</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">hs_poly_x</span><span class="p">,</span> <span class="n">hs_poly_y</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
           <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;HYSETS (</span><span class="si">{</span><span class="n">hs_da</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> km²)&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">new_poly_x</span><span class="p">,</span> <span class="n">new_poly_y</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span>
           <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;BCUB (</span><span class="si">{</span><span class="n">new_area</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> km²)&#39;</span><span class="p">)</span>
    
    <span class="n">p</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">stn_x</span><span class="p">],</span> <span class="p">[</span><span class="n">stn_y</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
              <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;HYSETS stn&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">ppt_x</span><span class="p">],</span> <span class="p">[</span><span class="n">ppt_y</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
              <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;BCUB ppt&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">add_pt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">add_pt</span><span class="p">)</span>
        <span class="n">add_x</span><span class="p">,</span> <span class="n">add_y</span> <span class="o">=</span> <span class="n">add_pt</span>
        <span class="n">add_pt_df</span> <span class="o">=</span> <span class="n">create_pt</span><span class="p">(</span><span class="n">add_x</span><span class="p">,</span> <span class="n">add_y</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">)</span>
        <span class="n">pt_x</span><span class="p">,</span> <span class="n">pt_y</span> <span class="o">=</span> <span class="n">format_pt_for_plotting</span><span class="p">(</span><span class="n">add_pt_df</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">pt_x</span><span class="p">],</span> <span class="p">[</span><span class="n">pt_y</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;triangle&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
              <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Added pt&#39;</span><span class="p">)</span>
        
    
    <span class="c1"># Add a MultiLine glyph</span>
    <span class="k">if</span> <span class="n">new_area</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">multi_line</span><span class="p">(</span><span class="n">xs</span><span class="o">=</span><span class="n">stream_x</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="n">stream_y</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blueviolet&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span>
                    <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;3DEP streamline&#39;</span><span class="p">)</span>    

    <span class="n">p</span><span class="o">.</span><span class="n">add_tile</span><span class="p">(</span><span class="n">tiles</span><span class="p">,</span> <span class="n">retina</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">xgrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">p</span><span class="o">.</span><span class="n">ygrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">click_policy</span> <span class="o">=</span> <span class="s1">&#39;hide&#39;</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pour_pt_filenames</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">output_plot_folder</span> <span class="o">=</span> <span class="s1">&#39;data/validation_plots&#39;</span>
<span class="n">stn_plot_data_folder</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;data/catchment_polygons/updated_catchment_set/&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">stn_plot_data_folder</span><span class="p">))</span><span class="si">}</span><span class="s1"> plots&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process_plot</span><span class="p">(</span><span class="n">stn_id</span><span class="p">,</span> <span class="n">adjusted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_plot_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">.html&#39;</span><span class="p">)</span>
    <span class="c1"># print(stn_id)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">adjusted</span><span class="p">:</span>
        <span class="c1"># print(f&#39;    {stn_id} already processed.&#39;)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">stn_id</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phantom station with no name&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
        
    <span class="n">stn_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">updated_catchment_folder</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">)</span>
    <span class="n">hs_pt_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_HYSETS_pt.geojson&#39;</span><span class="p">)</span>
    <span class="n">hs_poly_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_HYSETS_polygon.geojson&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">adjusted</span><span class="p">:</span>
        <span class="n">adj_pt_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_REadjusted_ppt.geojson&#39;</span><span class="p">)</span>
        <span class="n">adj_poly_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_REadjusted_catchment.geojson&#39;</span><span class="p">)</span>
        <span class="n">streams_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_streams_adjusted.geojson&#39;</span><span class="p">)</span>
    
    <span class="c1"># try:</span>
    <span class="n">hs_pt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">hs_pt_file</span><span class="p">)</span>
    <span class="n">hs_poly</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">hs_poly_file</span><span class="p">)</span>
    <span class="n">adj_pt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">adj_pt_file</span><span class="p">)</span>
    <span class="n">adj_poly</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">adj_poly_file</span><span class="p">)</span>
    <span class="n">streams</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">streams_file</span><span class="p">)</span>
    <span class="n">plt</span> <span class="o">=</span> <span class="n">pour_point_plot</span><span class="p">(</span><span class="n">stn_id</span><span class="p">,</span> <span class="n">hs_pt</span><span class="p">,</span> <span class="n">hs_poly</span><span class="p">,</span> <span class="n">adj_pt</span><span class="p">,</span> <span class="n">adj_poly</span><span class="p">,</span> <span class="n">streams</span><span class="p">,</span> <span class="n">adjusted</span><span class="o">=</span><span class="n">adjusted</span><span class="p">)</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_plot_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">.html&#39;</span><span class="p">)</span>
    <span class="c1"># Specify the output file</span>
    <span class="n">output_file</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
    <span class="c1"># Save the plot to the HTML file</span>
    <span class="n">save</span><span class="p">(</span><span class="n">plt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">stn_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">stn_plot_data_folder</span><span class="p">)):</span>
    <span class="n">process_plot</span><span class="p">(</span><span class="n">stn_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="show-an-example-validation-plot">
<h2>Show an example validation plot<a class="headerlink" href="#show-an-example-validation-plot" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">output_notebook</span>
<span class="n">output_notebook</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;data/validation_plots/recheck&#39;</span><span class="p">)]</span>
<span class="n">pt_crs</span> <span class="o">=</span> <span class="s1">&#39;EPSG:4326&#39;</span>
<span class="n">checked_stns</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;15081800&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">132.87492</span><span class="p">,</span> <span class="mf">55.36158</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># catch trib just DS of stn or no?</span>
    <span class="s1">&#39;15039900&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">133.98292</span><span class="p">,</span> <span class="mf">58.24594</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># reposition at lake outlet</span>
    <span class="s1">&#39;10CC001&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">122.53885</span><span class="p">,</span> <span class="mf">58.835</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># reposition below Muskwa Creek</span>
    <span class="s1">&#39;15109048&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">134.67127</span><span class="p">,</span> <span class="mf">58.286815</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># cature more of North Fork (NF)</span>
    <span class="s1">&#39;15056095&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">135.18648</span><span class="p">,</span> <span class="mf">59.52632</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># reposition at lake outlet</span>
    <span class="s1">&#39;15031000&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">133.88392</span><span class="p">,</span> <span class="mf">58.18253</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># reposition to capture three upper tribs</span>
    <span class="s1">&#39;12212430&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">122.49944</span><span class="p">,</span> <span class="mf">48.99979</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># reposition to capture upper tribs</span>
    <span class="s1">&#39;15054000&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">134.64325</span><span class="p">,</span> <span class="mf">58.38685</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># better isolate Auke Creek</span>
    <span class="s1">&#39;15087500&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">132.87254</span><span class="p">,</span> <span class="mf">56.79361</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># isolate east fork of Hobo Creek</span>
    <span class="s1">&#39;12110400&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">122.08512</span><span class="p">,</span> <span class="mf">47.35607</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># reposition on south fork Jenkins (Cranmar Creek)</span>
    <span class="s1">&#39;15056030&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">135.19131</span><span class="p">,</span> <span class="mf">59.009803</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># not great resolving of stream but captures upper basin well</span>
    <span class="s1">&#39;05AE040&#39;</span><span class="p">:</span> <span class="n">create_new_pt</span><span class="p">(</span><span class="o">-</span><span class="mf">113.54587</span><span class="p">,</span> <span class="mf">49.01493</span><span class="p">,</span> <span class="n">pt_crs</span><span class="p">),</span> <span class="c1"># isolate East branch of Lee Creek</span>
    <span class="s1">&#39;15087200&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Hammer Slough at Petersburg doesn&#39;t render from effect of bypass road</span>
    <span class="s1">&#39;07FD913&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Young Drainage Project near Spirit River -- no idea!</span>
    <span class="s1">&#39;07FD912&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Whitburn Drainage Project Near Spirit River -- no idea!</span>
    <span class="s1">&#39;15053200&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Duck Creek doesn&#39;t resolve in 30m DEM due to urban development</span>
    <span class="s1">&#39;12113349&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Mill Creek doesn&#39;t render well with 1 arcsecond DEM in urban area</span>
    <span class="s1">&#39;15052475&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Jordan Creek doesn&#39;t render well with 1 arcsecond DEM in urban area</span>
    <span class="c1"># &#39;08EG013&#39;: create_new_pt(-130.0851, 54.19629, pt_crs), # reposition at lake outlet</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<section id="additional-validation-notes">
<h3>Additional validation notes<a class="headerlink" href="#additional-validation-notes" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>15024750: Goat Creek Near Wrangell AK</strong><br />
-there is a large (5-7km^2) trib just US of the station that in basemaps appears to drain to the north<br />
-there’s a low point where debris jam could cause flow to divert, or maybe past flows diverted</p></li>
<li><p><strong>15129600: Ophir Creek NR Yakutat AK</strong></p>
<ul>
<li><p>the 3DEP dem doesn’t align with USGS basemapping but the area captured is a reasonable approximation</p></li>
</ul>
</li>
<li><p><strong>15129510: Old Situk River Nr Yakutat AK</strong></p>
<ul>
<li><p>significantly larger catchment delineated from very close to the reported location.</p></li>
<li><p>does the north fork exist / should it be included?</p></li>
</ul>
</li>
<li><p><strong>10CC001: Fort Nelson River at Fort Nelson</strong></p>
<ul>
<li><p>the reported location doesn’t include North Branch (HYSETS does) – Muskwa River</p></li>
<li><p>10CC002 is named “above Muskwa River” which coincides with this location,</p></li>
<li><p>the much greater flow magnitude of 10CC001 suggests it was downstream of the Muskwa confluence.</p></li>
</ul>
</li>
<li><p><strong>12212430: Unnamed Trib to Bertrand Cr. Near H St.</strong></p>
<ul>
<li><p>naming isn’t very descriptive, base maps look like monitoring station is road ditch</p></li>
<li><p>pour point shifted away from reported location</p></li>
<li><p>however upstream network matches well with USGS base mapping despite pour point locat</p></li>
</ul>
</li>
<li><p><strong>08EG013: Boneyard Creek at Outlet of Rainbow Lake</strong></p>
<ul>
<li><p>naming is helpful to identify outlet of Rainbow Lake</p></li>
<li><p>very different drainage area compared to WSC reported value</p></li>
<li><p>record is very short (~ 2 seasons 1962-64)</p></li>
<li><p>appears to have a dam at the outlet which may have caused lake connectivity and doubling of catchment area</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pick a station id</span>
<span class="c1"># stn_id = [e for e in to_check if e not in checked_stns][0]</span>
<span class="n">stn_id</span> <span class="o">=</span> <span class="s1">&#39;15024750&#39;</span>
<span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_plot_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">.html&#39;</span><span class="p">)</span>
<span class="n">stn_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">updated_catchment_folder</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">)</span>

<span class="n">hs_pt_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_HYSETS_pt.geojson&#39;</span><span class="p">)</span>
<span class="n">hs_poly_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_HYSETS_polygon.geojson&#39;</span><span class="p">)</span>
<span class="n">adj_pt_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_adjusted_ppt.geojson&#39;</span><span class="p">)</span>
<span class="n">adj_poly_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_adjusted_catchment.geojson&#39;</span><span class="p">)</span>
<span class="n">streams_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_streams.geojson&#39;</span><span class="p">)</span>

<span class="n">hs_pt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">hs_pt_file</span><span class="p">)</span>
<span class="n">hs_poly</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">hs_poly_file</span><span class="p">)</span>
<span class="n">adj_pt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">adj_pt_file</span><span class="p">)</span>
<span class="n">adj_poly</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">adj_poly_file</span><span class="p">)</span>
<span class="n">streams</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">streams_file</span><span class="p">)</span>
<span class="n">plt</span> <span class="o">=</span> <span class="n">pour_point_plot</span><span class="p">(</span><span class="n">stn_id</span><span class="p">,</span> <span class="n">hs_pt</span><span class="p">,</span> <span class="n">hs_poly</span><span class="p">,</span> <span class="n">adj_pt</span><span class="p">,</span> <span class="n">adj_poly</span><span class="p">,</span> <span class="n">streams</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">plt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="re-delineate-basins-with-adjusted-pour-points">
<h2>Re-delineate basins with adjusted pour points<a class="headerlink" href="#re-delineate-basins-with-adjusted-pour-points" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">stn_id</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">checked_stns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">pt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">continue</span>
    
    <span class="n">bcub_data</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="p">[</span><span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">bcub_data</span><span class="p">[</span><span class="s1">&#39;region_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">bcub_data</span><span class="p">[</span><span class="s1">&#39;Drainage_Area_km2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="n">pt</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">stn_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">updated_catchment_folder</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">)</span>
        
    <span class="c1"># accumulation raster path</span>
    <span class="n">acc_dem_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dem_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">_USGS_3DEP_3005_accum.tif&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">acc_dem_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;missing &#39;</span><span class="p">,</span> <span class="n">acc_dem_path</span><span class="p">)</span>
        <span class="k">continue</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">acc_dem_path</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">acc_dem_path</span><span class="si">}</span><span class="s1"> not found&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;processing </span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1"> region (</span><span class="si">{</span><span class="n">area</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> km²)&#39;</span><span class="p">)</span>
    <span class="n">stn_data</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="p">[</span><span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># 3) find the nearest stream cell to the UPDATED station location</span>
    <span class="n">adjusted_ppt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_REadjusted_ppt.geojson&#39;</span><span class="p">)</span>
    <span class="n">adjusted_ppt_path_shp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_REadjusted_ppt.shp&#39;</span><span class="p">)</span>    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adjusted_ppt_path</span><span class="p">)</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adjusted_ppt_path_shp</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...processing adjusted pour point&#39;</span><span class="p">)</span>
        <span class="n">nearest_pt</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">snap_pour_point</span><span class="p">(</span><span class="n">acc_dem_path</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">distance_tol</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">adj_pt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">nearest_pt</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">adj_pt</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stn_id</span>
        <span class="n">adj_pt</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">adjusted_ppt_path</span><span class="p">)</span>
        <span class="n">adj_pt</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">adjusted_ppt_path_shp</span><span class="p">)</span>
        
    <span class="c1"># 4) delineate a new catchment from the adjusted point</span>
    <span class="n">adjusted_catchment_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_REadjusted_catchment.geojson&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adjusted_catchment_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...delineating basin raster&#39;</span><span class="p">)</span>
        <span class="n">catchment_raster_fpath</span> <span class="o">=</span> <span class="n">delineate_new_catchment</span><span class="p">(</span><span class="n">adjusted_ppt_path_shp</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">,</span> <span class="n">stn_folder</span><span class="p">)</span>
        <span class="n">adjusted_catchment</span> <span class="o">=</span> <span class="n">raster_to_vector_basin</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">catchment_raster_fpath</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">,</span> <span class="n">stn_folder</span><span class="p">)</span>
        <span class="n">adjusted_catchment</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">adjusted_catchment_path</span><span class="p">)</span>
        
    <span class="c1"># 5) save streamlines as a vector within some distance of the catchment polygon / ppt.</span>
    <span class="n">streams_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_streams_adjusted.geojson&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">streams_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...processing streams vectors&#39;</span><span class="p">)</span>
        <span class="n">streams_temp_path</span> <span class="o">=</span> <span class="n">generate_stream_vectors</span><span class="p">(</span><span class="n">stn_data</span><span class="p">,</span> <span class="n">adjusted_catchment_path</span><span class="p">,</span> <span class="n">stn_folder</span><span class="p">)</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">streams_temp_path</span><span class="p">)</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">streams_path</span><span class="p">)</span>
        
        <span class="n">remove_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.dbf&#39;</span><span class="p">,</span> <span class="s1">&#39;.prj&#39;</span><span class="p">,</span> <span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;.shx&#39;</span><span class="p">,</span> <span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.cpg&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adjusted_catchment_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">remove_extensions</span><span class="p">]):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   ...processed </span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">, saved to </span><span class="si">{</span><span class="n">streams_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
    
</pre></div>
</div>
</div>
</div>
<section id="revise-the-plots">
<h3>Revise the plots<a class="headerlink" href="#revise-the-plots" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">stn_id</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">checked_stns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">pt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">process_plot</span><span class="p">(</span><span class="n">stn_id</span><span class="p">,</span> <span class="n">adjusted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="final-review-notes-excluded-stations">
<h3>Final review notes (excluded stations)<a class="headerlink" href="#final-review-notes-excluded-stations" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>15087200</strong>: Hammer Slough at Petersburg doesn’t render from effect of bypass road</p></li>
<li><p><strong>07FD913</strong>: Young Drainage Project near Spirit River – no idea!</p></li>
<li><p><strong>07FD912</strong>: Whitburn Drainage Project Near Spirit River – no idea!</p></li>
<li><p><strong>12113349</strong>: Mill Creek doesn’t resolve with 1 arcsecond DEM in urban area</p></li>
<li><p><strong>15052475</strong>: Jordan Creek doesn’t resolve with 1 arcsecond DEM in urban area</p></li>
<li><p><strong>12110400</strong>: Jenkins Creek doesn’t resolve with 1 arcsecond DEM in urban area</p></li>
<li><p><strong>15053200</strong>: Duck Creek doesn’t resolve with 1 arcsecond DEM in urban area</p></li>
<li><p><strong>12212430</strong>: Unnamed Trip to Bertrand Creek Creek doesn’t resolve with 1 arcsecond DEM in urban area</p></li>
<li><p><strong>08EG013</strong>: Boneyard Creek at Outlet of Rainbow Lake is lakes connected by outlet dams raising water level</p></li>
</ol>
</section>
</section>
<section id="assemble-final-catchment-bounds-into-a-dataframe-to-be-used-in-subsequent-computation">
<h2>Assemble final catchment bounds into a dataframe to be used in subsequent computation<a class="headerlink" href="#assemble-final-catchment-bounds-into-a-dataframe-to-be-used-in-subsequent-computation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">revised_geometry_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;BCUB_watershed_bounds_updated.geojson&#39;</span>

<span class="n">excluded_stns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;15087200&#39;</span><span class="p">,</span> <span class="s1">&#39;07FD913&#39;</span><span class="p">,</span> <span class="s1">&#39;07FD912&#39;</span><span class="p">,</span> <span class="s1">&#39;12113349&#39;</span><span class="p">,</span> <span class="s1">&#39;15052475&#39;</span><span class="p">,</span>
                <span class="s1">&#39;12110400&#39;</span><span class="p">,</span> <span class="s1">&#39;15053200&#39;</span><span class="p">,</span> <span class="s1">&#39;12212430&#39;</span><span class="p">,</span> <span class="s1">&#39;08EG013&#39;</span><span class="p">]</span>

<span class="n">revised_geometry_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data/catchment_polygons/updated_catchment_set&#39;</span><span class="p">)</span>
<span class="n">revised_stns</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">remaining_stns</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_stns</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">revised_stns</span><span class="p">)</span><span class="si">}</span><span class="s1"> revised catchment bounds&#39;</span><span class="p">)</span>
<span class="n">bcub_gdf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">stn_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">stn_id</span> <span class="ow">in</span> <span class="n">revised_stns</span><span class="p">:</span>
        <span class="n">stn_geometry_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">revised_geometry_folder</span><span class="p">,</span> <span class="n">stn_id</span><span class="p">)</span>
    
        <span class="c1"># if the station has been revised, there should be new geometry</span>
        <span class="c1"># either it worked the first time, or the pour point was adjusted and</span>
        <span class="c1"># the catchment file is ...REadjusted_catchment.geojson</span>
        <span class="k">if</span> <span class="n">stn_id</span> <span class="ow">in</span> <span class="n">revised_stns</span><span class="p">:</span>
            <span class="n">revised_ppt_catchment_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_geometry_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_REadjusted_catchment.geojson&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">revised_ppt_catchment_fpath</span><span class="p">):</span>
                <span class="n">revised_catchment_fpath</span> <span class="o">=</span> <span class="n">revised_ppt_catchment_fpath</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">revised_catchment_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stn_geometry_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">_adjusted_catchment.geojson&#39;</span><span class="p">)</span>
            
            <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">revised_catchment_fpath</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;revised catchment file not found for </span><span class="si">{</span><span class="n">stn_id</span><span class="si">}</span><span class="s1">&#39;</span>
            
            <span class="n">catchment_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">revised_catchment_fpath</span><span class="p">)</span>
            <span class="c1"># also need to update the centroid geom</span>
            <span class="n">centroid_df</span> <span class="o">=</span> <span class="n">catchment_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># need to compute centroid in projected crs to get coords</span>
            <span class="n">centroid_x</span><span class="p">,</span> <span class="n">centroid_y</span> <span class="o">=</span> <span class="n">centroid_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centroid_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># then create a dataframe to reproject to </span>
            <span class="n">centroid_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">centroid_x</span><span class="p">,</span> <span class="n">centroid_y</span><span class="p">)],</span> <span class="n">crs</span><span class="o">=</span><span class="n">catchment_df</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="c1"># then reproject back to decimal degrees (geographic crs)</span>
            <span class="n">centroid_df</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">4326</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">centroid_x</span><span class="p">,</span> <span class="n">centroid_y</span> <span class="o">=</span> <span class="n">centroid_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centroid_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catchment_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;Centroid_Lat_deg_N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid_y</span>
            <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;Centroid_Lon_deg_E&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid_x</span>
            <span class="n">bcub_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;geometry_updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            

<span class="n">bcub_gdf</span> <span class="o">=</span> <span class="n">bcub_gdf</span><span class="p">[</span><span class="o">~</span><span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">excluded_stns</span><span class="p">)]</span>
<span class="n">bcub_gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">revised_geometry_fname</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;file saved to </span><span class="si">{</span><span class="n">revised_geometry_fname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bcub_gdf</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bcub_gdf</span><span class="p">[</span><span class="n">bcub_gdf</span><span class="p">[</span><span class="s1">&#39;Official_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">revised_stns</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Link to this heading">#</a></h2>
<div class="docutils container" id="id3">
<div role="list" class="citation-list">
<div class="citation" id="id6" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>ABM+20<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id2">2</a>)</span>
<p>Richard Arsenault, François Brissette, Jean-Luc Martel, Magali Troin, Guillaume Lévesque, Jonathan Davidson-Chaput, Mariana Castañeda Gonzalez, Ali Ameli, and Annie Poulin. A comprehensive, multisource database for hydrometeorological modeling of 14,425 north american watersheds. <em>Scientific Data</em>, 7(1):243, 2020.</p>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="1_data.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Data</p>
      </div>
    </a>
    <a class="right-next"
       href="1b_Update_Catchment_Attributes.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Update HYSETS Catchment Attributes</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-data">Import Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-hysets-data">Import HYSETS data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-working-folders-to-organize-temporary-and-final-files">Set up working folders to organize temporary and final files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-bcub-study-region-bounds">Import (BCUB) study region bounds</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-original-hysets-polygons">Load the original HYSETS polygons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-for-updated-wsc-polygons">Check for updated WSC polygons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-for-updated-usgs-polygons">Check for updated USGS polygons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#delineate-the-remaining-catchments-from-1-arc-second-usgs-3dep-dem">Delineate the remaining catchments from 1 arc-second USGS 3DEP DEM.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-stations-individually">Process stations individually</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#find-the-nearest-pixel-in-the-stream-raster-corresponding-to-the-point-geometry">Find the nearest pixel in the stream raster corresponding to the point geometry</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-plots-to-visualize-the-results-of-adjusting-pour-points-to-the-derived-stream-network">Create plots to visualize the results of adjusting pour points to the derived stream network</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-validation-plots-set">Create validation plots set</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#show-an-example-validation-plot">Show an example validation plot</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-validation-notes">Additional validation notes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#re-delineate-basins-with-adjusted-pour-points">Re-delineate basins with adjusted pour points</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#revise-the-plots">Revise the plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#final-review-notes-excluded-stations">Final review notes (excluded stations)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assemble-final-catchment-bounds-into-a-dataframe-to-be-used-in-subsequent-computation">Assemble final catchment bounds into a dataframe to be used in subsequent computation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dan Kovacek
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>